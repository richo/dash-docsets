<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Update the current session id with a newly generated one</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.session-name.html">session_name</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.session-register-shutdown.html">session_register_shutdown</a></div>
 <div class="up"><a href="ref.session.html">Session Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.session-regenerate-id" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">session_regenerate_id</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.3.2, PHP 5)</p><p class="refpurpose"><span class="refname">session_regenerate_id</span> &mdash; <span class="dc-title">
   Update the current session id with a newly generated one
  </span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.session-regenerate-id-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><b>session_regenerate_id</b></span>
    ([ <span class="methodparam"><span class="type">bool</span> <tt class="parameter">$delete_old_session</tt><span class="initializer"> = false</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   <span class="function"><b>session_regenerate_id()</b></span> will replace the current
   session id with a new one, and keep the current session information.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.session-regenerate-id-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">delete_old_session</tt></i></span>
      <dd>

       <p class="para">
        Whether to delete the old associated session file or not.
       </p>
      </dd>

     </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.session-regenerate-id-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <b><tt>TRUE</tt></b> on success or <b><tt>FALSE</tt></b> on failure.
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.session-regenerate-id-changelog">
  <h3 class="title">Changelog</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead valign="middle">
      <tr valign="middle">
       <th>Version</th>
       <th>Description</th>
      </tr>

     </thead>

     <tbody valign="middle" class="tbody">
      <tr valign="middle">
       <td align="left">4.3.3</td>
       <td align="left">
        Since then, if session cookies are enabled, use of
        <span class="function"><b>session_regenerate_id()</b></span> will also submit a new
        session cookie with the new session id.
       </td>
      </tr>

      <tr valign="middle">
       <td align="left">5.1.0</td>
       <td align="left">
        Added the <i><tt class="parameter">delete_old_session</tt></i> parameter.
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.session-regenerate-id-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   <div class="example" id="example-4320">
    <p><b>Example #1 A <span class="function"><b>session_regenerate_id()</b></span> example</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />session_start</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$old_sessionid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">session_id</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">session_regenerate_id</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$new_sessionid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">session_id</span><span style="color: #007700">();<br /><br />echo&nbsp;</span><span style="color: #DD0000">"Old&nbsp;Session:&nbsp;</span><span style="color: #0000BB">$old_sessionid</span><span style="color: #DD0000">&lt;br&nbsp;/&gt;"</span><span style="color: #007700">;<br />echo&nbsp;</span><span style="color: #DD0000">"New&nbsp;Session:&nbsp;</span><span style="color: #0000BB">$new_sessionid</span><span style="color: #DD0000">&lt;br&nbsp;/&gt;"</span><span style="color: #007700">;<br /><br /></span><span style="color: #0000BB">print_r</span><span style="color: #007700">(</span><span style="color: #0000BB">$_SESSION</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.session-regenerate-id-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.session-id.html" class="function" rel="rdfs-seeAlso">session_id()</a> - Get and/or set the current session id</span></li>
    <li class="member"><span class="function"><a href="function.session-start.html" class="function" rel="rdfs-seeAlso">session_start()</a> - Initialize session data</span></li>
    <li class="member"><span class="function"><a href="function.session-name.html" class="function" rel="rdfs-seeAlso">session_name()</a> - Get and/or set the current session name</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="105596""></a>
  <div class="note">
   <strong class="user">gr at gr5 dot org</strong>
   <a href="#105596" class="date">30-Aug-2011 06:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are trying to maintain 2 active sessions don't use session_regenerate_id().&nbsp; Especially if the first session is closed and it's time to open the second.&nbsp; Because the session id is cached you also have to explicitly set it the second time.<br />
<br />
<span class="default">&lt;?php<br />
session_name</span><span class="keyword">(</span><span class="string">'PHPSESSID'</span><span class="keyword">); </span><span class="comment">// redundant - here for clarity<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="comment">// ...do stuff<br />
</span><span class="default">session_write_close</span><span class="keyword">();<br />
<br />
</span><span class="comment">// now switch to session 2...<br />
</span><span class="default">session_name</span><span class="keyword">(</span><span class="string">'PHPSESSID_2'</span><span class="keyword">);<br />
if (isset(</span><span class="default">$_COOKIE</span><span class="keyword">[</span><span class="string">'phpsessid_2'</span><span class="keyword">]))<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$_COOKIE</span><span class="keyword">[</span><span class="string">'phpsessid_2'</span><span class="keyword">]); </span><span class="comment">// not doing this will simply reopen the first session again<br />
</span><span class="keyword">else<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">mt_rand</span><span class="keyword">()); </span><span class="comment">// dont use session_regenerate_id() here.&nbsp; Not creating a new id will create two cookies with same session id and same session variables<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="comment">// ... do stuff with session 2<br />
</span><span class="default">session_write_close</span><span class="keyword">();<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100250""></a>
  <div class="note">
   <strong class="user">Ben Johnson</strong>
   <a href="#100250" class="date">04-Oct-2010 06:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To "start a new session", try the following:<br />
<br />
<span class="default">&lt;?php<br />
session_start</span><span class="keyword">();<br />
</span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
</span><span class="default">session_destroy</span><span class="keyword">();<br />
unset(</span><span class="default">$_SESSION</span><span class="keyword">);<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100124""></a>
  <div class="note">
   <strong class="user">raido dot aasoja at gmail dot com</strong>
   <a href="#100124" class="date">26-Sep-2010 11:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A note on lost sessions and trying to fix it with session_regenerate_id:<br />
Make sure that you're not trying to push SimpleXML object to the session. It just won't go without first converting it to array. :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99794""></a>
  <div class="note">
   <strong class="user">nico at anvilstudios dot co dot za</strong>
   <a href="#99794" class="date">07-Sep-2010 12:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In my code this function resulted in some Internet Explorer 8 browsers loosing their connection with the session. As mentioned above this is probably because the page reloads before the cookie is updated on the client side: <br />
<br />
This is the only manual workaround that never produced this problem for me:<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; $old_session </span><span class="keyword">= </span><span class="default">$_SESSION</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_write_close</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">mt_rand</span><span class="keyword">()));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_start</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION </span><span class="keyword">= </span><span class="default">$old_session</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90902""></a>
  <div class="note">
   <strong class="user">senyahnoj</strong>
   <a href="#90902" class="date">15-May-2009 05:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
We've experienced problems with this function over HTTPS connections with Blackberry browsers.<br />
<br />
Take the following code:<br />
<br />
&lt;?<br />
session_start();<br />
session_regenerate_id();<br />
?&gt;<br />
<br />
This will send out the session cookie twice in the HTTP header and either the Blackberry browser or proxy server (I'm not sure which) doesn't get the most recently set cookie with the changed session id in it.<br />
<br />
Allegedly this problem is fixed in later Blackberrys. More info:<br />
<br />
<a href="http://tinyurl.com/oze3h4" rel="nofollow" target="_blank">http://tinyurl.com/oze3h4</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87905""></a>
  <div class="note">
   <strong class="user">tedivm at tedivm dot com</strong>
   <a href="#87905" class="date">29-Dec-2008 06:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I wrote the following code for a project I'm working on- it attempts to resolve the regenerate issue, as well as deal with a couple of other session related things.<br />
<br />
I tried to make it a little more generic and usable (for instance, in the full version it throws different types of exceptions for the different types of session issues), so hopefully someone might find it useful.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">regenerateSession</span><span class="keyword">(</span><span class="default">$reload </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// This token is used by forms to prevent cross site forgery attempts<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(!isset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'nonce'</span><span class="keyword">]) || </span><span class="default">$reload</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'nonce'</span><span class="keyword">] = </span><span class="default">md5</span><span class="keyword">(</span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp;&nbsp; if(!isset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'IPaddress'</span><span class="keyword">]) || </span><span class="default">$reload</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'IPaddress'</span><span class="keyword">] = </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp;&nbsp; if(!isset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'userAgent'</span><span class="keyword">]) || </span><span class="default">$reload</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'userAgent'</span><span class="keyword">] = </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'HTTP_USER_AGENT'</span><span class="keyword">];<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//$_SESSION['user_id'] = $this-&gt;user-&gt;getId();<br />
<br />
&nbsp;&nbsp;&nbsp; // Set current session to expire in 1 minute<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'OBSOLETE'</span><span class="keyword">] = </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'EXPIRES'</span><span class="keyword">] = </span><span class="default">time</span><span class="keyword">() + </span><span class="default">60</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Create new session without destroying the old one<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">(</span><span class="default">false</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Grab current session ID and close both sessions to allow other scripts to use them<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$newSession </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_write_close</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Set session ID to the new one, and start it back up again<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$newSession</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_start</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Don't want this one to expire<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">unset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'OBSOLETE'</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; unset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'EXPIRES'</span><span class="keyword">]);<br />
}<br />
<br />
function </span><span class="default">checkSession</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp;&nbsp; try{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'OBSOLETE'</span><span class="keyword">] &amp;&amp; (</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'EXPIRES'</span><span class="keyword">] &lt; </span><span class="default">time</span><span class="keyword">()))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Attempt to use expired session.'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">is_numeric</span><span class="keyword">(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'user_id'</span><span class="keyword">]))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'No session started.'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'IPaddress'</span><span class="keyword">] != </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'IP Address mixmatch (possible session hijacking attempt).'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'userAgent'</span><span class="keyword">] != </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'HTTP_USER_AGENT'</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Useragent mixmatch (possible session hijacking attempt).'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">loadUser</span><span class="keyword">(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'user_id'</span><span class="keyword">]))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Attempted to log in user that does not exist with ID: ' </span><span class="keyword">. </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'user_id'</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'OBSOLETE'</span><span class="keyword">] &amp;&amp; </span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">) == </span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">regenerateSession</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; }catch(</span><span class="default">Exception $e</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85433""></a>
  <div class="note">
   <strong class="user">soapergem at gmail dot com</strong>
   <a href="#85433" class="date">29-Aug-2008 03:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This can be a very dangerous function if you're not careful about how you handle things, because even though it generates a whole new set of session data, it keeps the old data "open" until the script terminates, locking out any other scripts trying to run concurrently with the old session id.<br />
<br />
Recently I came across a situation where I wanted to explicitly pass in a session ID, copy the data from that session into a *new* session, and then continue operating under that new session, thereby allowing other scripts to use the old one concurrently. But I quickly found that these "other scripts" would not execute until the first script finished--even though it had already started a new session--because it kept the old session open.<br />
<br />
So if you're trying to copy over session data to a new session to free up the old session for continued, concurrent use, here's some code to ensure nobody's feet get stepped on:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">//&nbsp; get session id of an existing session<br />
</span><span class="default">$sid </span><span class="keyword">= </span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'sid'</span><span class="keyword">];<br />
<br />
</span><span class="comment">//&nbsp; start the old session to retrieve $_SESSION data<br />
</span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$sid</span><span class="keyword">);<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment">//&nbsp; start a new session; this copies the $_SESSION data over<br />
</span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
<br />
</span><span class="comment">//&nbsp; hang on to the new session id<br />
</span><span class="default">$sid </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
<br />
</span><span class="comment">//&nbsp; close the old and new sessions<br />
</span><span class="default">session_write_close</span><span class="keyword">();<br />
<br />
</span><span class="comment">//&nbsp; re-open the new session<br />
</span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$sid</span><span class="keyword">);<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment">/* main code here */<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
This could probably be encapsulated into a function with one parameter as well to save space if it was a repeated thing.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84242""></a>
  <div class="note">
   <strong class="user">Kyle</strong>
   <a href="#84242" class="date">04-Jul-2008 01:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The problem of sessions being lost with small page reloads mentioned by "spam1 at dyden dot de" definitely exists (semi-solution below). It's easy to recreate by just creating a small script and hammering refresh. It may seem like you have to get up to ridiculous speeds to make it happen, but that's not so in the real world with a large framework, xmlhttprequests, dynamic images etc all going off. I've recreated it on a multitude of servers, OSs and versions of PHP and I'm glad to finally find someone else who has the same problem!<br />
<br />
The cause seems to simply be the user's browser not saving the updated cookie fast enough between pages. There isn't much that PHP itself can do to solve it (except maybe to keep X number of session files per user, rather than immediately deleting the old one).<br />
<br />
The simplest solution is to set delete_old_session to false, so when the second, third, etc requests go off with the old sessionid then the file is still available on the server. If you must use it with true then only do it during important operations like login, logout, etc. Problems will still exist but it'll be sporadic enough to prevent your user's from hammering support.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83855""></a>
  <div class="note">
   <strong class="user">spam1 at dyden dot de</strong>
   <a href="#83855" class="date">15-Jun-2008 07:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The problem I posted about below (sessions lost because of small reload intervals) also happens with dynamically generated images (using the session of course).<br />
<br />
I didn't think that it was such a big problem before, but now I had this problem again if I simply had three dynamically generated stats graphs on one page. The images are of course downloaded near-simultaneously, which in turn leads to one of them having a different session id than the other -&gt; killing the session.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83842""></a>
  <div class="note">
   <strong class="user">primenetworkzx at gmail dot com</strong>
   <a href="#83842" class="date">14-Jun-2008 11:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are storing your session data in a database you have to manually update the session_id in the database. The session_set_save_handler() will not do it for you.<br />
<br />
function UpdateSessID() {<br />
&nbsp;&nbsp;&nbsp; $old_sess_id = session_id();<br />
&nbsp;&nbsp;&nbsp; session_regenerate_id(false);<br />
&nbsp;&nbsp;&nbsp; $new_sess_id = session_id();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; $query = "UPDATE `session_table` SET `session_id` = '$new_sess_id' WHERE session_id = '$old_sess_id'";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; mysql_query($query);<br />
}<br />
<br />
Be sure to set session_regenerate_id() to FALSE since it's not really necessary to delete the whole record from MySQL and add it again. That's unnecessary overhead. Only changing the id matters.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81412""></a>
  <div class="note">
   <strong class="user">mitchell dot beaumont at mitchellbeaumont dot com</strong>
   <a href="#81412" class="date">26-Feb-2008 05:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using session_set_save_handler the $delete_old_session parameter does not seem to work on php 4.3.9. It is important to delete the old data for security, this is possible to do without reloading. Where $session-&gt;destroy is my $destroy callback used in session_set_save_handler:<br />
<br />
session_start();<br />
$session_id = session_id();<br />
session_regenerate_id(TRUE);<br />
$session-&gt;destroy( $session_id );</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81212""></a>
  <div class="note">
   <strong class="user">spam1 at dyden dot de</strong>
   <a href="#81212" class="date">18-Feb-2008 02:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When loading pages with a session call simultaneously oder immediately following each other (or reloading the same page extremely quickly) and using session_regenerate_id(), the second request will still have the old session id, so it'll lose all data.<br />
In my case, the user will be logged out, if the data is not what I expect it to be.<br />
I had this problem for a long time until I figured out that session_regenerate_id() was the culprit.<br />
I doubt that there is an easy fix, maybe calling session_commit() early can make the possible reload interval even smaller, but if the change isn't big, I'll simply leave session_regenerate_id() out, because the data I handle is not extremely secure, but there might be reloads in really short intervals (Ajax app.).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77686""></a>
  <div class="note">
   <strong class="user">dbks at dbks dot com dot ar</strong>
   <a href="#77686" class="date">08-Sep-2007 09:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I wish to force.open.eyes=1 to all of you (like me 5 minutes ago) Didnt noticed the title, (i can see that some of you guys didnt too)<br />
<br />
session_regenerate_id();<br />
<br />
ok read it again, <br />
<br />
session_regenerate_id (------);<br />
<br />
param (TRUE) / (FALSE {default})<br />
<br />
ok, now you have a clue lol :p<br />
for all of you guys (fast readers) that are trying to set the old id to a variable and then regenerate, and then save the new id on a new var, and then set the actual session to the old id, Destroy it, and then set the session to the new id... blabla<br />
<br />
session_regenerate_id (TRUE); <br />
<br />
will do the job easier !!<br />
<br />
-param Bool for deleting old session-<br />
<br />
works perfect, enjoy lol</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74782""></a>
  <div class="note">
   
   <a href="#74782" class="date">27-Apr-2007 02:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In php help manual it mention like session_regerate_id() works for version (PHP 4 &gt;= 4.3.2). But it is not working in 4.2.2 itself. So I did google search I found abou the user defined function session_regerate_id in this site. I used it. O.k it is working good. <br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thank you,</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68969""></a>
  <div class="note">
   <strong class="user">buraks78 at gmail dot com</strong>
   <a href="#68969" class="date">17-Aug-2006 11:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are using cookies to store session ids and your php version <br />
is 4.3.2, session_regenerate_id() will not issue a cookie with the<br />
new id resulting in authentication failures.<br />
<br />
Here is my fix<br />
<br />
session_regenerate_id();<br />
if(!version_compare(phpversion(),"4.3.3","&gt;=")){<br />
&nbsp;&nbsp; setcookie(<br />
&nbsp;&nbsp; &nbsp;&nbsp; session_name(),<br />
&nbsp;&nbsp; &nbsp;&nbsp; session_id(),<br />
&nbsp;&nbsp; &nbsp;&nbsp; ini_get("session.cookie_lifetime"),<br />
&nbsp;&nbsp; &nbsp;&nbsp; "/"<br />
&nbsp;&nbsp; );<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61070""></a>
  <div class="note">
   <strong class="user">Gant at BleachEatingFreaks dot com</strong>
   <a href="#61070" class="date">24-Jan-2006 12:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I am calling session_regenerate_id() from inside a method in an object.&nbsp; Since session fixation can occur at permission changes, I have my object call session fixation at these particular security changes.<br />
<br />
Unfortunately, it seems to fabricate some kind of temporary new session, and then the very next page that loads, it jumps back to the old session id.&nbsp; There seems to be no way to make the regeneration perminent.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60478""></a>
  <div class="note">
   <strong class="user">frank</strong>
   <a href="#60478" class="date">08-Jan-2006 05:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
session_regenerate_id(); not present and still want to change<br />
session id's - below a function which will do the same<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">sessie_regenerate_id</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$randlen </span><span class="keyword">= </span><span class="default">32</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$randval </span><span class="keyword">= </span><span class="string">"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$random </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt;= </span><span class="default">$randlen</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$random </span><span class="keyword">.= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$randval</span><span class="keyword">, </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$randval</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">)), </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// use md5 value for id or remove capitals from string $randval<br />
&nbsp;&nbsp;&nbsp; // $random = md5($random);<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$random</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
if (!</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">"session_regenerate_id"</span><span class="keyword">)) { <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sessie_regenerate_id</span><span class="keyword">();<br />
} else { <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">(); <br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56912""></a>
  <div class="note">
   <strong class="user">sopel</strong>
   <a href="#56912" class="date">19-Sep-2005 05:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
for php 5.1&gt; user probably worth visiting is <a href="http://ilia.ws/archives/47-session_regenerate_id-Improvement.html" rel="nofollow" target="_blank">http://ilia.ws/archives/47-session_regenerate_id-Improvement.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56151""></a>
  <div class="note">
   <strong class="user">dyer85 at gmail dot com</strong>
   <a href="#56151" class="date">24-Aug-2005 10:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There could be a potential problem with elger at NOSPAM dot yellowbee dot nl's a few posts below. In the code, was used the REQUEST_URI server variable, which, in some cases might already contain the query string. Therefore, always apending '?whatever=foo' would occasionally cause the script to malfunction. I suggest using PHP_SELF, which will not contain the query string after the file.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54872""></a>
  <div class="note">
   
   <a href="#54872" class="date">18-Jul-2005 08:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It would be more reliable to use the following regular expression when checking session_ids, as HEX strings (MD5) are only of characters a-f and 0-9;<br />
<br />
preg_match('/[0-f]/i', $session_id);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53480""></a>
  <div class="note">
   <strong class="user">Nicolas dot Chachereau at Infomaniak dot ch</strong>
   <a href="#53480" class="date">02-Jun-2005 11:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Session_destroy() does not only destroy the data associated with the current session_id (i.e. the file if you use the default session save handler), but also the session itself: if you call session_destroy() and then session_regenerate_id(), it will return false, and session_id() won't return anything. In order to manipulate a session after destroying it, you need to restart it.<br />
<br />
So in fact, the code mentionned by chris won't work. If you want to destroy the file associated with the old session_id, try the following:<br />
<span class="default">&lt;?php<br />
session_start</span><span class="keyword">();<br />
</span><span class="default">$old_sessid </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
</span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
</span><span class="default">$new_sessid </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
</span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$old_sessid</span><span class="keyword">);<br />
</span><span class="default">session_destroy</span><span class="keyword">();<br />
<br />
</span><span class="comment">//If you don't copy the $_SESSION array, you won't be able to use the data associated with the old session id.<br />
</span><span class="default">$old_session </span><span class="keyword">= </span><span class="default">$_SESSION</span><span class="keyword">;<br />
</span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$new_sessid</span><span class="keyword">);<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">$_SESSION </span><span class="keyword">= </span><span class="default">$old_session</span><span class="keyword">;<br />
</span><span class="comment">//...<br />
</span><span class="default">?&gt;<br />
</span><br />
Note: this technique will send 3 Set-Cookie headers (one on each session_start() and one on session_regenerate_id()). I don't think this is a problem, but if it appears to be one, you could either leave it alone and wait for the garbage collector to catch the file associated with the old session, or try to delete the file with unlink().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49105""></a>
  <div class="note">
   <strong class="user">chris at knowledge dot tee-vee</strong>
   <a href="#49105" class="date">16-Jan-2005 05:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
licp - no, session_regenerate_id() does not destroy any saved session data.<br />
<br />
elger, I prefer the following order<br />
<br />
[code]<br />
// populate $_SESSION with any previously saved session data for the current session_id<br />
session_start();&nbsp; <br />
...<br />
// delete any saved data associated with current session_id, $_SESSION is not changed<br />
session_destroy(); <br />
<br />
// change session_id, $_SESSION not altered<br />
session_regenerate_id(); <br />
...<br />
// save any $_SESSION data under the current session_id<br />
session_close(); <br />
[/code]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="48789""></a>
  <div class="note">
   <strong class="user">licp at hotmail dot com</strong>
   <a href="#48789" class="date">06-Jan-2005 08:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
By inspecting the source code, I am not sure that after session_regenerate_id() run, the original session data does not destroy (still keeps at the system) that sniffers still hijack by applying original session identifier.<br />
<br />
In addition, I find that if user-level session storage handler is used. session_regenerate_id() does not work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="48353""></a>
  <div class="note">
   <strong class="user">php at cny dot de</strong>
   <a href="#48353" class="date">20-Dec-2004 09:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Also note that REMOTE_ADDR may change on every request if the user comes through a proxy farm. Most AOL-users do.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47417""></a>
  <div class="note">
   <strong class="user">ross at kndr dot org</strong>
   <a href="#47417" class="date">15-Nov-2004 03:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In a previous note, php at 5mm de describes how to prevent session hijacking by<br />
ensuring that the session id provided matches the HTTP_USER_AGENT and REMOTE_ADDR fields that were present when the session id was first issued.&nbsp; It should be noted that HTTP_USER_AGENT is supplied by the client, and so can be easily modified by a malicious user.&nbsp; Also, the client IP addresses can be spoofed, although that's a bit more difficult.&nbsp; Care should be taken when relying on the session for authentication.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46937""></a>
  <div class="note">
   <strong class="user">elger at NOSPAM dot yellowbee dot nl</strong>
   <a href="#46937" class="date">28-Oct-2004 02:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Take good notice of the new cookie being sent on calling session_regenerate_id on cookie-enabled sessions. <br />
Make sure your page is reloaded otherwise you'll get an "session_destroy(): Session object destruction failed" error. So here are the examples:<br />
<br />
Wrong:<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; session_start</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_destroy</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
Correct-like:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (!</span><span class="default">$_GET</span><span class="keyword">[</span><span class="string">'mode'</span><span class="keyword">]){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_start</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">header</span><span class="keyword">(</span><span class="string">'location: '</span><span class="keyword">.</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REQUEST_URI'</span><span class="keyword">].</span><span class="string">'?mode=destroy'</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_start</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_destroy</span><span class="keyword">();<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
I noted this because googleing on the previous mentioned error leads to all kinds of bug reports, but not to the solution. (which is, of course, to read the manual)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45124""></a>
  <div class="note">
   <strong class="user">timo at frenay dot net</strong>
   <a href="#45124" class="date">26-Aug-2004 11:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This function is vital in preventing session fixation attacks, but is unfortunately missing in PHP versions prior to 4.3.2. This creates a serious security problem if you can't update your PHP version, like me. Therefore I attempted to port this function to PHP itself:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (!</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'session_regenerate_id'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">php_combined_lcg</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tv </span><span class="keyword">= </span><span class="default">gettimeofday</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] = </span><span class="default">$tv</span><span class="keyword">[</span><span class="string">'sec'</span><span class="keyword">] ^ (~</span><span class="default">$tv</span><span class="keyword">[</span><span class="string">'usec'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">] = </span><span class="default">posix_getpid</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$q </span><span class="keyword">= (int) (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] / </span><span class="default">53668</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] = (int) (</span><span class="default">40014 </span><span class="keyword">* (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] - </span><span class="default">53668 </span><span class="keyword">* </span><span class="default">$q</span><span class="keyword">) - </span><span class="default">12211 </span><span class="keyword">* </span><span class="default">$q</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] &lt; </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] += </span><span class="default">2147483563</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$q </span><span class="keyword">= (int) (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">] / </span><span class="default">52774</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">] = (int) (</span><span class="default">40692 </span><span class="keyword">* (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">] - </span><span class="default">52774 </span><span class="keyword">* </span><span class="default">$q</span><span class="keyword">) - </span><span class="default">3791 </span><span class="keyword">* </span><span class="default">$q</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">] &lt; </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">] += </span><span class="default">2147483399</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$z </span><span class="keyword">= (int) (</span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s1'</span><span class="keyword">] - </span><span class="default">$lcg</span><span class="keyword">[</span><span class="string">'s2'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$z </span><span class="keyword">&lt; </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$z </span><span class="keyword">+= </span><span class="default">2147483562</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$z </span><span class="keyword">* </span><span class="default">4.656613e-10</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">session_regenerate_id</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tv </span><span class="keyword">= </span><span class="default">gettimeofday</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buf </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"%.15s%ld%ld%0.8f"</span><span class="keyword">, </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">], </span><span class="default">$tv</span><span class="keyword">[</span><span class="string">'sec'</span><span class="keyword">], </span><span class="default">$tv</span><span class="keyword">[</span><span class="string">'usec'</span><span class="keyword">], </span><span class="default">php_combined_lcg</span><span class="keyword">() * </span><span class="default">10</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">md5</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">'session.use_cookies'</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">setcookie</span><span class="keyword">(</span><span class="string">'PHPSESSID'</span><span class="keyword">, </span><span class="default">session_id</span><span class="keyword">(), </span><span class="default">NULL</span><span class="keyword">, </span><span class="string">'/'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">TRUE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
To test this:<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; session_start</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sid </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Old session ID: "</span><span class="keyword">, </span><span class="default">$sid</span><span class="keyword">, </span><span class="string">"\nNew session ID: "</span><span class="keyword">, </span><span class="default">session_id</span><span class="keyword">(), </span><span class="string">"\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
- will output something similar to:<br />
Old session ID: 6e3521f44be4fc452b368e703f044ca1<br />
New session ID: 1c6dac9a3e794f164d4115872b902471</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40130""></a>
  <div class="note">
   <strong class="user">babel at  nosqamplease sympatico ca</strong>
   <a href="#40130" class="date">22-Feb-2004 08:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To add to php at 5mm de's comments:<br />
<br />
If the session is held over https, it's even better to save the client's cert or ssl session id instead of the hostname or ip, as it's proxy-transparent and more secure.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="35562""></a>
  <div class="note">
   <strong class="user">php at 5mm de</strong>
   <a href="#35562" class="date">05-Sep-2003 06:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This feature seems to create a new session ID without clearing the old session data. This is a very important feature for security validation:<br />
<br />
$usedns = TRUE; // for eliminating failture by proxys using IP chains, but slower<br />
<br />
$useragent = getenv("HTTP_USER_AGENT");<br />
$host = getenv("REMOTE_ADDR");<br />
$dns = $global['dns'] ? @gethostbyaddr($host):$host;<br />
<br />
session_start();<br />
<br />
if(session_is_registered('securitycheck')) {<br />
&nbsp;&nbsp;&nbsp; if(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (($_SESSION['session']['host'] != $this-&gt;host) &amp;&amp; !$usedns)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; || ($_SESSION['session']['dns'] != $this-&gt;dns)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; || ($_SESSION['session']['useragent'] != $this-&gt;useragent)<br />
&nbsp;&nbsp;&nbsp; ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; session_regenerate_id();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; session_unset();<br />
&nbsp;&nbsp;&nbsp; }<br />
} else {<br />
&nbsp;&nbsp;&nbsp; $currentdata = array();<br />
&nbsp;&nbsp;&nbsp; $currentdata['host'] = $this-&gt;host;<br />
&nbsp;&nbsp;&nbsp; $currentdata['dns'] = $this-&gt;dns;<br />
&nbsp;&nbsp;&nbsp; $currentdata['useragent'] = $this-&gt;useragent;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; session_register('securitycheck', $currentdata);<br />
}<br />
<br />
If sombody steals an active SID (e.g. by referrer or injection attack), he cant be validated because of either the host / dns or useragent and will get a new (empty) SID, without interrupting the original session.<br />
<br />
Please mail me for any comments: php at 5mm de</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="35332""></a>
  <div class="note">
   <strong class="user">madsen at sjovedyr.dk</strong>
   <a href="#35332" class="date">27-Aug-2003 07:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had problems with a proxy changing a visitors session_id-cookie, so he'd get a LOT of errors when visiting my site.<br />
I handled the bogus session-id's like this. (Note: It only works in versions &gt; 4.3.2.)<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Start a session and suppress error-messages.<br />
</span><span class="keyword">@</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment">// Catch bogus session-id's.<br />
</span><span class="keyword">if (!</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/^[0-9a-z]*$/i"</span><span class="keyword">, </span><span class="default">session_id</span><span class="keyword">())) {<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Output a warning about the messed up session-id.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$error</span><span class="keyword">-&gt;</span><span class="default">handleError</span><span class="keyword">(</span><span class="string">"WARN"</span><span class="keyword">, </span><span class="string">"Your session id is messed up, you might not be able to use some features on this site."</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Generate a fresh session-id.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="comment">// Site contents.<br />
</span><span class="default">?&gt;<br />
</span><br />
Hope someone can use it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.session-name.html">session_name</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.session-register-shutdown.html">session_register_shutdown</a></div>
 <div class="up"><a href="ref.session.html">Session Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
