<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Sets user-level session storage functions</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.session-set-cookie-params.html">session_set_cookie_params</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.session-start.html">session_start</a></div>
 <div class="up"><a href="ref.session.html">Session Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.session-set-save-handler" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">session_set_save_handler</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">session_set_save_handler</span> &mdash; <span class="dc-title">Sets user-level session storage functions</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.session-set-save-handler-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><b>session_set_save_handler</b></span>
    ( <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <tt class="parameter">$open</tt></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <tt class="parameter">$close</tt></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <tt class="parameter">$read</tt></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <tt class="parameter">$write</tt></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <tt class="parameter">$destroy</tt></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.callback" class="type callback">callback</a></span> <tt class="parameter">$gc</tt></span>
   )</div>

  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><b>session_set_save_handler</b></span>
    ( <span class="methodparam"><span class="type"><a href="class.sessionhandler.html" class="type SessionHandler">SessionHandler</a></span> <tt class="parameter">$sessionhandler</tt></span>
   [, <span class="methodparam"><span class="type">bool</span> <tt class="parameter">$register_shutdown</tt><span class="initializer"> = true</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   <span class="function"><b>session_set_save_handler()</b></span> sets the user-level
   session storage functions which are used for storing and
   retrieving data associated with a session.  This is most useful
   when a storage method other than those supplied by PHP sessions
   is preferred.  i.e. Storing the session data in a local database.
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.session-set-save-handler-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   This function has two prototypes.
   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">sessionhandler</tt></i></span>
     <dd>

      <p class="para">
       An instance of <a href="class.sessionhandler.html" class="classname">SessionHandler</a> to register as the
       session handler
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">register_shutdown</tt></i></span>
     <dd>

      <p class="para">
       Register <span class="function"><a href="function.session-register-shutdown.html" class="function">session_register_shutdown()</a></span> as a
       <span class="function"><a href="function.register-shutdown-function.html" class="function">register_shutdown_function()</a></span> function.
      </p>
     </dd>

    </dt>

   </dl>


   or

   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">open</tt></i></span>
     <dd>

      <p class="para">
       Open function, this works like a constructor in classes and is 
       executed when the session is being opened. The open function 
       expects two parameters, where the first is the save path and 
       the second is the session name.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">close</tt></i></span>
     <dd>

      <p class="para">
       Close function, this works like a destructor in classes and is 
       executed when the session operation is done.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">read</tt></i></span>
     <dd>

      <p class="para">
       Read function must return string value always to make save handler
       work as expected. Return empty string if there is no data to read.
       Return values from other handlers are converted to boolean expression.
       <b><tt>TRUE</tt></b> for success, <b><tt>FALSE</tt></b> for failure.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">write</tt></i></span>
     <dd>

      <p class="para">
       Write function that is called when session data is to be saved. This
       function expects two parameters: an identifier and the data associated
       with it.
       <blockquote class="note"><p><b class="note">Note</b>: 
        <p class="para">
         The &quot;write&quot; handler is not executed until after the output stream is
         closed.  Thus, output from debugging statements in the &quot;write&quot;
         handler will never be seen in the browser.  If debugging output is
         necessary, it is suggested that the debug output be written to a
         file instead.
        </p>
       </p></blockquote>
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">destroy</tt></i></span>
     <dd>

      <p class="para">
       The destroy handler, this is executed when a session is destroyed with 
       <span class="function"><a href="function.session-destroy.html" class="function">session_destroy()</a></span> and takes the session id as its 
       only parameter.
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">gc</tt></i></span>
     <dd>

      <p class="para">
       The garbage collector, this is executed when the session garbage collector 
       is executed and takes the max session lifetime as its only parameter.
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.session-set-save-handler-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <b><tt>TRUE</tt></b> on success or <b><tt>FALSE</tt></b> on failure.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.session-set-save-handler-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   <div class="example" id="example-4321">
    <p><b>Example #1 <span class="function"><b>session_set_save_handler()</b></span> example</b></p>
    <div class="example-contents"><p>
     The following example provides file based session storage similar to the
     PHP sessions default save handler <i><tt class="parameter">files</tt></i>.  This
     example could easily be extended to cover database storage using your
     favorite PHP supported database engine.
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">open</span><span style="color: #007700">(</span><span style="color: #0000BB">$save_path</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$session_name</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;</span><span style="color: #0000BB">$sess_save_path&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$save_path</span><span style="color: #007700">;<br />&nbsp;&nbsp;return(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">close</span><span style="color: #007700">()<br />{<br />&nbsp;&nbsp;return(</span><span style="color: #0000BB">true</span><span style="color: #007700">);<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">read</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;</span><span style="color: #0000BB">$sess_file&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br />&nbsp;&nbsp;return&nbsp;(string)&nbsp;@</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$sess_file</span><span style="color: #007700">);<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">write</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sess_data</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;</span><span style="color: #0000BB">$sess_file&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br />&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">$fp&nbsp;</span><span style="color: #007700">=&nbsp;@</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #0000BB">$sess_file</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$return&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$sess_data</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">$return</span><span style="color: #007700">;<br />&nbsp;&nbsp;}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;return(</span><span style="color: #0000BB">false</span><span style="color: #007700">);<br />&nbsp;&nbsp;}<br /><br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">destroy</span><span style="color: #007700">(</span><span style="color: #0000BB">$id</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;</span><span style="color: #0000BB">$sess_file&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #DD0000">/sess_</span><span style="color: #0000BB">$id</span><span style="color: #DD0000">"</span><span style="color: #007700">;<br />&nbsp;&nbsp;return(@</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$sess_file</span><span style="color: #007700">));<br />}<br /><br />function&nbsp;</span><span style="color: #0000BB">gc</span><span style="color: #007700">(</span><span style="color: #0000BB">$maxlifetime</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;global&nbsp;</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #007700">;<br /><br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">glob</span><span style="color: #007700">(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$sess_save_path</span><span style="color: #DD0000">/sess_*"</span><span style="color: #007700">)&nbsp;as&nbsp;</span><span style="color: #0000BB">$filename</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">filemtime</span><span style="color: #007700">(</span><span style="color: #0000BB">$filename</span><span style="color: #007700">)&nbsp;+&nbsp;</span><span style="color: #0000BB">$maxlifetime&nbsp;</span><span style="color: #007700">&lt;&nbsp;</span><span style="color: #0000BB">time</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@</span><span style="color: #0000BB">unlink</span><span style="color: #007700">(</span><span style="color: #0000BB">$filename</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;return&nbsp;</span><span style="color: #0000BB">true</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">session_set_save_handler</span><span style="color: #007700">(</span><span style="color: #DD0000">"open"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"close"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"read"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"write"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"destroy"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"gc"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">session_start</span><span style="color: #007700">();<br /><br /></span><span style="color: #FF8000">//&nbsp;proceed&nbsp;to&nbsp;use&nbsp;sessions&nbsp;normally<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.session-set-save-handler-notes">
  <h3 class="title">Notes</h3>
  <div class="warning"><b class="warning">Warning</b>
   <p class="para">
    As of PHP 5.0.5 the <i><tt class="parameter">write</tt></i> and
    <i><tt class="parameter">close</tt></i> handlers are called after object
    destruction and therefore cannot use objects or throw exceptions.
    The object destructors can however use sessions.
   </p>
   <p class="para">
    It is possible to call <span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span> from the
    destructor to solve this chicken and egg problem.
   </p>
  </div>
  <div class="warning"><b class="warning">Warning</b>
   <p class="para">
    Current working directory is changed with some SAPIs if session is
    closed in the script termination. It is possible to close the session
    earlier with <span class="function"><a href="function.session-write-close.html" class="function">session_write_close()</a></span>.
   </p>
  </div>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.session-set-save-handler-changelog">
  <h3 class="title">Changelog</h3>
  <table class="doctable informaltable">
   
    <thead valign="middle">
     <tr valign="middle">
      <th>Version</th>
      <th>Description</th>
     </tr>

    </thead>

    <tbody valign="middle" class="tbody">
     <tr valign="middle">
      <td align="left">5.4.0</td>
      <td align="left">
       Added the possibility of using <a href="class.sessionhandler.html" class="classname">SessionHandler</a> as
       a session handler.
      </td>
     </tr>

    </tbody>
   
  </table>

 </div>


 <div class="refsect1 seealso" id="refsect1-function.session-set-save-handler-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member">
     The <a href="session.configuration.html#ini.session.save-handler" class="link">session.save_handler</a>
     configuration directive
    </li>
   </ul>
  </p>
 </div>

 
</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="106489""></a>
  <div class="note">
   <strong class="user">balazsbotond at gmail dot com</strong>
   <a href="#106489" class="date">13-Nov-2011 04:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It is important to note that autoload handlers don't work inside the read, write, etc. functions, so you have to explicitly require_once all classes you use there.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104847""></a>
  <div class="note">
   <strong class="user">pavelc at users dot sourceforge dot net</strong>
   <a href="#104847" class="date">11-Jul-2011 04:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I write a class that unites whole handler functionality. It's not even needed to save instances of this class in variables. Just add a row:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">new </span><span class="default">SessionSaveHandler</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span>and the handler will rule the sessions ;-)<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">SessionSaveHandler </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$savePath</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$sessionName</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">session_set_save_handler</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"open"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"close"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"read"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"write"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"destroy"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"gc"</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; );<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">open</span><span class="keyword">(</span><span class="default">$savePath</span><span class="keyword">, </span><span class="default">$sessionName</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">savePath </span><span class="keyword">= </span><span class="default">$savePath</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sessionName </span><span class="keyword">= </span><span class="default">$sessionName</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">close</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// your code if any<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">read</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// your code<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">write</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// your code<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">destroy</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// your code<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">gc</span><span class="keyword">(</span><span class="default">$maxlifetime</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// your code<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
}<br />
<br />
new </span><span class="default">SessionSaveHandler</span><span class="keyword">();<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104104""></a>
  <div class="note">
   <strong class="user">lukas.starecek</strong>
   <a href="#104104" class="date">23-May-2011 05:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have solved problem with session handler, which needs some other objects (for example DB access object), with register_shutdown_function. Just calling<br />
<br />
<span class="default">&lt;?php<br />
<br />
register_shutdown_function</span><span class="keyword">(</span><span class="string">'session_write_close'</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
solved my problem. Shutdown functions are called before object destructors.<br />
<br />
If you use class for session handling (my prefered way), you can call register_shutdown_function in constructor and you must not mess your code in another place.<br />
<br />
Example:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">SessionHandler </span><span class="keyword">{<br />
<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$_db</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">PDO $db</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_db </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'session_write_close'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">open</span><span class="keyword">(</span><span class="default">$save_path</span><span class="keyword">, </span><span class="default">$session_name</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">close</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">read</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">write</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">, </span><span class="default">$sess_data</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">destroy</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">gc</span><span class="keyword">(</span><span class="default">$maxlifetime</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103055""></a>
  <div class="note">
   <strong class="user">frank at interactinet dot com</strong>
   <a href="#103055" class="date">22-Mar-2011 01:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had trouble with committing session data.<br />
To "commit and continue" without closing your session, put this at the top of your "write" method:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$id </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
</span><span class="default">session_write_close</span><span class="keyword">();<br />
</span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">);<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Note that ANY time php generates a new session id, it is not automatically updated in a database. This can be helpful:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">public function </span><span class="default">resetSessionId</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$old </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_regenerate_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$new </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">SessionHandler</span><span class="keyword">::</span><span class="default">regenerate_id</span><span class="keyword">(</span><span class="default">$old</span><span class="keyword">,</span><span class="default">$new</span><span class="keyword">);<br />
}<br />
<br />
public function </span><span class="default">regenerate_id</span><span class="keyword">(</span><span class="default">$old</span><span class="keyword">,</span><span class="default">$new</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$db </span><span class="keyword">= </span><span class="default">mysqli</span><span class="keyword">-&gt;</span><span class="default">connect</span><span class="keyword">(...);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">query</span><span class="keyword">(</span><span class="string">'UPDATE sessions SET session_id = \''</span><span class="keyword">.</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">escape_string</span><span class="keyword">(</span><span class="default">$new</span><span class="keyword">).</span><span class="string">'\' <br />
&nbsp;&nbsp;&nbsp; WHERE session_id = \''</span><span class="keyword">.</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">escape_string</span><span class="keyword">(</span><span class="default">$old</span><span class="keyword">).</span><span class="string">'\''</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98071""></a>
  <div class="note">
   <strong class="user">dummynick at gmail dot com</strong>
   <a href="#98071" class="date">24-May-2010 08:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was getting Fatal error: Exception thrown without a stack frame and it took days to figure out the reason. I am using memcache to store sessions and in my custom class I use Memcache class in write method.<br />
<br />
I put the code in the write method inside try-catch block and it solved my problem.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96305""></a>
  <div class="note">
   <strong class="user">newton at tricko dot com dot br</strong>
   <a href="#96305" class="date">19-Feb-2010 08:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have been done with session problems creating a new and my own session system.<br />
<br />
This is very simple, bellow the class file, a good pratice is include these file as your first line:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">class </span><span class="default">SessionDB </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$data</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$session_id</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$minutes_to_expire</span><span class="keyword">=</span><span class="default">3600</span><span class="keyword">; </span><span class="comment">// TIME TO MAINTAIN DATA ON DB<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; global </span><span class="default">$SESSION</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; if (isset(</span><span class="default">$_COOKIE</span><span class="keyword">[</span><span class="string">'session_id'</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session_id </span><span class="keyword">= </span><span class="default">$_COOKIE</span><span class="keyword">[</span><span class="string">'session_id'</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session_id </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">microtime</span><span class="keyword">().</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">,</span><span class="default">9999999999999999999999999</span><span class="keyword">)); </span><span class="comment">// GENERATE A RANDOM ID<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">setcookie</span><span class="keyword">(</span><span class="string">'session_id'</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session_id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"INSERT INTO `tb_session_db` (`session_id`, `updated_on`) VALUES ('</span><span class="keyword">{</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session_id</span><span class="keyword">}</span><span class="string">', NOW())"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"SELECT `value` FROM `tb_session_db` WHERE `session_id`='</span><span class="keyword">{</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session_id</span><span class="keyword">}</span><span class="string">'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$query </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(</span><span class="default">mysql_result</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="string">'value'</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$SESSION </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; private function </span><span class="default">expire</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$date_to_delete </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">"Y-m-d H:i:s"</span><span class="keyword">, </span><span class="default">time</span><span class="keyword">()-</span><span class="default">60</span><span class="keyword">*</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">minutes_to_expire</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"DELETE FROM `tb_session_db` WHERE `update_on` &lt;= '</span><span class="default">$date_to_delete</span><span class="string">'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__destruct</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp;&nbsp; global </span><span class="default">$SESSION</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data </span><span class="keyword">= </span><span class="default">serialize</span><span class="keyword">(</span><span class="default">$SESSION</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="string">"UPDATE `tb_session_db` SET `value`='</span><span class="keyword">{</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">}</span><span class="string">', `updated_on`=NOW() WHERE `session_id`='</span><span class="keyword">{</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session_id</span><span class="keyword">}</span><span class="string">'"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">expire</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
&nbsp; <br />
</span><span class="comment">/*<br />
TABLE STRUCTURE<br />
&nbsp; CREATE TABLE IF NOT EXISTS `tb_session_db` (<br />
&nbsp;&nbsp;&nbsp; `session_id` varchar(32) NOT NULL,<br />
&nbsp;&nbsp;&nbsp; `value` blob,<br />
&nbsp;&nbsp;&nbsp; `updated_on` datetime DEFAULT NULL,<br />
&nbsp;&nbsp;&nbsp; PRIMARY KEY (`session_id`)<br />
&nbsp; ) ENGINE=MyISAM DEFAULT CHARSET=latin1;<br />
*/<br />
</span><span class="default">?&gt;<br />
</span><br />
With this file included, connected to MySQL database who has the table `tb_session_db` I can easy do that into my config file:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">require_once(</span><span class="string">'session_db.php'</span><span class="keyword">);<br />
&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">define</span><span class="keyword">(</span><span class="string">'MYSQL_HOST'</span><span class="keyword">,</span><span class="string">'mysql.example.com'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">define</span><span class="keyword">(</span><span class="string">'MYSQL_USER'</span><span class="keyword">,</span><span class="string">'.......'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">define</span><span class="keyword">(</span><span class="string">'MYSQL_PASS'</span><span class="keyword">,</span><span class="string">'.......'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">define</span><span class="keyword">(</span><span class="string">'MYSQL_BASE'</span><span class="keyword">,</span><span class="string">'.......'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="default">MYSQL_HOST</span><span class="keyword">, </span><span class="default">MYSQL_USER</span><span class="keyword">, </span><span class="default">MYSQL_PASS</span><span class="keyword">) or die(</span><span class="string">'Cannot connect'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mysql_select_db</span><span class="keyword">(</span><span class="default">MYSQL_BASE</span><span class="keyword">) or die(</span><span class="string">'Cannot select DB'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">mysql_set_charset</span><span class="keyword">(</span><span class="string">'utf8_general_ci'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp; </span><span class="default">$SESSION </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp; global </span><span class="default">$SESSION</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$session_db </span><span class="keyword">= new </span><span class="default">SessionDB</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
To use $SESSION on a function/class method, you must call:<br />
global $SESSION<br />
<br />
For who will not work with this over classes or functions, it is a very simple/fast way to work!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95811""></a>
  <div class="note">
   <strong class="user">bart2yk at yahoo dot com</strong>
   <a href="#95811" class="date">22-Jan-2010 01:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can call the session_write in db object destructor to be shore that you still have a connection to mysql and the session is write.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94962""></a>
  <div class="note">
   <strong class="user">joel the usual at sign then purerave.com</strong>
   <a href="#94962" class="date">04-Dec-2009 10:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When storing sessions in a DB, it's usually beneficial to use an existing custom DB object, but this creates problems with the latest version of PHP 5.3.1. This used to work fine on PHP 5.2.x (Linux and Windows).<br />
<br />
The problem now is that session_write_close() is not automatically called when execution ends, but rather after all the objects have been destructed, including the DB object!<br />
<br />
There are two ways around this, either manually calling session_write_close() at the end of your script(s), or not using the DB object.<br />
<br />
I'm sure this is the intended behavior from the beginning.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92658""></a>
  <div class="note">
   <strong class="user">skds1433 at hotmail dot com</strong>
   <a href="#92658" class="date">02-Aug-2009 03:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I pulled a really stupid move. If you are trying to debug your garbage collector, make sure you call the following &gt;&gt;&gt; BEFORE &lt;&lt;&lt; "session_start":<br />
<br />
<span class="default">&lt;?php<br />
ini_set</span><span class="keyword">(</span><span class="string">'session.gc_probability'</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
</span><span class="default">ini_set</span><span class="keyword">(</span><span class="string">'session.gc_divisor'</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
I was sure it was a bug in PHP, but turned out (like 99% of the time) to be me own fault.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91352""></a>
  <div class="note">
   <strong class="user">foddex at foddex dot net</strong>
   <a href="#91352" class="date">08-Jun-2009 01:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A quick note for people having problems storing binary session data. Using prepared statements solves all your quote-related issues! Start reading here <a href="http://php.net/manual/en/mysqli-stmt.prepare.php for more information!" rel="nofollow" target="_blank">http://php.net/manual/en/mysqli-stmt.prepare.php for more information!</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90431""></a>
  <div class="note">
   <strong class="user">yangqingrong at gmail dot com</strong>
   <a href="#90431" class="date">21-Apr-2009 09:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
session_set_save_handler is used before session_start.if your session is setted as auto start. it will return FALSE value.so you need add session_write_close() before session_set_save_handler to cancel the session's auto start.it&nbsp; likes this:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/*<br />
qq:290359552<br />
*/<br />
</span><span class="default">session_write_close</span><span class="keyword">(); </span><span class="comment">//cancel the session's auto start,important<br />
<br />
</span><span class="keyword">function </span><span class="default">open</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp; ...<br />
}<br />
....<br />
</span><span class="default">session_set_save_handler</span><span class="keyword">( ... );<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89564""></a>
  <div class="note">
   <strong class="user">harald at hholzer at</strong>
   <a href="#89564" class="date">13-Mar-2009 10:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
after spending 8 hours to find out whats going on..<br />
<br />
just for the records, because php.net ignore the real world out there:<br />
<br />
debian 5 installs by default the php-suhosin module, which changes the behavior of session_set_save_handler read/write function.<br />
<br />
on calling the session write function the session data will be encrypted, and the returning string from the read function are decrypted and verified.<br />
<br />
the encrypted data is no more compatible with session_encode/session_decode.<br />
<br />
and breaks by default, subdomain handling and multiple host setups where different document roots are used.<br />
<br />
for futher information look at:<br />
<a href="http://www.hardened-php.net/suhosin/configuration.html" rel="nofollow" target="_blank">http://www.hardened-php.net/suhosin/configuration.html</a><br />
<br />
session sample data (debian 4):<br />
test|s:3:"sdf";<br />
<br />
session sample data (debian 5, with php-suhosin):<br />
3GdlPEGr2kYgRFDs-pUSoKomZ4fN7r5BM5oKOCMsWNc...<br />
<br />
i thing the suhosin patch should report a warning in case of invalid session data, to get a clue whats going wrong.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89381""></a>
  <div class="note">
   <strong class="user">e dot sand at elisand dot com</strong>
   <a href="#89381" class="date">04-Mar-2009 11:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The "binary" data that is in the session data appears to surround class/object names, and if you pass your session data through a function to sanitize it for SQL injection, you may indeed run in to problems.<br />
<br />
For example, using the PDO::quote() function to prepare the data for injection (in my case for SQLite3), it was stopping short as soon as it encountered the first bit of binary data, causing my session information to be corrupted.<br />
<br />
This change *must* have happened somewhere in the 5.2 series, because I just started encountering this problem recently on a code base that had been tested &amp; working on earlier versions of PHP 5.2.<br />
<br />
This may in fact be a bug - I have not yet checked... but beware, and perhaps using base64 to encode/decode your session data is a good thing to do just to be sure (though you are now left unable to visually inspect serialized session information at the storage level which is a rather big problem for on-the-fly debugging of sessions).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89018""></a>
  <div class="note">
   <strong class="user">thomas at koudela dot net</strong>
   <a href="#89018" class="date">18-Feb-2009 06:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There are cases when calling session_write_close() from a destructor doesn't work. [E.g. order of destruction works bad for you and dependencies aren't on your side.] In all cases I stumble on... <br />
<br />
register_shutdown_function('session_write_close');<br />
<br />
...just works fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87623""></a>
  <div class="note">
   <strong class="user">patrick at eternalspace dot com</strong>
   <a href="#87623" class="date">12-Dec-2008 07:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
After about 8 hours of banging my skull on abstract art, it turns out that custom Write function use a blackbox encoding process that isn't represented here!&nbsp; (Perhaps in session_encode it is?)<br />
<br />
When a custom write() method gets the $session_hash and the $data of the session, the $data has binary data in it!&nbsp; Therefore, stripslashes() or mysql_real_escape_string() will NOT properly prepare a collapsed $_SESSION string for database storage!<br />
<br />
Instead, when committing write() $data to a database, it turns out that base64_encode() *WILL* catch all non-character information in the collapsed $_SESSION string, making it's result database-friendly!&nbsp; (And more filling!)<br />
<br />
Don't forget to add base64_decode() during the custom read() method!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87245""></a>
  <div class="note">
   <strong class="user">e dot sand at elisand dot com</strong>
   <a href="#87245" class="date">26-Nov-2008 05:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a few useful tips when working with custom session handlers (and sessions in general - with PHP 5.2.x)...<br />
<br />
1) Setting session_set_save_handler() automatically sets the ini setting session.save_handler to 'user' for you - no need to do it yourself.<br />
<br />
2) You may in fact not need to set up a __destruct() or use register_shutdown_function() to write your session data if using classes/objects.&nbsp; My testing with 5.2.x shows that my session data is safely saved without the need of either.&nbsp; I am unsure if PHP internals have changed to "fix" this and documents just aren't updated with that info, or if perhaps I haven't yet hit a scenario that would trigger this problem.<br />
<br />
3) It's stated a few places - but just to re-iterate: you cannot serialize internal PHP objects.&nbsp; This means if you have a class that extends an internal class (for example, a class that extends PDO for db functions), you will not be able to save an instance of your class in a session variable.&nbsp; Worst off, you will get a very vague error message about it, saying an unknown exception was thrown and it won't know from where.&nbsp; The solution is for any class that has to be serialized, don't extend internal classes, instead have them set up an instance of that object internally via __construct() or something, and then use __sleep() and __wakeup() hooks to export/reconfigure your class variables/resources.<br />
<br />
4) It appears that since PHP 4.x or somewhere, the seralization of data that takes place for sessions changed.&nbsp; It used to export human readable text much like serialize() does, however it appears that now the session data is further encoded - quite possibly to hinder session data tampering on the local filesystem.&nbsp; Just mentioning this if you used to view session data to see what was being saved.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="86173""></a>
  <div class="note">
   <strong class="user">anonymous at anonymous dot org</strong>
   <a href="#86173" class="date">06-Oct-2008 12:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you simply append the information from session variables every time you'll have many multiples for variables each time they are changed. a simple way to do this is explode the data twice to seperate the variable name from the other relevant information and foreach() check against the stored set. here is a little bit of a mess i wrote to do it.<br />
assuming stored session variables in both database and passed through function:<br />
<br />
<span class="default">&lt;?php<br />
$buffer </span><span class="keyword">= array();<br />
</span><span class="default">$buffer </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">'|'</span><span class="keyword">,</span><span class="default">$sessiondata</span><span class="keyword">);<br />
</span><span class="default">$buf1 </span><span class="keyword">= array();<br />
</span><span class="default">$buf2 </span><span class="keyword">= array();<br />
</span><span class="default">$finalbuff </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
foreach(</span><span class="default">$buffer </span><span class="keyword">as </span><span class="default">$i</span><span class="keyword">){ <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">';'</span><span class="keyword">,</span><span class="default">$i</span><span class="keyword">); <br />
&nbsp;&nbsp;&nbsp; foreach(</span><span class="default">$i </span><span class="keyword">as </span><span class="default">$b</span><span class="keyword">){ <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">array_push</span><span class="keyword">(</span><span class="default">$buf1</span><span class="keyword">,</span><span class="default">$b</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$buffer </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">'|'</span><span class="keyword">,</span><span class="default">$result</span><span class="keyword">[</span><span class="string">'data'</span><span class="keyword">]);<br />
foreach(</span><span class="default">$buffer </span><span class="keyword">as </span><span class="default">$i</span><span class="keyword">){ </span><span class="default">$i </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">';'</span><span class="keyword">,</span><span class="default">$i</span><span class="keyword">); foreach(</span><span class="default">$i </span><span class="keyword">as </span><span class="default">$b</span><span class="keyword">){ </span><span class="default">array_push</span><span class="keyword">(</span><span class="default">$buf2</span><span class="keyword">,</span><span class="default">$b</span><span class="keyword">);}}<br />
</span><span class="default">$z </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
</span><span class="default">$x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
while(</span><span class="default">$buf2</span><span class="keyword">[</span><span class="default">$z</span><span class="keyword">]){<br />
&nbsp;&nbsp;&nbsp; while(</span><span class="default">$buf1</span><span class="keyword">[</span><span class="default">$x</span><span class="keyword">]){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$buf2</span><span class="keyword">[</span><span class="default">$z</span><span class="keyword">] == </span><span class="default">$buf1</span><span class="keyword">[</span><span class="default">$x</span><span class="keyword">]){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buf2</span><span class="keyword">[(</span><span class="default">$z</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">)] = </span><span class="default">$buf1</span><span class="keyword">[(</span><span class="default">$x</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">)];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x</span><span class="keyword">+=</span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$z</span><span class="keyword">+=</span><span class="default">2</span><span class="keyword">;<br />
}<br />
foreach(</span><span class="default">$buf2 </span><span class="keyword">as </span><span class="default">$i</span><span class="keyword">){ </span><span class="default">$finalbuff </span><span class="keyword">.= </span><span class="default">$i</span><span class="keyword">; }<br />
</span><span class="default">?&gt;<br />
</span><br />
$sessiondata is the variable passed through the function and $result['data'] is the data stored in an sql database.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85066""></a>
  <div class="note">
   <strong class="user">james at dunmore dot me dot uk</strong>
   <a href="#85066" class="date">13-Aug-2008 06:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If your using database session handler and your database is in UTF8, but you happen to have a script running in IS0-8859 that tries to put symbols such as  signs into the database - then the session will corrupt and data will go missing.<br />
<br />
You can either - make sure you never put special characters into the session, or - more helpful, do this in your 'write' function<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">public static function </span><span class="default">write</span><span class="keyword">( </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$val </span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">utf8_encode</span><span class="keyword">( </span><span class="default">$val </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">( </span><span class="string">'!s:(\d+):"(.*?)";!se'</span><span class="keyword">, </span><span class="string">"'s:'.strlen('$2').':\"$2\";'"</span><span class="keyword">, </span><span class="default">$val </span><span class="keyword">); <br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//......<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
probably an overhead on this, but less overhead than loosing data.<br />
<br />
You could also use WDDX for storing sessions I suppose</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84739""></a>
  <div class="note">
   <strong class="user">bob at nospam dot com</strong>
   <a href="#84739" class="date">28-Jul-2008 05:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If using mysqli in procedural style you may expect the mysqli handle to be valid in the write callback. It is not the case, the handle in procedural style is a object that will be destroy unlink the plain mysql interface handle. Just register a shutdown function after set save handler like this:<br />
<br />
session_set_save_handler('_session_open', '_session_close', '_session_read', '_session_write', '_session_destroy', '_session_gc');<br />
register_shutdown_function('session_write_close');<br />
<br />
Since PHP 4.1, it more of a PRE-Shutdown and it fix the issue for me.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84300""></a>
  <div class="note">
   <strong class="user">tomas at slax dot org</strong>
   <a href="#84300" class="date">08-Jul-2008 07:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Regarding the SAPIs: The warning mentioned in function's description (that the Current working directory is changed with some SAPIs) is very important.<br />
<br />
It means that if your callback 'write' function needs to write to a file in current directory, it will not find it. You have to use absolute path and not rely upon the current working directory.<br />
<br />
I thought this warning applies only to some strange environments like Windows, but it happens exactly on Linux + Apache 2.2 + PHP 5.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83096""></a>
  <div class="note">
   <strong class="user">anddriga at gmail dot com</strong>
   <a href="#83096" class="date">09-May-2008 10:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Some PHP code for memcached session handler.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">SessionHadler<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private static </span><span class="default">$lifetime </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">open</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">self</span><span class="keyword">::</span><span class="default">$lifetime </span><span class="keyword">= </span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">'session.gc_maxlifetime'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">read</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">memcached</span><span class="keyword">::</span><span class="default">get</span><span class="keyword">(</span><span class="string">"sessions/</span><span class="keyword">{</span><span class="default">$id</span><span class="keyword">}</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">write</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">memcached</span><span class="keyword">::</span><span class="default">set</span><span class="keyword">(</span><span class="string">"sessions/</span><span class="keyword">{</span><span class="default">$id</span><span class="keyword">}</span><span class="string">"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">self</span><span class="keyword">::</span><span class="default">$lifetime</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">destroy</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">memcached</span><span class="keyword">::</span><span class="default">delete</span><span class="keyword">(</span><span class="string">"sessions/</span><span class="keyword">{</span><span class="default">$id</span><span class="keyword">}</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; private function </span><span class="default">__construct</span><span class="keyword">(){}<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">gc</span><span class="keyword">(){ return </span><span class="default">true</span><span class="keyword">; }<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">close</span><span class="keyword">(){&nbsp; &nbsp; return </span><span class="default">true</span><span class="keyword">; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__destruct</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">session_write_close</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82340""></a>
  <div class="note">
   <strong class="user">james at enginecreative dot co dot uk</strong>
   <a href="#82340" class="date">06-Apr-2008 03:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
With regards to db session handling:<br />
<br />
Remember if you use the REPLACE INTO method to have your session key as the primary key otherwise you will end up with duplicate records in your table.<br />
<br />
<a href="http://dev.mysql.com/doc/refman/5.0/en/replace.html" rel="nofollow" target="_blank">http://dev.mysql.com/doc/refman/5.0/en/replace.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82293""></a>
  <div class="note">
   <strong class="user">james dot ellis at gmail dot com</strong>
   <a href="#82293" class="date">04-Apr-2008 03:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When writing your own session handler, particularly database session handlers, play close attention to garbage cleanup and how it could affect server load.<br />
<br />
To pick a round number example:<br />
<br />
If you have 1000 requests per minute on session enabled pages, everyone needs a session started but the session garbage cleanup does not need to run every request. Doing so would cause unrequired queries on the database server.<br />
<br />
In this example, setting your probability/divisor to 1/1000 would be sufficient to clean up old sessions at a minimum once a minute. If you don't need that kind of granularity, increase the gc divisor.<br />
<br />
Finding the tradeoff between clearing up old sessions and server load is the important aspect here.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79706""></a>
  <div class="note">
   <strong class="user">maria at junkies dot jp</strong>
   <a href="#79706" class="date">09-Dec-2007 06:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
blow example and ta summary of these comments.<br />
and using the simple native functions of mysql.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Session<br />
</span><span class="keyword">{<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * a database connection resource<br />
&nbsp;&nbsp; &nbsp; * @var resource<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$_sess_db</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Open the session<br />
&nbsp;&nbsp; &nbsp; * @return bool<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">open</span><span class="keyword">() {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db </span><span class="keyword">= </span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="default">SESSION_DB_HOST</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">SESSION_DB_USER</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">SESSION_DB_PASS</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_select_db</span><span class="keyword">(</span><span class="default">SESSION_DB_DATABASE</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Close the session<br />
&nbsp;&nbsp; &nbsp; * @return bool<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">close</span><span class="keyword">() {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_close</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Close the session<br />
&nbsp;&nbsp; &nbsp; * @return bool<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">close</span><span class="keyword">() {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_close</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Read the session<br />
&nbsp;&nbsp; &nbsp; * @param int session id<br />
&nbsp;&nbsp; &nbsp; * @return string string of the sessoin<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">read</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$id </span><span class="keyword">= </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"SELECT `data` FROM `sessions` " </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"WHERE id = '%s'"</span><span class="keyword">, </span><span class="default">$id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$result </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">mysql_num_rows</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$record </span><span class="keyword">= </span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$record</span><span class="keyword">[</span><span class="string">'data'</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="string">''</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Write the session<br />
&nbsp;&nbsp; &nbsp; * @param int session id<br />
&nbsp;&nbsp; &nbsp; * @param string data of the session<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">write</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"REPLACE INTO `sessions` VALUES('%s', '%s', '%s')"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">time</span><span class="keyword">()));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Destoroy the session<br />
&nbsp;&nbsp; &nbsp; * @param int session id<br />
&nbsp;&nbsp; &nbsp; * @return bool<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">destroy</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"DELETE FROM `sessions` WHERE `id` = '%s'"</span><span class="keyword">, </span><span class="default">$id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">);<br />
<br />
}<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/**<br />
&nbsp;&nbsp; &nbsp; * Garbage Collector<br />
&nbsp;&nbsp; &nbsp; * @param int life time (sec.)<br />
&nbsp;&nbsp; &nbsp; * @return bool<br />
&nbsp;&nbsp; &nbsp; * @see session.gc_divisor&nbsp; &nbsp; &nbsp; 100<br />
&nbsp;&nbsp; &nbsp; * @see session.gc_maxlifetime 1440<br />
&nbsp;&nbsp; &nbsp; * @see session.gc_probability&nbsp; &nbsp; 1<br />
&nbsp;&nbsp; &nbsp; * @usage execution rate 1/100<br />
&nbsp;&nbsp; &nbsp; *&nbsp; &nbsp; &nbsp; &nbsp; (session.gc_probability/session.gc_divisor)<br />
&nbsp;&nbsp; &nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">gc</span><span class="keyword">(</span><span class="default">$max</span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="string">"DELETE FROM `sessions` WHERE `timestamp` &lt; '%s'"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">time</span><span class="keyword">() - </span><span class="default">$max</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">_sess_db</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
}<br />
<br />
</span><span class="comment">//ini_set('session.gc_probability', 50);<br />
</span><span class="default">ini_set</span><span class="keyword">(</span><span class="string">'session.save_handler'</span><span class="keyword">, </span><span class="string">'user'</span><span class="keyword">);<br />
<br />
</span><span class="default">$session </span><span class="keyword">= new </span><span class="default">Session</span><span class="keyword">();<br />
</span><span class="default">session_set_save_handler</span><span class="keyword">(array(</span><span class="default">$session</span><span class="keyword">, </span><span class="string">'open'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="default">$session</span><span class="keyword">, </span><span class="string">'close'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="default">$session</span><span class="keyword">, </span><span class="string">'read'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="default">$session</span><span class="keyword">, </span><span class="string">'write'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="default">$session</span><span class="keyword">, </span><span class="string">'destroy'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(</span><span class="default">$session</span><span class="keyword">, </span><span class="string">'gc'</span><span class="keyword">));<br />
<br />
</span><span class="comment">// below sample main<br />
<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">session_regenerate_id</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);<br />
<br />
if (isset(</span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'counter'</span><span class="keyword">])) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'counter'</span><span class="keyword">]++;<br />
} else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="string">'counter'</span><span class="keyword">] = </span><span class="default">1</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78437""></a>
  <div class="note">
   <strong class="user">mixailo at mercenaries dot ru</strong>
   <a href="#78437" class="date">11-Oct-2007 04:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It is useful to use MEMORY storage engine in MySQL while handling sessions.<br />
<a href="http://dev.mysql.com/doc/refman/5.0/en/memory-storage-engine.html" rel="nofollow" target="_blank">http://dev.mysql.com/doc/refman/5.0/en/memory-storage-engine.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78428""></a>
  <div class="note">
   <strong class="user">james at dunmore dot me dot uk</strong>
   <a href="#78428" class="date">11-Oct-2007 08:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I think it is very important here to stress that the WRITE method should use UPDATE+INSERT (or mysql specific REPLACE).<br />
<br />
There is example code "out there" that uses just UPDATE for the write method, in which case, when session_regenerate_id is called, session data is lost (as an update would fail, as the key has changed).<br />
<br />
I've just wasted a whole day due to this (I know I should have thought it through / RTFM, but it is an easy trap to fall into).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75336""></a>
  <div class="note">
   <strong class="user">sroby at colubris dot company</strong>
   <a href="#75336" class="date">24-May-2007 08:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The Web app I work on stores sessions in a database using PEAR::DB, so when I migrated it to PHP 5 everything broke because the DB object was unallocated by the time the write/close handlers were called.<br />
<br />
However, I've found that adding <span class="default">&lt;?php register_shutdown_function</span><span class="keyword">(</span><span class="string">"session_write_close"</span><span class="keyword">); </span><span class="default">?&gt;</span> works fine as a workaround to the problem.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73753""></a>
  <div class="note">
   <strong class="user">Colin</strong>
   <a href="#73753" class="date">08-Mar-2007 01:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Aspects of this have been posted in various comments but it's helpful to make it clearer.<br />
<br />
The custom session handler seems to perform actions in these orders:<br />
<br />
When session_start() is called:<br />
<br />
open<br />
read<br />
clean (if cleaning is being done this call)<br />
write<br />
close<br />
<br />
When session_destroy() is called after session_start():<br />
<br />
open<br />
read<br />
clean (if cleaning is being done this call)<br />
destroy<br />
close<br />
<br />
When session_regenerate_id(1) is called after session_start():<br />
<br />
open<br />
read<br />
clean (if cleaning is being done this call)<br />
destroy<br />
write<br />
close</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73748""></a>
  <div class="note">
   <strong class="user">Colin</strong>
   <a href="#73748" class="date">08-Mar-2007 12:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using a custom session handler, if the first callback function (sessOpen in my case) finds no session id, one is set by the time the second argument (sessRead in my case) is called.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69763""></a>
  <div class="note">
   <strong class="user">matt at openflows dot org</strong>
   <a href="#69763" class="date">19-Sep-2006 05:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that for security reasons the Debian and Ubuntu distributions of php do not call _gc to remove old sessions, but instead run /etc/cron.d/php*, which check the value of session.gc_maxlifetime in php.ini and delete the session files in /var/lib/php*.&nbsp; This is all fine, but it means if you write your own session handlers you'll need to explicitly call your _gc function yourself.&nbsp; A good place to do this is in your _close function, like this:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">_close</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">_gc</span><span class="keyword">(</span><span class="default">get_cfg_var</span><span class="keyword">(</span><span class="string">"session.gc_maxlifetime"</span><span class="keyword">));<br />
&nbsp;&nbsp; </span><span class="comment">// rest of function goes here<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68943""></a>
  <div class="note">
   <strong class="user">information at saunderswebsolutions dot com</strong>
   <a href="#68943" class="date">16-Aug-2006 11:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if session.auto_start is set to On in the php.ini, your session_set_save_handler will return false as the session has already been initialized.<br />
<br />
If you are finding that your code works OK on one machine but doesn't work on another, check to see if session.auto_start is set to On</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68652""></a>
  <div class="note">
   <strong class="user">sneakyimp AT hotmail DOT com</strong>
   <a href="#68652" class="date">04-Aug-2006 09:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
the behavior, return values, and exact time of calling for these functions is pretty poorly documented here.&nbsp; i thought folks might like to know that:<br />
<br />
1) calling session_start() triggers PHP to first call your open function and then call your read function before resuming with the code immediately following your session_start() call.<br />
<br />
2) calling session_id('some_value') within your open function WILL NOT SET THE SESSION COOKIE (at least not on my setup - PHP 4.4.1).&nbsp; Assuming you defined some function to validate a session id called my_func(), you might want to do something like this in your open function:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">function </span><span class="default">_open</span><span class="keyword">(</span><span class="default">$save_path</span><span class="keyword">, </span><span class="default">$session_name</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// check for session id<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sess_id </span><span class="keyword">= </span><span class="default">session_id</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; if (empty(</span><span class="default">$sess_id</span><span class="keyword">) || !</span><span class="default">myfunc</span><span class="keyword">(</span><span class="default">$sess_id</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">//session_id is INVALID - generating new<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$new_id </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">uniqid</span><span class="keyword">(</span><span class="string">"some random seed here"</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">session_id</span><span class="keyword">(</span><span class="default">$new_id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">setcookie</span><span class="keyword">(</span><span class="default">session_name</span><span class="keyword">(),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$new_id</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"/"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">".mydomain.com"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp; } </span><span class="comment">// _open()<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66383""></a>
  <div class="note">
   <strong class="user">djmaze@cpgnuke cms</strong>
   <a href="#66383" class="date">20-May-2006 10:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since register_shutdown_function() and __destruct() will not work on object based sessions, ESPECIALY when they are database based thru a class, then it seems you're screwed.<br />
<br />
Issue:<br />
register_shutdown_function('shutdown_function');<br />
new sql();<br />
new session();<br />
<br />
on destruct:<br />
sql __destruct()<br />
session __destruct() // can't call sql since already destroyed<br />
shutdown_function() // can't call instances since already destroyed<br />
<br />
A trick is to use an "first class instance"<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">my_proper_destructor<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$destroyers </span><span class="keyword">= array();<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">add</span><span class="keyword">(</span><span class="default">$class_instance</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">is_class</span><span class="keyword">(</span><span class="default">$class_instance</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$destroyers</span><span class="keyword">[] = </span><span class="default">$class_instance</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__destruct</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$destroyers </span><span class="keyword">as </span><span class="default">$des</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$des</span><span class="keyword">-&gt;</span><span class="default">on_destroy</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">$destruct </span><span class="keyword">= new </span><span class="default">my_proper_destructor</span><span class="keyword">();<br />
<br />
</span><span class="comment">// All your code starts here like:<br />
</span><span class="keyword">class </span><span class="default">session<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__construct</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$destruct</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$destruct</span><span class="keyword">-&gt;</span><span class="default">add</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Since my_proper_destructor is created first it also gets destroyed as the first. That way you can still call important class instances that need to do something on destruct.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="63701""></a>
  <div class="note">
   <strong class="user">mjohnson at pitsco dot com</strong>
   <a href="#63701" class="date">28-Mar-2006 11:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
With regards to the read handler, the docs say:<br />
<br />
&nbsp; "Read function must return string value always to make save <br />
&nbsp; handler work as expected. Return empty string if there is no <br />
&nbsp; data to read."<br />
<br />
I can't emphasize this enough. I just spent half a day trying to figure out why my sessions weren't storing any information. I was blithely returning the results of a query on the database from the read handler. Since there was no match for the new ID, the result was NULL. Since it wasn't a string, sessions were essentially disabled. So, the safe thing might be something like this:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">sessRead</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Look up data<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$results </span><span class="keyword">= </span><span class="default">getStuff</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Make sure it's a string<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">settype</span><span class="keyword">(</span><span class="default">$results</span><span class="keyword">, </span><span class="string">'string'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$results</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Of course, you can do whatever you want with it. But, no matter what, make sure you return a string.<br />
<br />
HTH,<br />
Michael</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60670""></a>
  <div class="note">
   <strong class="user">boswachter at xs4all nl</strong>
   <a href="#60670" class="date">13-Jan-2006 03:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you're creating a sessionhandler class, and use a database-class and you are experiencing problems because of destroyed objects when write is called, you can fix this relatively easily:<br />
<br />
register_shutdown_function("session_write_close");<br />
<br />
This way, the session gets written of before your database-class is destroyed.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60316""></a>
  <div class="note">
   <strong class="user">stalker at ruun dot de</strong>
   <a href="#60316" class="date">03-Jan-2006 07:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
object- and mysql-based session-handler, requires the following table:<br />
<br />
CREATE TABLE `ws_sessions` (<br />
&nbsp; `session_id` varchar(255) binary NOT NULL default '',<br />
&nbsp; `session_expires` int(10) unsigned NOT NULL default '0',<br />
&nbsp; `session_data` text,<br />
&nbsp; PRIMARY KEY&nbsp; (`session_id`)<br />
) TYPE=InnoDB;<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">session </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// session-lifetime<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">var </span><span class="default">$lifeTime</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// mysql-handle<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">var </span><span class="default">$dbHandle</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">open</span><span class="keyword">(</span><span class="default">$savePath</span><span class="keyword">, </span><span class="default">$sessName</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment">// get session-lifetime<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">lifeTime </span><span class="keyword">= </span><span class="default">get_cfg_var</span><span class="keyword">(</span><span class="string">"session.gc_maxlifetime"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment">// open database-connection<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$dbHandle </span><span class="keyword">= @</span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="string">"server"</span><span class="keyword">,</span><span class="string">"user"</span><span class="keyword">,</span><span class="string">"password"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$dbSel </span><span class="keyword">= @</span><span class="default">mysql_select_db</span><span class="keyword">(</span><span class="string">"database"</span><span class="keyword">,</span><span class="default">$dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="comment">// return success<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="keyword">if(!</span><span class="default">$dbHandle </span><span class="keyword">|| !</span><span class="default">$dbSel</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle </span><span class="keyword">= </span><span class="default">$dbHandle</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">close</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gc</span><span class="keyword">(</span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">'session.gc_maxlifetime'</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// close database-connection<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return @</span><span class="default">mysql_close</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">read</span><span class="keyword">(</span><span class="default">$sessID</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// fetch session-data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"SELECT session_data AS d FROM ws_sessions<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WHERE session_id = '</span><span class="default">$sessID</span><span class="string">'<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; AND session_expires &gt; "</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">(),</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// return data or an empty string at failure<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$row </span><span class="keyword">= </span><span class="default">mysql_fetch_assoc</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$row</span><span class="keyword">[</span><span class="string">'d'</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">write</span><span class="keyword">(</span><span class="default">$sessID</span><span class="keyword">,</span><span class="default">$sessData</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// new session-expire-time<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$newExp </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">() + </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">lifeTime</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// is a session with this id in the database?<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"SELECT * FROM ws_sessions<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; WHERE session_id = '</span><span class="default">$sessID</span><span class="string">'"</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if yes,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">mysql_num_rows</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// ...update session-data<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"UPDATE ws_sessions<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; SET session_expires = '</span><span class="default">$newExp</span><span class="string">',<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session_data = '</span><span class="default">$sessData</span><span class="string">'<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; WHERE session_id = '</span><span class="default">$sessID</span><span class="string">'"</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if something happened, return true<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">mysql_affected_rows</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if no session-data was found,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// create a new row<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"INSERT INTO ws_sessions (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session_id,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session_expires,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; session_data)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; VALUES(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '</span><span class="default">$sessID</span><span class="string">',<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '</span><span class="default">$newExp</span><span class="string">',<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; '</span><span class="default">$sessData</span><span class="string">')"</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if row was created, return true<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">mysql_affected_rows</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// an unknown error occured<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">destroy</span><span class="keyword">(</span><span class="default">$sessID</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// delete session-data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"DELETE FROM ws_sessions WHERE session_id = '</span><span class="default">$sessID</span><span class="string">'"</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if session was deleted, return true,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">mysql_affected_rows</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// ...else return false<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">gc</span><span class="keyword">(</span><span class="default">$sessMaxLifeTime</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// delete old sessions<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"DELETE FROM ws_sessions WHERE session_expires &lt; "</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">(),</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// return affected rows<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">mysql_affected_rows</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dbHandle</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$session </span><span class="keyword">= new </span><span class="default">session</span><span class="keyword">();<br />
</span><span class="default">session_set_save_handler</span><span class="keyword">(array(&amp;</span><span class="default">$session</span><span class="keyword">,</span><span class="string">"open"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(&amp;</span><span class="default">$session</span><span class="keyword">,</span><span class="string">"close"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(&amp;</span><span class="default">$session</span><span class="keyword">,</span><span class="string">"read"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(&amp;</span><span class="default">$session</span><span class="keyword">,</span><span class="string">"write"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(&amp;</span><span class="default">$session</span><span class="keyword">,</span><span class="string">"destroy"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(&amp;</span><span class="default">$session</span><span class="keyword">,</span><span class="string">"gc"</span><span class="keyword">));<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="comment">// etc...<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59363""></a>
  <div class="note">
   <strong class="user">bachir</strong>
   <a href="#59363" class="date">04-Dec-2005 10:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
php doesn't make any checks about PHPSESSID cookie format, it is then important to verify cookie format before making any sql request.<br />
<br />
if your read session request is :<br />
SELECT DataValue FROM sessions WHERE SessionID='$aKey'<br />
<br />
this generic cookie could succeed to access others session: PHPSESSID=1' OR SessionID LIKE '%&gt;&gt;<br />
<br />
for safety, you can make this verification before sql request:<br />
if (! preg_match('/^([0-9a-f]{32})$/i',$aKey)) return NULL;<br />
<br />
hope this can be helpful</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57001""></a>
  <div class="note">
   <strong class="user">rudy dot metzger at pareto dot nl</strong>
   <a href="#57001" class="date">21-Sep-2005 06:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
NOTE: as from php-5.0.5, objects are destroyed BEFORE the session_write() is called! So if you use an object as custom session handler, your writes will fail, as at the moment of write the object is already destroyed. A workaround for this is to use session_write_close() in the __destruct() of the object. This however only works if you do not need any other objectes, as these already might be gone! I only hope that object are destroyed in "descening" order, as if you would have a DB object in the session handler object which handles the DB connects, you would have to use __destruct() also in this object. otherwise your session object is still alive but your DB is long gone...<br />
<br />
I raised a bug for this already but it is claimed that this is no bug.<br />
<br />
This only applies to versions 5.0.5 (and possibly higher)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56172""></a>
  <div class="note">
   <strong class="user">kevin at insuremytrip dot com</strong>
   <a href="#56172" class="date">25-Aug-2005 01:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When creating a session-handling class, I have discovered that it is important to remember that your session object and the $_SESSION global are TWO SEPARATE ENTITIES. You need to create a reference between your Session Object and the built-in $_SESSION global:<br />
<br />
<span class="default">&lt;?php<br />
session_set_save_handler</span><span class="keyword">(<br />
&nbsp;array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"_OPEN"</span><span class="keyword">), <br />
&nbsp;array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"_CLOSE"</span><span class="keyword">), <br />
&nbsp;array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"_READ"</span><span class="keyword">), <br />
&nbsp;array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"_WRITE"</span><span class="keyword">), <br />
&nbsp;array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"_DESTROY"</span><span class="keyword">), <br />
&nbsp;array(&amp;</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"_GC"</span><span class="keyword">)<br />
);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">session_start</span><span class="keyword">();<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Cache-control: private"</span><span class="keyword">); </span><span class="comment">// to overcome/fix a bug in IE 6.x<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session&nbsp; &nbsp; </span><span class="keyword">=&amp; </span><span class="default">$_SESSION</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
Additionally, when you add a $_SESSION variable, it's a good idea to add it as a Session Object variable at the same time, if you want your code to use the Session Object between page changes/reloads:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">setSessionVariable</span><span class="keyword">(</span><span class="default">$key</span><span class="keyword">,</span><span class="default">$value</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$_SESSION</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">] = </span><span class="default">$value</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">session</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">] = </span><span class="default">$value</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; return;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56033""></a>
  <div class="note">
   <strong class="user">ccav at maxbaud dot net</strong>
   <a href="#56033" class="date">21-Aug-2005 04:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Ok, after much hairpulling, I've figured out a successful way to store objects in a session using a postgresql savehandler.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">write </span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">, </span><span class="default">$sess_data</span><span class="keyword">)<br />
{<br />
&nbsp; global </span><span class="default">$sql</span><span class="keyword">;&nbsp; </span><span class="comment">// my global db connection object<br />
&nbsp; </span><span class="default">$sess_data </span><span class="keyword">= @</span><span class="default">pg_escape_bytea</span><span class="keyword">(</span><span class="default">serialize</span><span class="keyword">(</span><span class="default">$sess_id</span><span class="keyword">)); </span><span class="comment">//works with any type<br />
&nbsp; </span><span class="default">$sql</span><span class="keyword">-&gt;</span><span class="default">Query</span><span class="keyword">(</span><span class="string">"delete from sessions where sessionid = '</span><span class="default">$id</span><span class="string">'"</span><span class="keyword">); </span><span class="comment">// delete old session record<br />
&nbsp; </span><span class="default">$sql</span><span class="keyword">-&gt;</span><span class="default">Query</span><span class="keyword">(</span><span class="string">"insert into sessions (sessionid,datavalue) values ('</span><span class="default">$id</span><span class="string">', '</span><span class="default">$sess_data</span><span class="string">')"</span><span class="keyword">);&nbsp; </span><span class="comment">//insert into session table<br />
&nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">read </span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">)<br />
{<br />
&nbsp; global </span><span class="default">$sql</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$result</span><span class="keyword">=</span><span class="default">$sql</span><span class="keyword">-&gt;</span><span class="default">Query</span><span class="keyword">(</span><span class="string">"select * from sessions where sessionid = '</span><span class="default">$id</span><span class="string">'"</span><span class="keyword">);<br />
&nbsp; if (</span><span class="default">$sql</span><span class="keyword">-&gt;</span><span class="default">rows</span><span class="keyword">==</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$row</span><span class="keyword">=</span><span class="default">$sql</span><span class="keyword">-&gt;</span><span class="default">Fetch</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rval </span><span class="keyword">= </span><span class="default">unserialize</span><span class="keyword">(@</span><span class="default">pg_unescape_bytea</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">-&gt;</span><span class="default">data</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]));<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$rval</span><span class="keyword">;<br />
&nbsp; } else {<br />
&nbsp;&nbsp;&nbsp; return </span><span class="string">""</span><span class="keyword">;<br />
&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Make the datavalue column (the one used to store the actual session data) in the sessions table type bytea.<br />
<br />
The problem apparently lies in the PHP serialize for objects, where there is a CR/LF inserted between the object id and the property array.&nbsp; The CR/LF isn't escaped, and causes a fit for postgresql.<br />
<br />
Any data type in PHP can be serialized, so there's no need to distinguish between types.<br />
<br />
The object is fully restored, with methods.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54822""></a>
  <div class="note">
   <strong class="user">niklas at removethisandthedot dot bivald dot com</strong>
   <a href="#54822" class="date">15-Jul-2005 05:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Many people are using session_set_save_handler to store the session in a session database, which ofcourse is both valid and smart since it (could) increas security. <br />
<br />
What many people forgets, is that session ids can easily be edited by a user as he see fit (by editing a session_cookie for example*) <br />
<br />
* If you like to play around to test your site, check Add n edit Cookies extension for firefox.<br />
<br />
This might not be a big deal when saving them in a file, since the worst thing that may happen is that the user losts his session and a new one is generated. But when saving to an DB it is*. One should never trust that the server itself add slashes and escapes other vital characters. <br />
<br />
* A google search for "SQL Injection" gives 716 000 hits. <br />
<br />
Example code, none working:<br />
<span class="default">&lt;?PHP<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">read </span><span class="keyword">(</span><span class="default">$session_id</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"SELECT * FROM mysessions WHERE session_id=</span><span class="default">$session_id</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data</span><span class="keyword">= </span><span class="default">mysql_fetch_array</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Is obviously flawed. Since setting our session ID to "; drop mysessions; " would create serious problems. <br />
<br />
A more suitable approch would be, something in the lines of: <br />
<br />
Example code, none working:<br />
<span class="default">&lt;?PHP<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">read </span><span class="keyword">(</span><span class="default">$session_id</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// ( Code by php.net )<br />
&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">get_magic_quotes_gpc</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$session_id </span><span class="keyword">= </span><span class="default">stripslashes</span><span class="keyword">(</span><span class="default">$session_id</span><span class="keyword">);<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; </span><span class="comment">// Quote if not integer<br />
&nbsp;&nbsp; </span><span class="keyword">if (!</span><span class="default">is_numeric</span><span class="keyword">(</span><span class="default">$session_id</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$session_id </span><span class="keyword">= </span><span class="default">mysql_real_escape_string</span><span class="keyword">(</span><span class="default">$session_id</span><span class="keyword">);<br />
&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sql&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"SELECT * FROM mysessions WHERE session_id=</span><span class="default">$session_id</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fieldarray </span><span class="keyword">= </span><span class="default">mysql_fetch_array</span><span class="keyword">(</span><span class="default">$sql</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
I quick checked different sample codes and tutorials and none of them actually escaped session ids. <br />
<br />
That's my two cents for too night, <br />
Niklas</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53747""></a>
  <div class="note">
   <strong class="user">korvus at kgstudios dot net</strong>
   <a href="#53747" class="date">11-Jun-2005 05:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems when you call 'session_name()', php loads the session id automatically from GET ( if the index exists ) and passes it to the 'read' callback method correctly, but the 'write' callback is invoked twice: first the auto-generated session id, then the custom session id<br />
<br />
So be aware of what queries you execute inside the callback .. I got crazy because I used a MySQL 'REPLACE' statement to agilize, and I spent a lot of hours trying to understand why 2 rows instead of 1 were being affected ( the first id was inserting, the second updating )<br />
<br />
I hope this helps!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52606""></a>
  <div class="note">
   <strong class="user">Robert Chapin</strong>
   <a href="#52606" class="date">06-May-2005 02:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Session authentication is not meant to be part of the session handlers.<br />
<br />
These handlers only read and write the session data itself, and will not allow you to call the vital function session_regenerate_id().<br />
<br />
To add extra authentication routines, call them after session_start returns control.&nbsp; DO NOT put them in your 'open' or 'read' handlers.<br />
<br />
Enjoy,<br />
-- Miqro</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49630""></a>
  <div class="note">
   <strong class="user">oliver at teqneers dot de</strong>
   <a href="#49630" class="date">03-Feb-2005 03:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For some people it might be important to know, that if the standard session handler has been overwritten with session_set_save_handler, no locking is working anymore (between session_read and session_write). The following might happen:<br />
<br />
script "A" start&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; .<br />
read session data&nbsp; &nbsp; &nbsp; &nbsp; .<br />
.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script "B" start<br />
.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; read session data<br />
running (30secs)&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; add session data<br />
.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; write sesion data<br />
.&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; script "B" stop<br />
write session data&nbsp; &nbsp; &nbsp;&nbsp; .<br />
script "A" stop&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<br />
<br />
If a script "A" runs for a long time (say 30secs) the same user might start another script "B", which also uses a session. Script "B" will start and read session data, even though script "A" is still running. Because script "B" is much faster it will finish its work and write back its session data before script "A" has ended. Now script "A" ends and overwrites all of script "B"'s session data. If you DON'T use session_set_save_handler, this cannot happend, because in this case, PHP will not start script "B" until script "A" ends.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45803""></a>
  <div class="note">
   <strong class="user">Balu</strong>
   <a href="#45803" class="date">19-Sep-2004 03:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If a session is closed the save-handlers seem to be resetted (in PHP 4.1.2 they are), so you need to run session_set_save_handler() again after e.g. running session_write_close() and restarting the session with session_start();</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43100""></a>
  <div class="note">
   <strong class="user">dolan at unt dot edu</strong>
   <a href="#43100" class="date">09-Jun-2004 01:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is an LDAP implementation that I wrote which works just fine for me.&nbsp; This assumes you've got some global variables with your host and other info.&nbsp; It also uses a custom error function which I have not defined here.&nbsp; Also, it assumes your LDAP server is set up with correct permissions, objectclass, and all that.&nbsp; I used an octet string in LDAP to hold the session data.&nbsp; I had to manually wrap some of this so be careful with cutting and pasting.<br />
<br />
<span class="default">&lt;?php<br />
$sessconn</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">;<br />
</span><span class="comment">//Custom session handling stored in local LDAP<br />
</span><span class="keyword">function </span><span class="default">ldap_sess_open</span><span class="keyword">(</span><span class="default">$save_path</span><span class="keyword">,</span><span class="default">$session_name</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$infohost</span><span class="keyword">,</span><span class="default">$infoport</span><span class="keyword">,</span><span class="default">$infodn</span><span class="keyword">,</span><span class="default">$infopw</span><span class="keyword">,</span><span class="default">$sessconn</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sessconn</span><span class="keyword">=@</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$infohost</span><span class="keyword">,</span><span class="default">$infoport</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(!@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$infodn</span><span class="keyword">,</span><span class="default">$infopw</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">setError</span><span class="keyword">(</span><span class="string">"Failed to open session."</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">ldap_sess_close</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$sessconn</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">ldap_close</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">ldap_sess_read</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$sessconn</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sr</span><span class="keyword">=@</span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="string">'ou=sessions,o=Company'</span><span class="keyword">,<br />
</span><span class="string">"(cn=</span><span class="default">$id</span><span class="string">)"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$info</span><span class="keyword">=@</span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$sr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$info</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">]&gt;</span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$info</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">][</span><span class="string">'session'</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp;&nbsp; return </span><span class="string">""</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">ldap_sess_write</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">,</span><span class="default">$sess_data</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$sessconn</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$update</span><span class="keyword">=array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$update</span><span class="keyword">[</span><span class="string">'objectClass'</span><span class="keyword">]=array(</span><span class="string">'phpsession'</span><span class="keyword">,</span><span class="string">'top'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$update</span><span class="keyword">[</span><span class="string">'session'</span><span class="keyword">]=</span><span class="default">$sess_data</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dn</span><span class="keyword">=</span><span class="string">"cn=</span><span class="default">$id</span><span class="string">,ou=sessions,o=Company"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">ldap_delete</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">ldap_add</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">,</span><span class="default">$update</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">ldap_sess_destroy</span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$sessconn</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dn</span><span class="keyword">=</span><span class="string">"cn=</span><span class="default">$id</span><span class="string">,ou=sessions,o=Company"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">ldap_delete</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">ldap_sess_gc</span><span class="keyword">(</span><span class="default">$maxlifetime</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$sessconn</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sr</span><span class="keyword">=@</span><span class="default">ldap_search</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="string">'ou=sessions,o=Company'</span><span class="keyword">,<br />
</span><span class="string">'(objectClass=phpsession)'</span><span class="keyword">,array(</span><span class="string">'+'</span><span class="keyword">,</span><span class="string">'cn'</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$info</span><span class="keyword">=@</span><span class="default">ldap_get_entries</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$sr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$info</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">]&gt;</span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$info</span><span class="keyword">[</span><span class="string">'count'</span><span class="keyword">];</span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$id</span><span class="keyword">=</span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">'cn'</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dn</span><span class="keyword">=</span><span class="string">"cn=</span><span class="default">$id</span><span class="string">,ou=sessions,o=Company"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$modified</span><span class="keyword">=</span><span class="default">stamp2local</span><span class="keyword">(</span><span class="default">$info</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">'modifytimestamp'</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if((</span><span class="default">time</span><span class="keyword">()-</span><span class="default">$modified</span><span class="keyword">)&gt;=</span><span class="default">$maxlifetime</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">ldap_delete</span><span class="keyword">(</span><span class="default">$sessconn</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">//converts my LDAP timestamps over to Unix timestamps<br />
</span><span class="keyword">function </span><span class="default">stamp2local</span><span class="keyword">(</span><span class="default">$ldapstamp</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$year</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ldapstamp</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$month</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ldapstamp</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$day</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ldapstamp</span><span class="keyword">,</span><span class="default">6</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$hour</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ldapstamp</span><span class="keyword">,</span><span class="default">8</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$minute</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$ldapstamp</span><span class="keyword">,</span><span class="default">10</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$stamp</span><span class="keyword">=</span><span class="default">gmmktime</span><span class="keyword">(</span><span class="default">$hour</span><span class="keyword">,</span><span class="default">$minute</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$month</span><span class="keyword">,</span><span class="default">$day</span><span class="keyword">,</span><span class="default">$year</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$stamp</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">//Use this so that if your LDAP server goes down people can still<br />
//retain sessions the normal way<br />
</span><span class="default">$checkds</span><span class="keyword">=@</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$infohost</span><span class="keyword">,</span><span class="default">$infoport</span><span class="keyword">);<br />
if(@</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$checkds</span><span class="keyword">,</span><span class="default">$infodn</span><span class="keyword">,</span><span class="default">$infopw</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">session_set_save_handler</span><span class="keyword">(</span><span class="string">"ldap_sess_open"</span><span class="keyword">,</span><span class="string">"ldap_sess_close"</span><span class="keyword">,<br />
</span><span class="string">"ldap_sess_read"</span><span class="keyword">,</span><span class="string">"ldap_sess_write"</span><span class="keyword">,</span><span class="string">"ldap_sess_destroy"</span><span class="keyword">,<br />
</span><span class="string">"ldap_sess_gc"</span><span class="keyword">);<br />
}<br />
@</span><span class="default">ldap_close</span><span class="keyword">(</span><span class="default">$checkds</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="37995""></a>
  <div class="note">
   <strong class="user">tonanbarbarian at hotmail dot com</strong>
   <a href="#37995" class="date">03-Dec-2003 10:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I found the need to have a garbage collection function run with my sessions so I had to write my own session handler.<br />
<br />
I took the example code above but found that it had a problem, it does not open the session file exclusively.<br />
This means that if you have a frameset where 2 pages are accessing the session at the same time and both modify the session only the last page to finish processing will have its session data saved. The first page will have all of its session data overwritten.<br />
<br />
So here is a modified version of a file session handler in PHP that has file locking. (Not supported on FAT or NFS apparently)<br />
<br />
<span class="default">&lt;?php<br />
$sess_save_path </span><span class="keyword">= </span><span class="default">$sess_session_name </span><span class="keyword">= </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">;<br />
function </span><span class="default">open </span><span class="keyword">(</span><span class="default">$save_path</span><span class="keyword">, </span><span class="default">$session_name</span><span class="keyword">) {<br />
&nbsp; global </span><span class="default">$sess_save_path</span><span class="keyword">, </span><span class="default">$sess_session_name</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
&nbsp; </span><span class="default">$sess_save_path </span><span class="keyword">= </span><span class="default">$save_path</span><span class="keyword">;<br />
&nbsp; </span><span class="default">$sess_session_name </span><span class="keyword">= </span><span class="default">$session_name</span><span class="keyword">;<br />
&nbsp; return(</span><span class="default">true</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">close</span><span class="keyword">() {<br />
&nbsp; global </span><span class="default">$fp</span><span class="keyword">;<br />
&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">;<br />
&nbsp; return(</span><span class="default">true</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">read </span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp; global </span><span class="default">$sess_save_path</span><span class="keyword">, </span><span class="default">$sess_session_name</span><span class="keyword">, </span><span class="default">$fp</span><span class="keyword">;<br />
<br />
&nbsp; </span><span class="default">$sess_file </span><span class="keyword">= </span><span class="string">"</span><span class="default">$sess_save_path</span><span class="string">/sess_</span><span class="default">$id</span><span class="string">"</span><span class="keyword">;<br />
&nbsp; if (</span><span class="default">$fp </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$sess_file</span><span class="keyword">, </span><span class="string">"r+"</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sess_data </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">filesize</span><span class="keyword">(</span><span class="default">$sess_file</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; return(</span><span class="default">$sess_data</span><span class="keyword">);<br />
&nbsp; } else {<br />
&nbsp;&nbsp;&nbsp; return(</span><span class="string">""</span><span class="keyword">); </span><span class="comment">// Must return "" here.<br />
&nbsp; </span><span class="keyword">}<br />
<br />
}<br />
<br />
function </span><span class="default">write </span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">, </span><span class="default">$sess_data</span><span class="keyword">) {<br />
&nbsp; global </span><span class="default">$sess_save_path</span><span class="keyword">, </span><span class="default">$sess_session_name</span><span class="keyword">, </span><span class="default">$fp</span><span class="keyword">;<br />
<br />
&nbsp; </span><span class="default">$sess_file </span><span class="keyword">= </span><span class="string">"</span><span class="default">$sess_save_path</span><span class="string">/sess_</span><span class="default">$id</span><span class="string">"</span><span class="keyword">;<br />
&nbsp; if (!empty(</span><span class="default">$fp</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fseek</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return(</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$sess_data</span><span class="keyword">));<br />
&nbsp; } elseif (</span><span class="default">$fp </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$sess_file</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return(</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$sess_data</span><span class="keyword">));<br />
&nbsp; } else {<br />
&nbsp;&nbsp;&nbsp; return(</span><span class="default">false</span><span class="keyword">);<br />
&nbsp; }<br />
}<br />
<br />
function </span><span class="default">destroy </span><span class="keyword">(</span><span class="default">$id</span><span class="keyword">) {<br />
&nbsp; global </span><span class="default">$sess_save_path</span><span class="keyword">, </span><span class="default">$sess_session_name</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
&nbsp; </span><span class="default">$sess_file </span><span class="keyword">= </span><span class="string">"</span><span class="default">$sess_save_path</span><span class="string">/sess_</span><span class="default">$id</span><span class="string">"</span><span class="keyword">;<br />
&nbsp; return(@</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$sess_file</span><span class="keyword">));<br />
}<br />
<br />
function </span><span class="default">gc </span><span class="keyword">(</span><span class="default">$maxlifetime</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$sess_save_path</span><span class="keyword">, </span><span class="default">$sess_session_name</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
&nbsp; </span><span class="default">$sess_file </span><span class="keyword">= </span><span class="string">"</span><span class="default">$sess_save_path</span><span class="string">/sess_</span><span class="default">$id</span><span class="string">"</span><span class="keyword">;<br />
&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">session_set_save_handler </span><span class="keyword">(</span><span class="string">"open"</span><span class="keyword">, </span><span class="string">"close"</span><span class="keyword">, </span><span class="string">"read"</span><span class="keyword">, </span><span class="string">"write"</span><span class="keyword">, </span><span class="string">"destroy"</span><span class="keyword">, </span><span class="string">"gc"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
enjoy</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="37710""></a>
  <div class="note">
   <strong class="user">coco at digitalco2 dot com</strong>
   <a href="#37710" class="date">23-Nov-2003 03:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When using mySQL for your session handling functions, don't forget to call mysql_select_db() to change the database if you are using a separate database for your session data. Call mysql_select_db() INSIDE every handler function that accesses the database, since if you write session data after accessing another database, it will not change the database to your session database, and therefore, not write the session data.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="27153""></a>
  <div class="note">
   <strong class="user">ivo at magstudio dot net</strong>
   <a href="#27153" class="date">25-Nov-2002 07:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a few words to explain some troubles while using session_set_save_handler(). It appears that internally PHP calls session management functions in this order: open(), read(), write(), close(). Close() function is called even if you does not make a call to sesison_start(), perhaps for some reasons like cleaning. <br />
&nbsp;&nbsp; If you try to redefine these functions and call sessions_set_save_handler() but something doesn't work, (in my case the ssion data hasn't been written) it's a good idea to debug them in the order they are called. They doesn't produce error output to browser but you can use print or echo. <br />
&nbsp;&nbsp; Shortly, if your write() function doesn't work as expected take a look for errors in previous functions - open() and read(). <br />
&nbsp;&nbsp; I hope that this will help to save someone few hours debugging.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="22194""></a>
  <div class="note">
   <strong class="user">steve at saturn5 dot com</strong>
   <a href="#22194" class="date">10-Jun-2002 08:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you want to call session_start again after session_destroy, you have to call session_set_save_handler a second time. otherwise the session module doesn't know about all the nice functions you defined earlier because it has been destroyed.<br />
<br />
example:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment"># session handlers functions are defined<br />
# somewhere else<br />
<br />
</span><span class="default">session_set_save_handler </span><span class="keyword">(</span><span class="string">"sess_open"</span><span class="keyword">, </span><span class="string">"sess_close"</span><span class="keyword">, </span><span class="string">"sess_read"</span><span class="keyword">, </span><span class="string">"sess_write"</span><span class="keyword">, </span><span class="string">"sess_destroy"</span><span class="keyword">, </span><span class="string">"sess_gc"</span><span class="keyword">);<br />
<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment"># do some stuff ...<br />
<br />
</span><span class="default">session_destroy</span><span class="keyword">();<br />
<br />
</span><span class="comment"># call this again, because session_destroy<br />
# destroys more than just the session.<br />
<br />
</span><span class="default">session_set_save_handler </span><span class="keyword">(</span><span class="string">"sess_open"</span><span class="keyword">, </span><span class="string">"sess_close"</span><span class="keyword">, </span><span class="string">"sess_read"</span><span class="keyword">, </span><span class="string">"sess_write"</span><span class="keyword">, </span><span class="string">"sess_destroy"</span><span class="keyword">, </span><span class="string">"sess_gc"</span><span class="keyword">);<br />
<br />
</span><span class="default">session_start</span><span class="keyword">();<br />
<br />
</span><span class="comment"># ...<br />
</span><span class="default">?&gt;<br />
</span><br />
we need to call session_start() twice in our login script to prevent multiple logins. i tore my hair out over this one. hope this helps someone else. :)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="21315""></a>
  <div class="note">
   <strong class="user">spam at skurrilo dot de</strong>
   <a href="#21315" class="date">08-May-2002 04:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You can't use the session autostart feature with <br />
<br />
session.save_handler = user<br />
<br />
set in your php.ini. Use instead the auto_prepend_file directive in the php.ini and point it to your save_handler with an session_start() at the end.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="20829""></a>
  <div class="note">
   <strong class="user">jpm at phpbrasil dot com</strong>
   <a href="#20829" class="date">17-Apr-2002 10:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You may also use static class methods as the 'function names' for session_set_save_handler(), as in:<br />
<br />
<span class="default">&lt;?php<br />
session_set_save_handler</span><span class="keyword">(<br />
&nbsp; array(</span><span class="string">"SessionHandler"</span><span class="keyword">, </span><span class="string">"open"</span><span class="keyword">),<br />
&nbsp; array(</span><span class="string">"SessionHandler"</span><span class="keyword">, </span><span class="string">"close"</span><span class="keyword">),<br />
&nbsp; array(</span><span class="string">"SessionHandler"</span><span class="keyword">, </span><span class="string">"read"</span><span class="keyword">),<br />
&nbsp; array(</span><span class="string">"SessionHandler"</span><span class="keyword">, </span><span class="string">"write"</span><span class="keyword">),<br />
&nbsp; array(</span><span class="string">"SessionHandler"</span><span class="keyword">, </span><span class="string">"destroy"</span><span class="keyword">),<br />
&nbsp; array(</span><span class="string">"SessionHandler"</span><span class="keyword">, </span><span class="string">"gc"</span><span class="keyword">)<br />
);<br />
</span><span class="default">?&gt;<br />
</span><br />
Anyway, just a little note that this is also possible.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.session-set-cookie-params.html">session_set_cookie_params</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.session-start.html">session_start</a></div>
 <div class="up"><a href="ref.session.html">Session Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
