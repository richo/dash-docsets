<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Portable advisory file locking</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.filetype.html">filetype</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.fnmatch.html">fnmatch</a></div>
 <div class="up"><a href="ref.filesystem.html">Filesystem Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.flock" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">flock</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">flock</span> &mdash; <span class="dc-title">Portable advisory file locking</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.flock-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><b>flock</b></span>
    ( <span class="methodparam"><span class="type">resource</span> <tt class="parameter">$handle</tt></span>
   , <span class="methodparam"><span class="type">int</span> <tt class="parameter">$operation</tt></span>
   [, <span class="methodparam"><span class="type">int</span> <tt class="parameter reference">&$wouldblock</tt></span>
  ] )</div>

  <p class="para rdfs-comment">
   <span class="function"><b>flock()</b></span> allows you to perform a simple reader/writer
   model which can be used on virtually every platform (including most Unix
   derivatives and even Windows).
  </p>
  <p class="para">
   On versions of PHP before 5.3.2, the lock is released also by
   <span class="function"><a href="function.fclose.html" class="function">fclose()</a></span> (which is also called automatically when script
   finished).
  </p>
  <p class="para">
   PHP supports a portable way of locking complete files in an advisory way
   (which means all accessing programs have to use the same way of locking
   or it will not work). By default, this function will block until the
   requested lock is acquired; this may be controlled (on non-Windows
   platforms) with the <b><tt>LOCK_NB</tt></b> option documented below.
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-function.flock-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><i><tt class="parameter">handle</tt></i></span>
     <dd>

      <p class="para">A file system pointer <span class="type"><a href="language.types.resource.html" class="type resource">resource</a></span>
that is typically created using <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>.</p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">operation</tt></i></span>
     <dd>

      <p class="para">
       <i><tt class="parameter">operation</tt></i> is one of the following:
       <ul class="itemizedlist">
        <li class="listitem">
         <span class="simpara">
          <b><tt>LOCK_SH</tt></b> to acquire a shared lock (reader).
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <b><tt>LOCK_EX</tt></b> to acquire an exclusive lock (writer).
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <b><tt>LOCK_UN</tt></b> to release a lock (shared or exclusive).
         </span>
        </li>
       </ul>
      </p>
      <p class="para">
       It is also possible to add <b><tt>LOCK_NB</tt></b> as a bitmask to one 
       of the above operations if you don&#039;t want <span class="function"><b>flock()</b></span> to 
       block while locking. (not supported on Windows)
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><i><tt class="parameter">wouldblock</tt></i></span>
     <dd>

      <p class="para">
       The optional third argument is set to <b><tt>TRUE</tt></b> if the lock would block
       (EWOULDBLOCK errno condition). (not supported on Windows)
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>

 
 <div class="refsect1 returnvalues" id="refsect1-function.flock-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <b><tt>TRUE</tt></b> on success or <b><tt>FALSE</tt></b> on failure.
  </p>
 </div>

 
 <div class="refsect1 changelog" id="refsect1-function.flock-changelog">
  <h3 class="title">Changelog</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead valign="middle">
      <tr valign="middle">
       <th>Version</th>
       <th>Description</th>
      </tr>

     </thead>

     <tbody valign="middle" class="tbody">
      <tr valign="middle">
       <td align="left">5.3.2</td>
       <td align="left">
        The automatic unlocking when the file&#039;s resource handle is closed was
        removed. Unlocking now always has to be done manually.
       </td>
      </tr>

      <tr valign="middle">
       <td align="left">4.0.1</td>
       <td align="left">
        The <i>LOCK_XXX</i> constants were added. Prior to that
        you must use 1 for <b><tt>LOCK_SH</tt></b>, 2 for
        <b><tt>LOCK_EX</tt></b>, 3 for <b><tt>LOCK_UN</tt></b> and
        4 for <b><tt>LOCK_NB</tt></b>
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>

 
 <div class="refsect1 examples" id="refsect1-function.flock-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   <div class="example" id="example-2178">
    <p><b>Example #1 <span class="function"><b>flock()</b></span> example</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/tmp/lock.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"r+"</span><span style="color: #007700">);<br /><br />if&nbsp;(</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_EX</span><span style="color: #007700">))&nbsp;{&nbsp;</span><span style="color: #FF8000">//&nbsp;do&nbsp;an&nbsp;exclusive&nbsp;lock<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">ftruncate</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;truncate&nbsp;file<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"Write&nbsp;something&nbsp;here\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_UN</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//&nbsp;release&nbsp;the&nbsp;lock<br /></span><span style="color: #007700">}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Couldn't&nbsp;get&nbsp;the&nbsp;lock!"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   <div class="example" id="example-2179">
    <p><b>Example #2 <span class="function"><b>flock()</b></span> using the <b><tt>LOCK_NB</tt></b> option</b></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp/lock.txt'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'r+'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;Activate&nbsp;the&nbsp;LOCK_NB&nbsp;option&nbsp;on&nbsp;an&nbsp;LOCK_EX&nbsp;operation&nbsp;*/<br /></span><span style="color: #007700">if(!</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_EX&nbsp;</span><span style="color: #007700">|&nbsp;</span><span style="color: #0000BB">LOCK_NB</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'Unable&nbsp;to&nbsp;obtain&nbsp;lock'</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;exit(-</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;...&nbsp;*/<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 
 <div class="refsect1 notes" id="refsect1-function.flock-notes">
  <h3 class="title">Notes</h3>
  <blockquote class="note"><p><b class="note">Note</b>: 
   <p class="para">
    <span class="function"><b>flock()</b></span> uses mandatory locking instead of advisory
    locking on Windows. Mandatory locking is also supported on Linux and
    System V based operating systems via the usual mechanism supported by the
    fcntl() system call: that is, if the file in question has the setgid
    permission bit set and the group execution bit cleared. On Linux, the file
    system will also need to be mounted with the mand option for this to work.
   </p>
  </p></blockquote>
  <blockquote class="note"><p><b class="note">Note</b>: 
   <p class="para">
    Because <span class="function"><b>flock()</b></span> requires a file pointer, you may have
    to use a special lock file to protect access to a file that you intend
    to truncate by opening it in write mode (with a &quot;w&quot; or &quot;w+&quot; argument to
    <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>).
   </p>
  </p></blockquote>
  <blockquote class="note"><p><b class="note">Note</b>: 
   <p class="para">
    May only be used on file pointers returned by <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>
    for local files, or file pointers pointing to userspace streams that
    implement the <span class="function"><a href="streamwrapper.stream-lock.html" class="function">streamWrapper::stream_lock()</a></span> method.
   </p>
  </p></blockquote>
  <div class="warning"><b class="warning">Warning</b>
   <p class="para">
    Assigning another value to <i><tt class="parameter">handle</tt></i> argument in
    subsequent code will release the lock.
   </p>
  </div>
  <div class="warning"><b class="warning">Warning</b>
   <p class="para">
    On some operating systems <span class="function"><b>flock()</b></span> is implemented at
    the process level. When using a multithreaded server API like ISAPI you
    may not be able to rely on <span class="function"><b>flock()</b></span> to protect files
    against other PHP scripts running in parallel threads of the same server
    instance!
   </p>
   <p class="para">
    <span class="function"><b>flock()</b></span> is not supported on antiquated filesystems like
    <i>FAT</i> and its derivates and will therefore always
    return <b><tt>FALSE</tt></b> under this environments (this is especially true for
    Windows 98 users).
   </p>
  </div>
 </div>

 
</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="105879""></a>
  <div class="note">
   <strong class="user">mdessaintes at gmail dot com</strong>
   <a href="#105879" class="date">22-Sep-2011 08:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I just spend a long time to understand why write function returns me "0", on a basic file opening and then writing.<br />
<br />
I discovered that if you use LOCK_SH and then you write something, that will not work :<br />
<br />
<span class="default">&lt;?php<br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);<br />
<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">);<br />
<br />
</span><span class="default">$written </span><span class="keyword">= </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'data'</span><span class="keyword">);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$written</span><span class="keyword">); </span><span class="comment">// 0 and file is not changed<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101701""></a>
  <div class="note">
   <strong class="user">Evan Battaglia</strong>
   <a href="#101701" class="date">05-Jan-2011 05:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
LOCK_NB seems to be checked and works fine in Windows, too, in PHP 5.3.3.<br />
<br />
For instance, try concurrently running two instances of the following script (via the CLI). The second prints "Didn't quite get the lock..." as expected, whereas w/o the LOCK_NB flag, it just hangs.<br />
<br />
<span class="default">&lt;?php<br />
$x </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"flocktest.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"No problems, I got the lock, now I'm going to sit on it."</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"Didn't quite get the lock. Quitting now. Good night."</span><span class="keyword">;<br />
}<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101226""></a>
  <div class="note">
   <strong class="user">holdoffhunger at gmail dot com</strong>
   <a href="#101226" class="date">03-Dec-2010 07:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've been having trouble getting Flock to work when I read a file, delete it, and then output slightly changed information back to the same location.&nbsp; When deleting with Unlink, there's a very brief period of time where no file exists.&nbsp; But, if you do an fopen using the "w" mode, it keeps the file in existence, but deletes all of its data when you go to write to it.&nbsp; That way, the file never actually disappears, and another script accessing the same file with flock won't get a "file doesn't exist" error.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="100864""></a>
  <div class="note">
   <strong class="user">webmaster at bitpush dot com</strong>
   <a href="#100864" class="date">11-Nov-2010 08:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Regarding the change in PHP 5.3.2 with locked files:<br />
<br />
Without having studied the PHP source code in detail, the situation appears to be as follows when the PHP function fclose() is called:<br />
<br />
Before 5.3.2 PHP would check if the file was locked, then release the lock, and then close the file.<br />
<br />
From 5.3.2 PHP just closes the file.<br />
<br />
But note, that the operating system releases the lock automatically when the file is closed. Therefore a call to fclose() STILL releases the lock (this is tested with PHP 5.3.2, Linux, x64).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99931""></a>
  <div class="note">
   <strong class="user">mirco dot babin at gmail dot com</strong>
   <a href="#99931" class="date">15-Sep-2010 10:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Because:<br />
1) flock() is not safe if multiple php sessions are simultaneously locking.<br />
2) fopen( , 'a') is not safe if multiple php sessions are simultaneously appending.<br />
3) usleep and sleep are known for having problems.<br />
<br />
I wrote the Weblog function, it's purpose is to append a line to logging. This function handles the concurrency as follows:<br />
- Try to create a lockfile named: $directory . date('Ymd') . $logfile . 1 . lock<br />
- If this fails, try to create lockfile named: $directory . date('Ymd') . $logfile . 2 . lock<br />
- etc. After 100 tries return false.<br />
<br />
- When the lockfile is acquired the file named: $directory.date('Ymd').$logfile.1 (or .2 or .3 or .25) is opened or created.<br />
- If created the a "extended log file" header is written.<br />
- Write out the line.<br />
- Close the flie and if created set the correct access rights. (I had some problems creating files on a webserver, I did not see them when I opened a FTP session to the webdirectory. The chmod did the trick for me).<br />
<br />
- Remove the lockfile.<br />
<br />
There is only one drawback, multiple logfiles are created.<br />
e.g. (executed on 15 september 2010)<br />
&nbsp;&nbsp;&nbsp; Weblog('./' , 'visit', 'Somebody requested the index page');<br />
Could lead to 100 files, depending how many concurrent php sessions are simultaneously trying to append a logline:<br />
./20100915visit.1<br />
./20100915visit.2 <br />
./20100915visit.3<br />
./20100915visit.4<br />
...<br />
./20100915visit.100<br />
<br />
This function is donated to the public domain. Maybe you can give me some credit by leaving in the author comment, but it is not required. You may modify this as you wish.<br />
(This function was inspired by the function m_lock_file presented by Kuzma dot Deretuke at gmail dot com)<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">Weblog</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">, </span><span class="default">$logfile</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Created 15 september 2010: Mirco Babin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$curtime </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$logfile </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Ymd'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="default">$logfile</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if (!isset(</span><span class="default">$directory</span><span class="keyword">) || </span><span class="default">$directory </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$directory </span><span class="keyword">= </span><span class="string">'./'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">,-</span><span class="default">1</span><span class="keyword">) !== </span><span class="string">'/'</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$directory </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="string">'/'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while(</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$logfilename </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="default">$logfile </span><span class="keyword">. </span><span class="string">'.' </span><span class="keyword">. </span><span class="default">$count</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockfile </span><span class="keyword">= </span><span class="default">$logfilename </span><span class="keyword">. </span><span class="string">'.lock'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockhandle </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">)) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$lockhandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$lockhandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">) break;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$count</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$count </span><span class="keyword">&gt; </span><span class="default">100</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$created&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'ab'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$created </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="string">'#version: 1.0' </span><span class="keyword">. </span><span class="string">"\r\n" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">'#Fields: date time c-ip x-msg' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Y-m-d'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">. <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">date</span><span class="keyword">(</span><span class="string">'H:i:s'</span><span class="keyword">, </span><span class="default">$curtime</span><span class="keyword">) .&nbsp; </span><span class="string">"\t" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; (isset(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">]) ? </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">] : </span><span class="string">'-'</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">'"' </span><span class="keyword">. </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">'"'</span><span class="keyword">, </span><span class="string">'""'</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">) . </span><span class="string">'"' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$created</span><span class="keyword">) </span><span class="default">chmod</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">,</span><span class="default">0644</span><span class="keyword">); </span><span class="comment">// Read and write for owner, read for everybody else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$lockhandle</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95257""></a>
  <div class="note">
   <strong class="user">dejangex at yahoo dot com</strong>
   <a href="#95257" class="date">21-Dec-2009 01:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Actually, there is no use of the while loop with the usleep. My testing has revealed the following:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//some code here<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) </span><span class="comment">// &lt;- Your code will pause here untill you get the lock for indefinite amount of time or till your script times out<br />
//some code here<br />
</span><span class="default">?&gt;<br />
</span><br />
This will actually check for the lock without pausing and then it will sleep:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//code here<br />
</span><span class="keyword">while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)) {<br />
&nbsp;</span><span class="comment">//Lock not acquired, try again in:<br />
&nbsp;</span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">)*</span><span class="default">1000</span><span class="keyword">)) </span><span class="comment">//0-100 miliseconds<br />
</span><span class="keyword">}<br />
</span><span class="comment">//lock acquired<br />
//rest of the code<br />
</span><span class="default">?&gt;<br />
</span><br />
The problem is, if you have a busy site and a lots of locking, the while loop may not acquire the lock for some time. Locking without LOCK_NB is much more persistent and it will wait for the lock for as long as it takes. It is almose guaranteed that the file will be locked, unless the script times out or something.<br />
<br />
Consider these two scripts: 1st one is ran, and the second one is ran 5 seconds after the first.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//1st script<br />
</span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">); </span><span class="comment">//sleep 10 seconds<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br />
</span><span class="default">?&gt;<br />
</span><br />
<span class="default">&lt;?php<br />
</span><span class="comment">//2nd script<br />
</span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br />
</span><span class="default">?&gt;<br />
</span><br />
If you run 1st and then the 2nd script,the 2nd script will wait untill the 1st has finished. As soon as the first script finishes, the second one will acquire the lock and finish the execution. If you use flock($file_handle, LOCK_EX | LOCK_NB) in the 2nd script while the 1st script is running, it would finish execution immediately and you would not get the lock.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93400""></a>
  <div class="note">
   <strong class="user">daniel AT brightbyte DOT de</strong>
   <a href="#93400" class="date">08-Sep-2009 12:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
flock on Solaris is slightly strange: it will fail if you try to get an exclusive lock on a file not opened for writing. That is, for reading files, you MUST use a shared lock. From the Solaris man page for flock:<br />
<br />
"Read permission is required on a file to obtain a shared lock, and write&nbsp; permission is required to obtain an exclusive lock."<br />
<br />
In contrast, this is from the Linux man page for flock:<br />
<br />
"The mode used to open the file doesn’t matter to flock."<br />
<br />
So, beware...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="92731""></a>
  <div class="note">
   <strong class="user">Kuzma dot Deretuke at gmail dot com</strong>
   <a href="#92731" class="date">06-Aug-2009 04:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I use exclusive writing to replace standard flock():<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// get/set lock file name<br />
</span><span class="keyword">function </span><span class="default">m_lock_file</span><span class="keyword">( </span><span class="default">$format </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; static </span><span class="default">$file_format </span><span class="keyword">= </span><span class="string">'./%s.lock'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$format </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$file_format </span><span class="keyword">= </span><span class="default">$format</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$file_format</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// acquire/check/release lock<br />
</span><span class="keyword">function </span><span class="default">m_lock</span><span class="keyword">( </span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">$acquire </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; static </span><span class="default">$handlers </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">is_bool</span><span class="keyword">(</span><span class="default">$acquire</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$file </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">m_lock_file</span><span class="keyword">(), </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">), </span><span class="default">$lockId</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already unlocked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$handler </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; do {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$handler </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">, </span><span class="string">"x"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">10000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">] = </span><span class="default">$handler</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } while (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler </span><span class="keyword">&amp;&amp; </span><span class="default">$count</span><span class="keyword">-- &gt; </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already locked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Usage sample:<br />
<br />
<span class="default">&lt;?php<br />
$lockId </span><span class="keyword">= </span><span class="string">"qq"</span><span class="keyword">;<br />
<br />
</span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
if (</span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"locked"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// here you can perform any thread-safe operations<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">300 </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"not locked"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90547""></a>
  <div class="note">
   <strong class="user">jbatka01 at gmail dot com</strong>
   <a href="#90547" class="date">27-Apr-2009 01:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those who just want to check if a file is available for locking and return immediately (without blocking), use the following syntax:<br />
<br />
<span class="default">&lt;?php<br />
$file </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.txt'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">);<br />
<br />
if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)){<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'Got lock, continue writing to file'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Code to write to file<br />
</span><span class="keyword">}else{<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'File is locked by another process, aborting writing'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Couldn't obtain the lock immediately<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;<br />
</span><br />
This is a quick, easy way to determine if another process is using the file or not, without blocking your script.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88907""></a>
  <div class="note">
   <strong class="user">Fernando Gabrieli fgabrieli at gmail</strong>
   <a href="#88907" class="date">12-Feb-2009 11:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When writing to a file, you should avoid using w+ because it would erase the contents of the file before locking<br />
<br />
If you need to write the complete file again you could use the following instead:<br />
<br />
<span class="default">&lt;?php<br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'yourfile.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">) ;<br />
<br />
if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">) ; </span><span class="comment">// &lt;-- this will erase the contents such as 'w+'<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'test string'</span><span class="keyword">) ;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">) ;<br />
}<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) ;<br />
</span><span class="default">?&gt;<br />
</span><br />
Best,<br />
Fernando Gabrieli</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87433""></a>
  <div class="note">
   <strong class="user">yesmarklapointe at hotmail dot com</strong>
   <a href="#87433" class="date">04-Dec-2008 04:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Perhaps not what you are looking for, but seems to me that&nbsp; to avoid a race condition you have to end the race, that is, stop allowing multi-threaded or parallel processes to do the file manipulation part of the overall application. Put the data outside the competing scripts and let a separate process handle the transfer or replacement or storage in a deterministic way … if you can wait that long for it. For example,&nbsp; why not have a chron job process temporary files in a special directory, making their individual changes to the ‘real’ file based on something simple like which one is stored first in this special directory. All of your scripts have to put their file change requests into this directory by a sufficiently random naming scheme … but maintaining an incremental aspect to the naming so they are in order for processing. In this example, besides the chron job, no other script should have more than read access to the real file.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="87181""></a>
  <div class="note">
   <strong class="user">administrator at proxy-list dot org</strong>
   <a href="#87181" class="date">23-Nov-2008 02:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello,<br />
<br />
There is couple of reasons why EVERY software developer should avoid its usage if it is possible. My own server was crashed couple of times because of flock (including hours of down time). So you have to think twice before you will decide to use it.<br />
<br />
After a while I have found the problematic situations. For my surprise it was not just badly written PHP scripts, it was some unclear bugs in FreeBSD. In some case, when more than 20 requests per second try to do exclusive flock on the same file, the scripts stuck ;) and they were using 100% of CPU (only Apache’s reboot or manual kill could stop them). <br />
<br />
Soon after I have found nice solution (thanks arne at bukkie dot nl for good suggestion). I want to share it with you:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// waiting until file will be locked for writing (1000 milliseconds as timeout)<br />
</span><span class="keyword">if (</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$fileName</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">)) {<br />
&nbsp; </span><span class="default">$startTime </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">();<br />
&nbsp; do {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$canWrite </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// If lock not obtained sleep for 0 - 100 milliseconds, to avoid collision and CPU load<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(!</span><span class="default">$canWrite</span><span class="keyword">) </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">)*</span><span class="default">1000</span><span class="keyword">));<br />
&nbsp; } while ((!</span><span class="default">$canWrite</span><span class="keyword">)and((</span><span class="default">microtime</span><span class="keyword">()-</span><span class="default">$startTime</span><span class="keyword">) &lt; </span><span class="default">1000</span><span class="keyword">));<br />
<br />
&nbsp; </span><span class="comment">//file was locked so now we can store information<br />
&nbsp; </span><span class="keyword">if (</span><span class="default">$canWrite</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$dataToSave</span><span class="keyword">);<br />
&nbsp; }<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
}</span><span class="default">?&gt;<br />
</span><br />
I have added simple timeout value for flock. Case flock was not obtained within N seconds - writing will be skipped, instead of waiting and causing server’s high CPU load.<br />
<br />
With best regards<br />
<br />
Owner of <a href="http://proxy-list.org" rel="nofollow" target="_blank">http://proxy-list.org</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84824""></a>
  <div class="note">
   <strong class="user">tinymountain at nospam dot gmail dot com</strong>
   <a href="#84824" class="date">31-Jul-2008 01:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a handy class to allow retrying a write with flock a set number of times. If it can't flock, it will sleep for a brief random interval and try again. If you have a lot of concurrent writes going on, you can use it to avoid data corruption.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">SafeWriter<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// suggested mode 'a' for writing to the end of the file<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public static function </span><span class="default">writeData</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retries </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$max_retries </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$fp</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// failure<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// keep trying to get a lock as long as possible<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">do {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$retries </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">10000</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retries </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) and </span><span class="default">$retries </span><span class="keyword">&lt;= </span><span class="default">$max_retries</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// couldn't get the lock, give up<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$retries </span><span class="keyword">== </span><span class="default">$max_retries</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// failure<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// got the lock, write the data<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"</span><span class="default">$data</span><span class="string">\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// release the lock<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// success<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82521""></a>
  <div class="note">
   <strong class="user">John dot wellesz at teaser dot fr</strong>
   <a href="#82521" class="date">14-Apr-2008 05:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I just want to add a note about making atomic lock on NFS, there is only two<br />
ways:<br />
<br />
- 1 (the most robust but the most complicate) - It's to use link() to create a<br />
&nbsp; hard link to a file you want to lock (on the same FS of course).<br />
&nbsp; (On most NFS implementations, Link() is atomic)<br />
<br />
Once you created a hard link (not a symbolic link), with a unique randomly<br />
generated name, call stat() on it and count the number of link (nlink), if there<br />
is only 2 then the file is locked.<br />
<br />
If there is more than two you have to unlink() the link you just created and<br />
create a new one with a new unique name (else NFS will use its cache and stat<br />
will return wrong data) then call stat() on the new link and test the number of<br />
links again, repeat this operation until you get the lock.<br />
<br />
You have to use usleep() between the link() attempts with a fixed + random<br />
sleep value to avoid dead lock situations (link() and unlink() may be atomic<br />
but not instantaneous)<br />
<br />
Also note than when you unlink a file through NFS, if NFS think that the file<br />
is still in use, it will create a .nfs link to this file until it realizes the<br />
file is no longer in use... A wrong timing could generate thousands of those<br />
files and a deadlock situation.&nbsp; Because of this when a deadlock situation<br />
occurs or if your stat() command returns a very high number of links, you have<br />
to look for .nfs file in the same directory you created your links and unlink<br />
all the .nfs file you find (sometimes NFS take its time to remove them)<br />
<br />
- 2 (the simplest) - the second method is to use a lock server and lock daemons<br />
&nbsp; on each client that will forward lock request to the server... (this is more<br />
dangerous than the first method because the daemons may be killed...)<br />
<br />
Here is for reference the function I created to make atomic locks through NFS<br />
(this function is in production since at least 4 years now), it's just for<br />
reference because it uses many external functions to do its job but you can see<br />
the principle:<br />
<br />
<a href="http://pastey.net/85793" rel="nofollow" target="_blank">http://pastey.net/85793</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80006""></a>
  <div class="note">
   <strong class="user">admin ifyouwantblood de</strong>
   <a href="#80006" class="date">23-Dec-2007 07:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
besides from what the manual says about locking a file opendend in w or w+ and using a special lock file for these cases, you should simply truncate the file yourself with ftruncate() after writing:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$data</span><span class="keyword">=</span><span class="string">'some data'</span><span class="keyword">;<br />
</span><span class="default">$handle</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file'</span><span class="keyword">,</span><span class="string">'r+'</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">ftell</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">));<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
now the file will have the size of $data without opening the file in w mode but with a lock on the file.<br />
<br />
to the previous writers jpriebe and mallory:<br />
of course the lock is lost in this case, but thats simply because the file is closed by PHP. and closing the file means unlocking it (same as when you use fclose() yourself).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79913""></a>
  <div class="note">
   <strong class="user">mallory dot dessaintes at gmail dot com</strong>
   <a href="#79913" class="date">19-Dec-2007 07:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have noticed that if you change the value of your fopen ressource, the lock is working no longer..<br />
<br />
<span class="default">&lt;?php<br />
<br />
$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'lockfile.txt'</span><span class="keyword">,</span><span class="string">'a'</span><span class="keyword">);<br />
<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br />
<br />
</span><span class="default">$fo </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Lock is disable<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79668""></a>
  <div class="note">
   <strong class="user">candide at idees-et-solutions dot fr</strong>
   <a href="#79668" class="date">07-Dec-2007 03:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a comment about the last method to lock files using filemtime().<br />
What if&nbsp;&nbsp; filemtime($fp[1]) == $fp[3]&nbsp;&nbsp; because somebody modified the file less than 1s after the value of $fp[3] was picked up?<br />
Then this modification will be lost...? <br />
<br />
This system to lock files is made to prevent problems when two modifications are so close that they can interfere, so the case "less than 1s" will often happen?<br />
<br />
However, lose some modifications is better than spoil all the file...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78320""></a>
  <div class="note">
   <strong class="user">Antti Haapala</strong>
   <a href="#78320" class="date">06-Oct-2007 04:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Further information on flock: The system is not restarted if a signal is delivered to the process, so flock will happily return false in case of SIGALRM, SIGFPE or something else.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="78318""></a>
  <div class="note">
   <strong class="user">Antti Haapala</strong>
   <a href="#78318" class="date">06-Oct-2007 03:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The supplied documentation is vague, ambiguous and lacking, and the user comments contain erroneous information! The flock function follows the semantics of the Unix system call bearing the same name. Flock utilizes ADVISORY locking only; that is, other processes may ignore the lock completely; it only affects those that call the flock call.<br />
<br />
LOCK_SH means SHARED LOCK. Any number of processes MAY HAVE A SHARED LOCK simultaneously. It is commonly called a reader lock.<br />
<br />
LOCK_EX means EXCLUSIVE LOCK. Only a single process may possess an exclusive lock to a given file at a time.<br />
<br />
If the file has been LOCKED with LOCK_SH in another process, flock with LOCK_SH will SUCCEED. flock with LOCK_EX will BLOCK UNTIL ALL READER LOCKS HAVE BEEN RELEASED.<br />
<br />
If the file has been locked with LOCK_EX in another process, the CALL WILL BLOCK UNTIL ALL OTHER LOCKS have been released.<br />
<br />
If however, you call flock on a file on which you possess the lock, it will try to change it. So: flock(LOCK_EX) followed by flock(LOCK_SH) will get you a SHARED lock, not "read-write" lock.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74829""></a>
  <div class="note">
   <strong class="user">administrator at proxy-list dot org</strong>
   <a href="#74829" class="date">29-Apr-2007 05:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello,<br />
<br />
I want to give an example how to lock file with two or more flags (for example reading and writing). IMPORTANT: each locking should be done separately, the correct way of using flock() is:<br />
<br />
<span class="default">&lt;?php<br />
flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
and NOT like these:<br />
<br />
<span class="default">&lt;?php<br />
flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">and </span><span class="default">LOCK_SH</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">or </span><span class="default">LOCK_SH</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">+ </span><span class="default">LOCK_SH</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Furthermore if someone has not pay attention to function’s description - flock does not lock any file in the right way. The file is still accessible for reading/writing, in other words these functions: file(), file_get_contents() and even fopen($file, ‘r’) will ignore the lock.<br />
<br />
I think PHP mechanism works something like this: as soon as file lock was successful, the function flock() writes somewhere (in its own “DB” for example) that file handle is locked with some flag and nothing more. It is up to the developer to check if file is locked or not before doing any operations.<br />
<br />
Hope this post makes clear the flock() function’s working principles.<br />
<br />
Regards<br />
<br />
Vitali Simsive<br />
<br />
==<br />
<br />
During test I have discovered that if you have locked file for writing (LOCK_EX) both read and write will not be accessible from other scripts. In case of read locking (LOCK_SH) only writing will not be accessible for other PHP scripts but they will be able to read file simultaneously.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74391""></a>
  <div class="note">
   <strong class="user">LemonJuice</strong>
   <a href="#74391" class="date">09-Apr-2007 12:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hi,<br />
<br />
The discussions below address flock() in the context of managing integrity of file contents as well as the context of using flock() in combination with a dummy file to generally establish agreement on the access state of some other object. The following addresses the latter.<br />
<br />
I use this as a replacement for LOCK TABLES because during some transactional update statements I require the contents of other tables to freeze and transactions and tablelocks don't mix in mySQL / InnoDB.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">ReadWriteLock<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; const </span><span class="default">LOCK_PATH </span><span class="keyword">= </span><span class="string">"locks"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">Aquire</span><span class="keyword">(</span><span class="default">$ID</span><span class="keyword">, </span><span class="default">$LockType </span><span class="keyword">= </span><span class="default">LOCK_SH</span><span class="keyword">, </span><span class="default">$WouldBlock </span><span class="keyword">= </span><span class="default">TRUE</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Make sure the file exists and we have it opened.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // We don't care about writing to the file. We just need a file reference that flock() can work on.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // Also, on an OS level all thread's are sharing this file. We don't do access control in relation to this file.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // So let's assume first that it already exists.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$FileName </span><span class="keyword">= </span><span class="default">self</span><span class="keyword">::</span><span class="default">LOCK_PATH</span><span class="keyword">.</span><span class="string">"/lock_</span><span class="default">$ID</span><span class="string">.lck"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if((</span><span class="default">$Resource </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$FileName</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">)) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Ok, so this is the first time a thread acquires a lock to this $ID. Let's create the file.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if((</span><span class="default">$Resource </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$FileName</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Ok, perhaps some thread created it between the two ifs. This class does not delete the file so it should now be there.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if((</span><span class="default">$Resource </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$FileName</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">)) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// #REF 1<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Ok, it exists now. Just for solidarity and prevention of whatever OS hickups we can possibly have<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // I want this thread to open it in r mode too.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Resource</span><span class="keyword">) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if((</span><span class="default">$Resource </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$FileName</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">)) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// And this is really where the locking takes place.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$Resource</span><span class="keyword">, </span><span class="default">$LockType</span><span class="keyword">, </span><span class="default">$WouldBlock</span><span class="keyword">)) return </span><span class="default">$Resource</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Resource</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public static function </span><span class="default">Release</span><span class="keyword">(</span><span class="default">$Resource</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Resource</span><span class="keyword">)) return </span><span class="default">TRUE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="comment">// Entering critical section<br />
</span><span class="keyword">if((</span><span class="default">$Lock </span><span class="keyword">= </span><span class="default">ReadWriteLock</span><span class="keyword">::</span><span class="default">Acquire</span><span class="keyword">(</span><span class="string">"metadata"</span><span class="keyword">)) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Failed to either create or acquire the lock."</span><span class="keyword">)<br />
<br />
</span><span class="comment">// Construct SQL statements from meta tables<br />
// Execute constructed SQL statements agains data tables<br />
<br />
// Leaving critical section<br />
</span><span class="keyword">if((</span><span class="default">ReadWriteLock</span><span class="keyword">::</span><span class="default">Release</span><span class="keyword">(</span><span class="default">$Lock</span><span class="keyword">)) === </span><span class="default">FALSE</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">"Failed to release the lock."</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
A few notes about this:<br />
<br />
- As you can see, this just creates 'a' file to use as a reference for flock() to work on. My assumption here is that the operating system uses semaphores internally to implement Flock(). Of that, I am not sure however and I would appreciate any validation from an expert.<br />
<br />
- The problem of the existence of the lockfile is solved by simply not deleting them. Given that they are all 0-byte files in a specified folder and that they are only of a limited amount makes it something that works for my solution. Alternatively you could touch() the lockfile upon a succesful flock() and use a cron job to delete any files that have not been touched since, say, a day (or at least for the duration of the session timeout setting of your webserver). That would introduce a race condition for access on the actual file though which I prefer to exclude from the above.<br />
<br />
- flock() implements a low priority exclusive lock. This means that once the resource is locked in a shared mode, exclusive locks may be delayed indefinately if (and only if) a continuous abundance of shared lock requests come in so that every thread releases his shared lock after another thread has already gained shared access. For me, this is an ussue and I would appreciate any references to establish a high priority exclusive lock.<br />
<br />
Good luck,<br />
<br />
Juice<br />
...Tastes like more!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74155""></a>
  <div class="note">
   <strong class="user">Will Reiher</strong>
   <a href="#74155" class="date">27-Mar-2007 04:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've been testing a few custom file access functions but I always liked the simplicity of file_get_contents(). Of course it doesn't seem to respect any file locks created with flock(). I created the function below to wrap around file_get_contents() so it can support locked files. It's an odd way of doing it but it works for me.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">flock_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">){<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return </span><span class="keyword">= </span><span class="default">FALSE</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">is_string</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">) &amp;&amp; !empty(</span><span class="default">$filename</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_readable</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$handle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">$return</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$return </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$return</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72668""></a>
  <div class="note">
   <strong class="user">korostel at newmail dot ru</strong>
   <a href="#72668" class="date">29-Jan-2007 03:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In order to prevent access to some counter file we can use another file as a flag instead of flock().<br />
We change flag's file mode to '400' each time we want to change the counter, and set it back to '600' at the end.<br />
If the mode of the flag's file was already changed by another process, we make delayed loop till its mode is set to writable again.<br />
The page is refreshing every second so the results can be seen by opening it in two or three browser windows. I tested the script meny times and still my counter is safe.<br />
Hope this will help.<br />
--------------START------------------<br />
<span class="default">&lt;?php<br />
header</span><span class="keyword">(</span><span class="string">"Expires: Mon, 26 Jul 1997 05:00:00 GMT"</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Cache-Control: no-cache, must-revalidate"</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Pragma: no-cache"</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Last-Modified: "</span><span class="keyword">.</span><span class="default">Date</span><span class="keyword">(</span><span class="string">"D, d M Y H:i:s"</span><span class="keyword">).</span><span class="string">" GMT"</span><span class="keyword">);<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="string">'COUNT_FILE'</span><span class="keyword">,</span><span class="string">'count.txt'</span><span class="keyword">); </span><span class="comment">//Our counter file<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="string">'LOCK_FILE'</span><span class="keyword">,</span><span class="string">'lock.txt'</span><span class="keyword">); </span><span class="comment">//Our lock file.<br />
<br />
</span><span class="keyword">function </span><span class="default">read_write </span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//making our lock file nonwritable<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">chmod</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">, </span><span class="default">0400</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//reading<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">clearstatcache</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$fpr </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">COUNT_FILE</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count</span><span class="keyword">=</span><span class="default">fread </span><span class="keyword">(</span><span class="default">$fpr</span><span class="keyword">, </span><span class="default">filesize </span><span class="keyword">(</span><span class="default">COUNT_FILE</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$count</span><span class="keyword">++;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//writing<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$fpw </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">COUNT_FILE</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fpw</span><span class="keyword">,</span><span class="default">$count</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpw</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//pause the script just to see how it works<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//making our lock file writable again<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">chmod</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">, </span><span class="default">0600</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$count</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>&lt;!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"&gt;<br />
&lt;html&gt;&lt;head&gt;&lt;title&gt;Untitled&lt;/title&gt;&lt;meta http-equiv="Refresh" content="1"&gt;&lt;/head&gt;&lt;body&gt;<br />
<span class="default">&lt;?php<br />
clearstatcache</span><span class="keyword">();<br />
</span><span class="comment">//Check the mode of our lock file<br />
</span><span class="keyword">if(</span><span class="default">is_writable</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">'is unlocked &lt;br&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//make changes and show the results<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">print </span><span class="string">'changed to '</span><span class="keyword">.</span><span class="default">read_write</span><span class="keyword">().</span><span class="string">'&lt;br&gt;'</span><span class="keyword">;<br />
}else{<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">'is locked: '</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//make loop<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">while(!</span><span class="default">is_writable</span><span class="keyword">(</span><span class="default">LOCK_FILE</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">'pause... '</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">,</span><span class="default">999</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//make changes and show the results<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">print </span><span class="string">'&lt;br&gt;changed at last to '</span><span class="keyword">.</span><span class="default">read_write</span><span class="keyword">().</span><span class="string">'&lt;br&gt;'</span><span class="keyword">;<br />
}</span><span class="default">?&gt;<br />
</span>&lt;/body&gt;&lt;/html&gt;<br />
--------------END------------------</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68875""></a>
  <div class="note">
   <strong class="user">jerry at gh33 dot org</strong>
   <a href="#68875" class="date">14-Aug-2006 09:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Indeed, flock() will not work reliably when the underlying filesystem is NFS. The proper way to perform file locking, in this case, would be to use PHP's link() function. From the Linux man page of open():<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; O_EXCL When used with O_CREAT, if the file&nbsp; already&nbsp; exists&nbsp; it&nbsp; is&nbsp; an<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; error&nbsp; and&nbsp; the open will fail. In this context, a symbolic link<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exists, regardless of where its points to.&nbsp; O_EXCL is broken&nbsp; on<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; NFS file systems, programs which rely on it for performing lock-<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ing tasks will contain a race condition.&nbsp; The solution for&nbsp; per-<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; forming&nbsp; atomic&nbsp; file&nbsp; locking&nbsp; using&nbsp; a lockfile is to create a<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unique file on the same fs&nbsp; (e.g.,&nbsp; incorporating&nbsp; hostname&nbsp; and<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; pid),&nbsp; use&nbsp; link(2)&nbsp; to&nbsp; make&nbsp; a link to the lockfile. If link()<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; returns 0, the lock is successful.&nbsp; Otherwise,&nbsp; use&nbsp; stat(2)&nbsp; on<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; the&nbsp; unique&nbsp; file to check if its link count has increased to 2,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; in which case the lock is also successful.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62005""></a>
  <div class="note">
   <strong class="user">dranger AT export dash japan dot com</strong>
   <a href="#62005" class="date">16-Feb-2006 10:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Also note that if you want to truncate a file, but make sure it's locked first, you DON'T need to use a separate lock file like the directions say. Use this instead:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$f</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"file"</span><span class="keyword">, </span><span class="string">"r+"</span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) or die(</span><span class="string">"Error! cant lock!"</span><span class="keyword">);<br />
</span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">, </span><span class="default">$stuff</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
But if you open a file with "w" or "w+" you WILL blow it away before you can lock it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61921""></a>
  <div class="note">
   <strong class="user">marc dot vanwoerkom at fernuni-hagen dot de</strong>
   <a href="#61921" class="date">15-Feb-2006 02:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I ran into a loop because I just checked for true (= you got the lock) as return value of flock() and tried again when I got a false.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">naive_wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));&nbsp; </span><span class="comment"># k * 10ms<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
Unfortunately in one case the $fp I put in was invalid, so I always got false and got stuck.<br />
Lesson: check if your $fp is valid before entering the loop, or look closer if you get a false.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$fp </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));&nbsp; </span><span class="comment"># k * 10ms<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60184""></a>
  <div class="note">
   <strong class="user">administrator at proxy-list dot org</strong>
   <a href="#60184" class="date">28-Dec-2005 08:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello guys,<br />
<br />
I want to shear one good trick, it was no invented by me but it is very useful with flock. This technology was used by team who invent Ethernet as my tutor Pitter Timothy teach me. I want to say thank you.<br />
<br />
If you have a lot of scripts about 1000 which possible try to write something in file you need to lock file before starting writing. So you should use something like this:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logFileName</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$canWrite </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Waiting until file will be locked for writing<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while (!</span><span class="default">$canWrite</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$canWrite </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//file was locked so now we can store information<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$toSave</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
but during testing I have find out what some times script have to many collisions, and during 10 seconds can not write anything. It happened because some scripts try simultaneously. If file was busy they all will wait same time. So I use the same technology like guys who invent first simple Ethernet use in case of package collision. I put random millisecond sleep. You can not imagine but script start working 3 times quicker!<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logFileName</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$canWrite </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Waiting until file will be locked for writing<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while (!</span><span class="default">$canWrite</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$canWrite </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Sleep for 0 - 2000 miliseconds, to avoid colision<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$miliSeconds </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">); </span><span class="comment">//1 u = 100 miliseconds<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$miliSeconds</span><span class="keyword">*</span><span class="default">100000</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//file was locked so now we can store information<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$toSave</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
By the way I have no idea which diapason is better, but 0 - 1000 is not enough.<br />
<br />
Hope it will help somebody<br />
<br />
Best regards in your projects<br />
<br />
Vitali Simsive</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55664""></a>
  <div class="note">
   <strong class="user">damasta at onwebworx dot net</strong>
   <a href="#55664" class="date">09-Aug-2005 08:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
just wanted to say that you will most likely fail if you use a separate lock file together with register_shutdown_function.<br />
<br />
my script did some different actions... resizing pictures, rotating them and this stuff. it needed a "database" file to get the correct file locations. this database file also stored some flags. and of course the script had to save that file when it was done.<br />
<br />
because of my script exited on many different points depending on the action i used register_shutdown_function to save the file. it wanted to use a locking system to be sure the script doesn't overwrite the data another process had written into it some microseconds before. i was running on windows 2000 and apache2 on my developing machine, and flock always returned true for some reason... so i used a separate lock file. the script looked for it at the beginning and exited if it was found. otherwise it created it. but this file had to be deleted at the end. i put the unlink command into the registered shutdown-function but it never deleted the file. i tried clearstatcache and some other stuff but it didn't help.<br />
<br />
maybe this helps someone.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47028""></a>
  <div class="note">
   <strong class="user">pentek_imre at mailbox dot hu</strong>
   <a href="#47028" class="date">31-Oct-2004 03:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
flock isn't good in race conditions. I accept that it can correctly lock file and can correctly block php processes if file is locked, but anyway this function isn't the right way to manage a race condition.<br />
Let's have a look at this code:<br />
<span class="default">&lt;?php<br />
$f</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">,</span><span class="string">"a+"</span><span class="keyword">) or die();<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">) or die();<br />
</span><span class="comment">//here write some lines to the file -- not included<br />
//then close:<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">) or die();<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">) or die();<br />
</span><span class="default">?&gt;<br />
</span>Then generate a race situation with two php processes:<br />
1: open file ok, no file found, create<br />
2: open file ok, file found seek to the end (0lenght file so to the beginning)<br />
1: lock file ok<br />
2: flock waits since file is already locked.<br />
1: write ok<br />
1: unlock ok<br />
2: flock ok this process now continues<br />
1: fclose ok<br />
2: write something, but due to prebuffering the file is now empty, so content written by 1 is now unconsidered, forgotten.<br />
2: unlock ok<br />
2: fclose ok<br />
file will have only the content from process 2<br />
this is the situation if you use r+ too, no matter if you used fflush or not.<br />
conclusion: you may want to create a separate lock file!<br />
separate lock file will behave like in the previous example too, so let's try LOCK_NB and $wouldblock, file close and reopen.<br />
let's see this example:<br />
<span class="default">&lt;?php<br />
$file</span><span class="keyword">=</span><span class="string">"/tmp/phplockfile"</span><span class="keyword">;<br />
do<br />
&nbsp;{<br />
&nbsp; if(isset(</span><span class="default">$f</span><span class="keyword">))<br />
&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">);<br />
&nbsp;&nbsp; }<br />
&nbsp; </span><span class="default">$f</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">,</span><span class="string">"a"</span><span class="keyword">) or die();<br />
&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">+</span><span class="default">LOCK_NB</span><span class="keyword">,</span><span class="default">$W</span><span class="keyword">);<br />
</span><span class="comment">//&nbsp; sleep(1);<br />
&nbsp;</span><span class="keyword">}<br />
while (</span><span class="default">$W</span><span class="keyword">==</span><span class="default">1</span><span class="keyword">);<br />
<br />
</span><span class="comment">//lock is mine:<br />
</span><span class="keyword">echo </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">"UNIQUE_ID"</span><span class="keyword">].</span><span class="string">" "</span><span class="keyword">.</span><span class="default">date</span><span class="keyword">(</span><span class="string">"r"</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
echo </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">"UNIQUE_ID"</span><span class="keyword">].</span><span class="string">" "</span><span class="keyword">.</span><span class="default">date</span><span class="keyword">(</span><span class="string">"r"</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">//release the lock:<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span>I tried this code for 10 (ten) parellel processes. only three of them succeeds to lock the file and unlock it, the other seven quits with execuition timeout. uncommenting the sleep(1); won't help too, just execution will be longer (30 sec is counted not as real time but as cpu time)<br />
I tried random usleep too, as I remember this wasn't helped too.<br />
Remember that file close and reopen is a must becouse processes may write to the file, and this way these extra bytes will be considered too.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46085""></a>
  <div class="note">
   <strong class="user">rehfeld.us</strong>
   <a href="#46085" class="date">28-Sep-2004 04:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/*<br />
&nbsp;* I hope this is usefull. <br />
&nbsp;* If mkdir() is atomic, <br />
&nbsp;* then we do not need to worry about race conditions while trying to make the lockDir,<br />
&nbsp;* unless of course were writing to NFS, for which this function will be useless.<br />
&nbsp;* so thats why i pulled out the usleep(rand()) peice from the last version<br />
&nbsp;*<br />
&nbsp;* Again, its important to tailor some of the parameters to ones indivdual usage<br />
&nbsp;* I set the default $timeLimit to 3/10th's of a second (maximum time allowed to achieve a lock), <br />
&nbsp;* but if your writing some extrememly large files, and/or your server is very slow, you may need to increase it.<br />
&nbsp;* Obviously, the $staleAge of the lock directory will be important to consider as well if the writing operations might take&nbsp; a while.<br />
&nbsp;* My defaults are extrememly general and you're encouraged to set your own<br />
&nbsp;*<br />
&nbsp;* $timeLimit is in microseconds<br />
&nbsp;* $staleAge is in seconds<br />
&nbsp;* <br />
&nbsp;* <br />
&nbsp;*/<br />
<br />
</span><span class="keyword">function </span><span class="default">microtime_float</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp; list(</span><span class="default">$usec</span><span class="keyword">, </span><span class="default">$sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">' '</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; return ((float)</span><span class="default">$usec </span><span class="keyword">+ (float)</span><span class="default">$sec</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">locked_filewrite</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">$timeLimit </span><span class="keyword">= </span><span class="default">300000</span><span class="keyword">, </span><span class="default">$staleAge </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ignore_user_abort</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$lockDir </span><span class="keyword">= </span><span class="default">$filename </span><span class="keyword">. </span><span class="string">'.lock'</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">is_dir</span><span class="keyword">(</span><span class="default">$lockDir</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ((</span><span class="default">time</span><span class="keyword">() - </span><span class="default">filemtime</span><span class="keyword">(</span><span class="default">$lockDir</span><span class="keyword">)) &gt; </span><span class="default">$staleAge</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">rmdir</span><span class="keyword">(</span><span class="default">$lockDir</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$locked </span><span class="keyword">= @</span><span class="default">mkdir</span><span class="keyword">(</span><span class="default">$lockDir</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$locked </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$timeStart </span><span class="keyword">= </span><span class="default">microtime_float</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; do {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ((</span><span class="default">microtime_float</span><span class="keyword">() - </span><span class="default">$timeStart</span><span class="keyword">) &gt; </span><span class="default">$timeLimit</span><span class="keyword">) break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$locked </span><span class="keyword">= @</span><span class="default">mkdir</span><span class="keyword">(</span><span class="default">$lockDir</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } while (</span><span class="default">$locked </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$success </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$locked </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (@</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)) </span><span class="default">$success </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">rmdir</span><span class="keyword">(</span><span class="default">$lockDir</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ignore_user_abort</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$success</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="45464""></a>
  <div class="note">
   <strong class="user">rudy dot metzger at pareto dot nl</strong>
   <a href="#45464" class="date">08-Sep-2004 03:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Like a user already noted, most Linux kernels (at least the Redhat ones) will return false, even if you locked the file. This is because the lock is only ADVISORY (you can check that in /proc/locks). What you have to do there is to evalute the 3rd parameter of flock(), $eWouldBlock. See for an example below. Note however that if you<br />
lock the file in non blocking mode, flock() will work as expected (and blocks the script).<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid"</span><span class="keyword">, </span><span class="string">"a" </span><span class="keyword">);<br />
if ( !</span><span class="default">$fp </span><span class="keyword">|| !</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">,</span><span class="default">$eWouldBlock</span><span class="keyword">) || </span><span class="default">$eWouldBlock </span><span class="keyword">) {<br />
&nbsp; </span><span class="default">fputs</span><span class="keyword">( </span><span class="default">STDERR</span><span class="keyword">, </span><span class="string">"Failed to acquire lock!\n" </span><span class="keyword">);<br />
&nbsp; exit;<br />
}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="comment">// do your work here<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br />
</span><span class="default">unlink</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid" </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43705""></a>
  <div class="note">
   <strong class="user">Joby &lt;god at NOSPAMPLEASE dot greentinted dot net&gt;</strong>
   <a href="#43705" class="date">30-Jun-2004 05:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm thinking that a good way to ensure that no data is lost would be to create a buffer directory that could store the instructions for what is to be written to a file, then whenever the file is decidedly unlocked, a single execution could loop through every file in that directory and apply the indicated changes to the file.<br />
<br />
I'm working on writing this for a flat-file based database.&nbsp; The way it works is, whenever a command is issued (addline, removeline, editline), the command is stored in a flat file stored in a folder named a shortened version of the filename to be edited and named by the time and a random number.&nbsp; In that file is a standardized set of commands that define what is to be done to what file (the likes of "file: SecuraLog/index_uid" new line "editline: 14").<br />
<br />
Each execution will check every folder in that directory for files and a certain amount of time (I don't know how long, maybe 1-2 seconds) is spent making pending changes to unlocked files.&nbsp; This way no changes will be lost (i.e. person 1 makes a change at the same time as person 2, and person 1 loses the race by just enough to have their changed version of the file overwritten by person 2's version) and there will be no problems with opening an empty open file.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="41263""></a>
  <div class="note">
   <strong class="user">m4v3r at o2 dot pl</strong>
   <a href="#41263" class="date">04-Apr-2004 04:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Following is based on below comments. When something goes wrong, script will perform backup of writen data to randomly named file in temp dir.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">safewrite</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rand </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$rand </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$rand</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$temp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"temp/</span><span class="default">$rand</span><span class="string">"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$temp</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$temp</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$otw </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">"a+"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$otw</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$otw</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$otw</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)) </span><span class="default">$err </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$otw</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$otw</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$err </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">$err </span><span class="keyword">== </span><span class="default">1 </span><span class="keyword">|| (</span><span class="default">filesize</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">) == </span><span class="default">0 </span><span class="keyword">&amp;&amp; </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) &lt;&gt; </span><span class="default">0</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"&lt;b&gt;There was an error while writing to </span><span class="default">$filename</span><span class="string">. Contact site administrator!&lt;/b&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">"temp/</span><span class="default">$rand</span><span class="string">"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Hope it helps.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39466""></a>
  <div class="note">
   <strong class="user">Glip</strong>
   <a href="#39466" class="date">29-Jan-2004 10:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you don't want use secondary lock file while truncating, try this:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"a+"</span><span class="keyword">);<br />
<br />
if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) { </span><span class="comment">// do an exclusive lock<br />
&nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"Write something here\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">); </span><span class="comment">// release the lock<br />
</span><span class="keyword">} else {<br />
&nbsp;&nbsp; echo </span><span class="string">"Couldn't lock the file !"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="39216""></a>
  <div class="note">
   <strong class="user">BWO</strong>
   <a href="#39216" class="date">20-Jan-2004 08:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using a secondary file for locking isn't too bad.&nbsp; You simply surround your actual writes by the flock commands on the locking file.&nbsp; Because of the blocking, your writes will not execute until you get the exclusive lock.&nbsp; <br />
<br />
<span class="default">&lt;?php<br />
$filename </span><span class="keyword">= </span><span class="string">"data.txt"</span><span class="keyword">;<br />
</span><span class="default">$lock </span><span class="keyword">= </span><span class="string">".lock"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Lock the .lock file.<br />
</span><span class="default">$lock_fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$lock</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">);<br />
if (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$lock_fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"locking failed"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// Write to the data file.<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"word up!"</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Release the lock.<br />
</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$lock_fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Easy as pi.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="35370""></a>
  <div class="note">
   <strong class="user">rob</strong>
   <a href="#35370" class="date">28-Aug-2003 03:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
locking a file exclusively *and* in non-blocking mode:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fh</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)) {<br />
&nbsp; </span><span class="comment">// do sumthin<br />
</span><span class="keyword">}<br />
else {<br />
&nbsp; </span><span class="comment">// fail, report file locked<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="32443""></a>
  <div class="note">
   <strong class="user">joel[at_sign]purerave.com</strong>
   <a href="#32443" class="date">27-May-2003 06:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have found that if you open a currently locked file with 'w' or 'w+' ("file pointer at the beginning of the file and truncate the file to zero length")&nbsp; then it will not truncate the file when the lock is released and the file available.<br />
<br />
Example I used to test it:<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// a.php<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock<br />
<br />
</span><span class="default">$steps </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
</span><span class="comment">// write to the file<br />
</span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'a '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
}<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock<br />
</span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
----------<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// b.php<br />
<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock<br />
<br />
// ftruncate($fp, 0) is needed here! &lt;----<br />
<br />
</span><span class="default">$steps </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">;<br />
</span><span class="comment">// write to the file<br />
</span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'b '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
}<br />
</span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock<br />
</span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Loading a.php then loading b.php right after will result in:<br />
b 1054075769 test 0<br />
b 1054075770 test 1<br />
b 1054075771 test 2<br />
b 1054075772 test 3<br />
b 1054075773 test 4<br />
a 1054075764 test 5<br />
a 1054075765 test 6<br />
a 1054075766 test 7<br />
a 1054075767 test 8<br />
a 1054075768 test 9<br />
<br />
As you can see, b.php does not truncate the file as the w+ would suggest if the file were instantly available. But only moves the pointer to the begining of the file. If b.php was loaded after a.php finished then there would be no "a ..." lines in the file, since it would be truncated.<br />
<br />
To fix this you have to add ftruncate($fp, 0) right after the flock.<br />
<br />
'r+' and 'a' seem to work fine, though.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="30289""></a>
  <div class="note">
   <strong class="user">ags one three seven at psu dot edu</strong>
   <a href="#30289" class="date">12-Mar-2003 10:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I am not certain how well this works (I've never had problems, but I haven't stress-tested it), but I have been using this solution for performing safe file locking and writing:<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$fl </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filepath</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fseek</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">, </span><span class="default">$whateverdata</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fflush</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fl</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span>This "cheats" and opens a file for writing by opening it for append (which doesn't truncate), then acquiring the lock first before performing any truncation or actual write operations.&nbsp; Thus, if the file cannot be successfully locked, it won't be changed at all.<br />
<br />
I usually like to assemble the data to be written in one large buffer first, so the file is open and locked for the shortest time possible.&nbsp; This is also friendlier to other scripts that are blocking on lock.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="29500""></a>
  <div class="note">
   <strong class="user">carl at thep lu se</strong>
   <a href="#29500" class="date">15-Feb-2003 10:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
[editors note: try out php.net/dio_fcntl]<br />
<br />
As flock() doesn't work over NFS (whereas fcntl() does, but there's no PHP interface for that), you may have to provide some sort of backup locking system if for one reason or other you need to use NFS (or VFAT, but as the documentation points out it's antiquated). One way of achieving this is to use a relational database. If you have a table T with an integer column cnt and a _single_ row, you can:<br />
UPDATE T set cnt = cnt + 1 WHERE cnt &gt;= 0<br />
to obtain a shared lock (and of course you need to verify that there was one affected row). For an exclusive lock:<br />
UPDATE T set cnt = -1 WHERE cnt = 0<br />
This scheme has two problems: You rely on the script to be able to release locks before exiting, and there is no way to wait for a lock (except polling). On the whole, if you can use flock() instead, use flock().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="24908""></a>
  <div class="note">
   
   <a href="#24908" class="date">04-Sep-2002 11:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Warning! When PHP is running as a CGI or fast-CGI extension in Apache, flock() does not guarantee that your file updates will complete!!!<br />
If a browser starts a request and interrupts it fast enough by using many F5-key refreshes, Apache will KILL the PHP process in the middle of the update operation (because it will detect an unexpected socket close before the PHP script is complete), leaving an incomplete or truncated file!<br />
<br />
A simple PHP script that increments a counter in a text file will demonstrate this: to update the counter, one needs to gain a lock then open the counter file in "a+" mode, rewind it, read it, rewind again, ftruncate it befire writing the new value and closing the counter file and the lock file. Have your script display the new counter value.<br />
Now use your favorite browser on your script, and make many refreshes from the same PC, using the F5-Refresh key, you'll see that sometimes the counter returns to 0, because there's an interruption after the counter file was truncated but before the new counter value was written to the file!<br />
<br />
Note that this affects also simple databases updates without rollback logs such as MySQL!<br />
<br />
Before updating any data, as a security measure, and if you don't have rollback logs, you should strictly limit the number of update requests per seconds a user can make through your PHP script. <br />
<br />
Shame, this requires a database or logging file to enable tracking user activity.<br />
<br />
The only solution is to use an auto-backup system (for file-based databases), or a database engine with rollback capability...<br />
<br />
I don't know if PHP implements a way to handle gracefully kill signals sent by Apache, so that we can ensure that we can complete a critical update operation.<br />
<br />
For this problem, flock() is not a solution!<br />
This is a MAJOR security issue for all sites that use text-file based databases!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="24100""></a>
  <div class="note">
   <strong class="user">geoff at message dot hu</strong>
   <a href="#24100" class="date">06-Aug-2002 01:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You should lock the file _before_ opening it, and unlock _after_ closing it. Othervise an another process might be able to access the file between the lock/unlock and the open/close operation.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.filetype.html">filetype</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.fnmatch.html">fnmatch</a></div>
 <div class="up"><a href="ref.filesystem.html">Filesystem Functions</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
