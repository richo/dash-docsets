<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>Plugin configuration file (&gt;=1.1.x)</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqlnd-ms.configuration.html">Runtime Configuration</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqlnd-ms.plugin-ini-v1.html">Plugin configuration file (&lt;= 1.0.x)</a></div>
 <div class="up"><a href="mysqlnd-ms.setup.html">Installing/Configuring</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mysqlnd-ms.plugin-ini-json" class="section">
  <h2 class="title">Plugin configuration file (&gt;=1.1.x)</h2>
  <blockquote class="note"><p><b class="note">Note</b>: 
   <b>Changelog: Feature was added in PECL/mysqlnd_ms 1.1.0-beta</b><br />
   <p class="para">
    The below description applies to PECL/mysqlnd_ms &gt;= 1.1.0-beta.
    It is not valid for prior versions.
   </p>
  </p></blockquote>
  <p class="para">
   The plugin uses its own configuration file. The configuration file
   holds information about the MySQL replication master server,
   the MySQL replication slave servers, the server pick (load balancing) policy,
   the failover strategy, and the use of lazy connections.
  </p>
  <p class="para">
   The plugin loads its configuration file at the beginning of a web request.
   It is then cached in memory and used for the duration of the web request.
   This way, there is no need to restart PHP after deploying the configuration
   file. Configuration file changes will become active almost instantly.
  </p>
  <p class="para">
   The PHP configuration directive
   <a href="mysqlnd-ms.configuration.html#ini.mysqlnd-ms.ini-file" class="link"><i>mysqlnd_ms.ini_file</i></a>
   is used to set the plugins configuration file. Please note, that
   the PHP configuration directive may not be evaluated for every web request.
   Therefore, changing the plugins configuration file name or location may
   require a PHP restart. However, no restart is required to read changes if
   an already existing plugin configuration file is updated.
  </p>
  <p class="para">
   Using and parsing <acronym title="JavaScript Object Notation">JSON</acronym> is efficient, and using <acronym title="JavaScript Object Notation">JSON</acronym>
   makes it easier to express hierarchical data structures than the standard
   <var class="filename">php.ini</var> format.
  </p>
  <p class="para">
   <div class="example" id="example-1715">
    <p><b>Example #1 Converting a PHP array (hash) into JSON format</b></p>
    <div class="example-contents"><p>
     Or alternatively, a developer may be more familiar with the PHP <span class="type"><a href="language.types.array.html" class="type array">array</a></span>
     syntax, and prefer it. This example demonstrates how a developer might convert a
     PHP array to <acronym title="JavaScript Object Notation">JSON</acronym>.
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$config&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;</span><span style="color: #DD0000">"myapp"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"master"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"master_0"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"host"&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"socket"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"/tmp/mysql.sock"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;),<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"slave"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(),<br />&nbsp;&nbsp;),<br />);<br /><br /></span><span style="color: #0000BB">file_put_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">json_encode</span><span style="color: #007700">(</span><span style="color: #0000BB">$config</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">JSON_PRETTY_PRINT</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini&nbsp;file&nbsp;created...\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Dumping&nbsp;file&nbsp;contents...\n"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">));<br />echo&nbsp;</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"mysqlnd_ms.ini"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"\n%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">str_repeat</span><span style="color: #007700">(</span><span style="color: #DD0000">"-"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">80</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>The above example will output:</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
mysqlnd_ms.ini file created...
Dumping file contents...
--------------------------------------------------------------------------------
{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/tmp\/mysql.sock&quot;
            }
        },
        &quot;slave&quot;: [

        ]
    }
}
--------------------------------------------------------------------------------
</pre></div>
    </div>
   </div>
  </p>
  <p class="para">
   A plugin configuration file consists of one or more sections. Sections
   are represented by the top-level object properties of the
   object encoded in the <acronym title="JavaScript Object Notation">JSON</acronym> file. Sections could also
   be called <em class="emphasis">configuration names</em>.
  </p>
  <p class="para">
   Applications reference sections by their name. Applications use section names
   as the host (server) parameter to the various connect methods of the
   <a href="ref.mysqli.html" class="link">mysqli</a>,
   <a href="ref.mysql.html" class="link">mysql</a> and
   <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a> extensions. Upon connect,
   the <a href="book.mysqlnd.html" class="link">mysqlnd</a> plugin compares the hostname
   with all of the section names from the plugin configuration file. If the hostname and
   section name match, then the plugin will load the settings for that section.
  </p>
  <p class="para" id="mysqlnd-ms.plugin-ini-json.using-section">
   <div class="example" id="example-1716">
    <p><b>Example #2 Using section names example</b></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: 3306
            }
        }
    },
    &quot;localhost&quot;: {
        &quot;master&quot;: [
            {
                &quot;host&quot;: &quot;localhost&quot;,
                &quot;socket&quot;: &quot;\/path\/to\/mysql.sock&quot;
            }
        ],
        &quot;slave&quot;: [
            {
                &quot;host&quot;: &quot;192.168.3.24&quot;,
                &quot;port&quot;: &quot;3305&quot;
            },
            {
                &quot;host&quot;: &quot;192.168.3.65&quot;,
                &quot;port&quot;: &quot;3309&quot;
            }
        ]
    }
}</pre>
</div>
    </div>

    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;All&nbsp;of&nbsp;the&nbsp;following&nbsp;connections&nbsp;will&nbsp;be&nbsp;load&nbsp;balanced&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$pdo&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'mysql:host=myapp;dbname=database'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'username'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'password'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$mysql&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysql_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"username"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"database"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   Section names are strings. It is valid to use a section name such as
   <i>192.168.2.1</i>, <i>127.0.0.1</i> or
   <i>localhost</i>. If, for example, an application
   connects to <i>localhost</i> and a plugin
   configuration section <i>localhost</i> exists, the
   semantics of the connect operation are changed. The application will
   no longer only use the MySQL server running on the host
   <i>localhost</i>, but the plugin will start to load balance
   MySQL queries following the rules from the <i>localhost</i>
   configuration section. This way you can load balance queries from
   an application without changing the applications source code.
   Please keep in mind, that such a configuration may not contribute
   to overall readability of your applications source code. Using section names
   that can be mixed up with host names should be seen as a last resort.
  </p>
  <p class="para" id="mysqlnd-ms.plugin-ini-json.server-list-syntax">
   Each configuration section contains, at a minimum, a list of master servers
   and a list of slave servers. The master list is configured with the keyword
   <i>master</i>, while the slave list is configured with the
   <i>slave</i> keyword. Failing to provide a slave list will result
   in a fatal <b><tt>E_ERROR</tt></b> level error, although a slave list
   may be empty. It is possible to allow no slaves. However, this is only recommended
   with synchronous clusters, please see also
   <a href="mysqlnd-ms.supportedclusters.html" class="link">supported clusters</a>.
   The main part of the documentation focusses on the use
   of aynchronous MySQL replication clusters.
  </p>
  <p class="para">
   The master and slave server lists can be optionally indexed by symbolic
   names for the servers they describe. Alternatively, an array of descriptions
   for slave and master servers may be used.
  </p>
  <p class="para">
   <div class="example" id="example-1717">
    <p><b>Example #3 List of anonymous slaves</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;slave&quot;: [
    {
        &quot;host&quot;: &quot;192.168.3.24&quot;,
        &quot;port&quot;: &quot;3305&quot;
    },
    {
        &quot;host&quot;: &quot;192.168.3.65&quot;,
        &quot;port&quot;: &quot;3309&quot;
    }
]</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   An anonymous server list is encoded by the <i>JSON array</i> type.
   Optionally, symbolic names may be used for indexing the slave or master servers
   of a server list, and done so using the <i>JSON object</i> type.
  </p>
  <p class="para">
   <div class="example" id="example-1718">
    <p><b>Example #4 Master list using symbolic names</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;master&quot;: {
    &quot;master_0&quot;: {
        &quot;host&quot;: &quot;localhost&quot;
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   It is recommended to index the server lists with symbolic server names.
   The alias names will be shown in error messages.
  </p>
  <p class="para">
   The order of servers is preserved and taken into account by mysqlnd_ms.
   If, for example, you configure round robin load balancing strategy, the
   first <i>SELECT</i> statement will be executed on the
   slave that appears first in the slave server list.
  </p>
  <p class="para">
   A configured server can be described with the <i>host</i>,
   <i>port</i>, <i>socket</i>, <i>db</i>,
   <i>user</i>, <i>password</i> and <i>connect_flags</i>.
   It is mandatory to set the database server host using the <i>host</i>
   keyword. All other settings are optional.
  </p>
  <p class="para">
   <div class="example" id="example-1719">
    <p><b>Example #5 Keywords to configure a server</b></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;db_server_host&quot;,
                &quot;port&quot;: &quot;db_server_port&quot;,
                &quot;socket&quot;: &quot;db_server_socket&quot;,
                &quot;db&quot;: &quot;database_resp_schema&quot;,
                &quot;user&quot;: &quot;user&quot;,
                &quot;password&quot;: &quot;password&quot;,
                &quot;connect_flags&quot;: 0
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;db_server_host&quot;,
                &quot;port&quot;: &quot;db_server_port&quot;,
                &quot;socket&quot;: &quot;db_server_socket&quot;
            }
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   If a setting is omitted, the plugin will use the value provided by the user
   API call used to open a connection. Please, see the
   <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.using-section" class="link">using section names example</a> above.
  </p>
  <p class="para">
   The configuration file format has been changed in version 1.1.0-beta to allow for
   chained filters. Filters are responsible for filtering the configured list of
   servers to identify a server for execution of a given statement.
   Filters are configured with the <i>filter</i> keyword. Filters
   are executed by mysqlnd_ms in the order of their appearance.
   Defining filters is optional. A configuration section in the plugins
   configuration file does not need to have a <i>filters</i> entry.
  </p>
  <p class="para">
   Filters replace the
   <a href="mysqlnd-ms.plugin-ini-v1.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><i>pick[]</i></a>
   setting from prior versions. The new <i>random</i> and
   <i>roundrobin</i> provide the same functionality.
  </p>
  <p class="para">
   <div class="example" id="example-1720">
    <p><b>Example #6 New <i>roundrobin</i> filter, old functionality</b></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.137&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;roundrobin&quot;: [

            ]
        }
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   The function
   <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span>
   has been removed. Setting a callback is now done with the <i>user</i>
   filter. Some filters accept parameters. The <i>user</i> filter
   requires and accepts a mandatory <i>callback</i> parameter
   to set the callback previously set through the function <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span>.
   <div class="example" id="example-1721">
    <p><b>Example #7 The <i>user</i> filter replaces <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span></b></p>
    <div class="example-contents">
<div class="inicode"><pre class="inicode">&quot;filters&quot;: {
    &quot;user&quot;: {
        &quot;callback&quot;: &quot;pick_server&quot;
    }
}</pre>
</div>
    </div>

   </div>
  </p>
  <p class="para">
   Here is a short explanation of the configuration directives that can be used.
  </p>
  <p class="para">
  <dl>

   <dt id="ini.mysqlnd-ms-plugin-config-v2.master">
     <span class="term">
      <i><tt class="parameter">master</tt></i>
      <span class="type"><span class="type array or object">array or object</span></span>
     </span>
     <dd>

      <p class="para">
       List of MySQL replication master servers. The list of either
       of the <i>JSON type array</i> to declare an anonymous list
       of servers or of the <i>JSON type object</i>. Please,
       see <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.server-list-syntax" class="link">above</a>
       for examples.
      </p>
      <p class="para">
       Setting at least one master server is mandatory. The plugin will issue an
       error of type <i>E_ERROR</i> if the user has failed to
       provide a master server list for a configuration section.
       The fatal error may read
       <i>(mysqlnd_ms) Section [master] doesn&#039;t exist for host
       [name_of_a_config_section] in %s on line %d</i>.
      </p>
      <p class="para">
       A server is described with
       the <i>host</i>, <i>port</i>,
       <i>socket</i>, <i>db</i>,
       <i>user</i>, <i>password</i> and
       <i>connect_flags</i>. It is mandatory to
       provide at  a value for <i>host</i>. If any of the
       other values is not given, it will be taken from the user
       API connect call, please, see also:
       <a href="mysqlnd-ms.plugin-ini-json.html#mysqlnd-ms.plugin-ini-json.using-section" class="link">using section names example</a>.
      </p>
      <p class="para" id="mysqlnd-ms.plugin-ini-json.server-config-keywords">
       Table of server configuration keywords.
      </p>
      <table class="doctable informaltable">
       
        <col align="left" width="1" />
        <col align="left" width="7" />
        <col align="left" width="2" />
        <thead valign="middle">
         <tr valign="middle">
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody valign="middle" class="tbody">
         <tr valign="middle">
           <td align="left">
             <i>host</i>
           </td>
           <td align="left">
            <p class="para">
             Database server host. This is a mandatory setting.
             Failing to provide, will cause an error of type <i>E_RECOVERABLE_ERROR</i>
             when the plugin tries to connect to the server. The error message may
             read <i>(mysqlnd_ms) Cannot find [host] in
             [%s] section in config in %s on line %d</i>.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>port</i>
           </td>
           <td align="left">
            <p class="para">
              Database server TCP/IP port.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>socket</i>
           </td>
           <td align="left">
            <p class="para">
              Database server Unix domain socket.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>db</i>
           </td>
           <td align="left">
            <p class="para">
              Database (schemata).
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>user</i>
           </td>
           <td align="left">
            <p class="para">
              MySQL database user.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>password</i>
           </td>
           <td align="left">
            <p class="para">
              MySQL database user password.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>connect_flags</i>
           </td>
           <td align="left">
            <p class="para">
              Connection flags.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

        </tbody>
       
      </table>

      <p class="para">
       The plugin supports using only one master server. An experimental
       setting exists to enable multi-master support. The details are
       not documented. The setting is meant for development only.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.slave">
    <span class="term">
      <i><tt class="parameter">slave</tt></i>
      <span class="type"><span class="type array or object">array or object</span></span>
     </span>
     <dd>

      <p class="para">
       List of one or more MySQL replication slave servers. The syntax is
       identical to setting master servers, please, see
       <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.master" class="link"><i>master</i></a>
       above for details.
      </p>
      <p class="para">
       The plugin supports using one or more slave servers.
      </p>
      <p class="para">
       Setting a list of slave servers is mandatory. The plugin will report
       an error of the type <i>E_ERROR</i> if <i>slave</i>
       is not given for a configuration section. The fatal error message may read
       <i>(mysqlnd_ms) Section [slave] doesn&#039;t exist for host [%s] in %s on line %d</i>.
       Note, that it is valid to use an empty slave server list.
       The error has been introduced to prevent accidently setting no slaves by
       forgetting about the <i>slave</i> setting.
       A master-only setup is still possible using an empty slave server list.
      </p>
      <p class="para">
       If an empty slave list is configured and an attempt is made to
       execute a statement on a slave the plugin may emit a warning like
       <i>mysqlnd_ms) Couldn&#039;t find the appropriate slave connection.
       0 slaves to choose from.</i> upon statement execution.
       It is possible that another warning follows such as
       <i>(mysqlnd_ms) No connection selected by the last filter</i>.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.filters">
     <span class="term">
      <i><tt class="parameter">filters</tt></i>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </span>
     <dd>

      <p class="para">
       List of filters. A filter is responsible to filter the list of available
       servers for executing a given statement. Filters can be chained.
       The <i>random</i> and <i>roundrobin</i> filter
       replace the
       <a href="mysqlnd-ms.plugin-ini-v1.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><i>pick[]</i></a>
       directive used in prior version to select a load balancing policy.
       The <i>user</i> filter replaces the
       <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> function.
      </p>
      <p class="para">
       Filters may accept parameters to refine their actions.
      </p>
      <p class="para">
       If no load balancing policy is set, the plugin will default to
       <i>random_once</i>. The <i>random_once</i>
       policy picks a random slave server when running the first read-only
       statement. The slave server will be used for all read-only
       statements until the PHP script execution ends. No load balancing
       policy is set and thus, defaulting takes place,
       if neither the <i>random</i> nor the
       <i>roundrobin</i> are part of a configuration section.
      </p>
      <p class="para">
       If a filter chain is configured so that a filter which output no
       more than once server is used as input for a filter which should be given
       more than one server as input, the plugin may emit a warning upon
       opening a connection. The warning may read: <i>(mysqlnd_ms) Error while creating
       filter &#039;%s&#039; . Non-multi filter &#039;%s&#039; already created.
       Stopping in %s on line %d</i>. Futhermore an error of
       the error code <i>2000</i>, the sql state <i>HY000</i>
       and an error message similar to the warning may be set on the connection
       handle.
      </p>
      <p class="para">
       <div class="example" id="example-1722">
        <p><b>Example #8 Invalid filter sequence</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;roundrobin&quot;,
            &quot;random&quot;
        ]
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">(),&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br /></span><span style="color: #0000BB">$link</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>The above example will output:</p></div>
        <div class="example-contents screen">
<div class="cdata"><pre>
PHP Warning:  mysqli::mysqli(): (HY000/2000): (mysqlnd_ms) Error while creating filter &#039;random&#039; . Non-multi filter &#039;roundrobin&#039; already created. Stopping in filter_warning.php on line 1
[2000] (mysqlnd_ms) Error while creating filter &#039;random&#039; . Non-multi filter &#039;roundrobin&#039; already created. Stopping
PHP Warning:  mysqli::query(): Couldn&#039;t fetch mysqli in filter_warning.php on line 3
</pre></div>
        </div>
       </div>
      </p>
    </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-random">
     <span class="term">
      Filter: <i><tt class="parameter">random</tt></i>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </span>
     <dd>

      <p class="para">
        The <i>random</i> filter features the random and random once
        load balancing policies, set through the
        <a href="mysqlnd-ms.plugin-ini-v1.html#ini.mysqlnd-ms-plugin-config.pick" class="link"><i>pick[]</i></a>
        directive in older versions.
      </p>
      <p class="para">
        The random policy will pick a random server whenever
        a read-only statement is to be executed. The random once strategy
        picks a random slave server once and continues using the slave for the
        rest of the PHP web request. Random once is a default,
        if load balancing is not configured through a filter.
      </p>
      <p class="para">
       If the <i>random</i> filter is not given any arguments, it
       stands for random load balancing policy.
      </p>
      <p class="para">
       <div class="example" id="example-1723">
        <p><b>Example #9 Random load balancing with <i>random</i> filter</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.137&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;random&quot;
        ]
    }
}</pre>
</div>
         </div>

       </div>
      </p>
      <p class="para">
       Optionally, the <i>sticky</i> argument can be passed to the
       filter. If the parameter <i>sticky</i> is set to the string
       <i>1</i>, the filter follows the random once
       load balancing strategy.
      </p>
      <p class="para">
       <div class="example" id="example-1724">
        <p><b>Example #10 Random once load balancing with <i>random</i> filter</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;filters&quot;: {
        &quot;random&quot;: {
            &quot;sticky&quot;: &quot;1&quot;
        }
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       Unknown arguments are ignored. No warning or error is given.
      </p>

      <p class="para">
        Expects one or more servers as input. Outputs one server.
        A filter sequence such as
        <i>random</i>, <i>roundrobin</i> may
        cause a warning and an error message to be set on the connection
        handle when executing a statement.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-roundrobin">
     <span class="term">
      Filter: <i><tt class="parameter">roundrobin</tt></i>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </span>
     <dd>

      <p class="para">
       If using the <i>roundrobin</i> filter, the plugin
       iterates over the list of  configured slave servers to pick a server
       for statement execution. If the plugin reaches the end of the list,
       it wraps around to the beginning of the list and picks the first
       configured slave server.
      </p>
      <p class="para">
       <div class="example" id="example-1725">
        <p><b>Example #11 <i>roundrobin</i> filter</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: [
            &quot;roundrobin&quot;
        ]
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
        Expects one or more servers as input. Outputs one server.
        A filter sequence such as
        <i>roundrobin</i>, <i>random</i> may
        cause a warning and an error message to be set on the connection
        handle when executing a statement.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-user">
     <span class="term">
      Filter: <i><tt class="parameter">user</tt></i>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </span>
     <dd>

      <p class="para">
        The <i>user</i> replaces
       <span class="function"><a href="function.mysqlnd-ms-set-user-pick-server.html" class="function">mysqlnd_ms_set_user_pick_server()</a></span> function,
       which was removed in 1.1.0-beta. The filter sets a callback for user-defined
       read/write splitting and server selection.
      </p>
      <p class="para">
        The plugins built-in read/write query split mechanism decisions can be
        overwritten in two ways. The easiest way is to prepend a query string
        with the SQL hints <b><tt>MYSQLND_MS_MASTER_SWITCH</tt></b>,
        <b><tt>MYSQLND_MS_SLAVE_SWITCH</tt></b> or
        <b><tt>MYSQLND_MS_LAST_USED_SWITCH</tt></b>. Using SQL hints one can
        control, for example, whether a query shall be send to the MySQL replication
        master server or one of the slave servers. By help of SQL hints it is
        not possible to pick a certain slave server for query execution.
      </p>
      <p class="para">
       Full control on server selection can be gained using a callback function.
       Use of a callback is recommended to expert users only because the callback
       has to cover all cases otherwise handled by the plugin.
      </p>
      <p class="para">
       The plugin will invoke the callback function for selecting a server from the
       lists of configured master and slave servers. The callback function
       inspects the query to run and picks a server for query execution by returning
       the hosts URI, as found in the master and slave list.
      </p>
      <p class="para">
       If the lazy connections are enabled and the callback choses a slave server for
       which no connection has been established so far and establishing the connection
       to the slave fails, the plugin will return an error upon the next action
       on the failed connection, for example, when running a query. It is the
       responsibility of the application developer to handle the error. For example,
       the application can re-run the query to trigger a new server selection and
       callback invocation. If so, the callback must make sure to select
       a different slave, or check slave availability, before returning to
       the plugin to prevent an endless loop.
      </p>
      <p class="para">
       <div class="example" id="example-1726">
        <p><b>Example #12 Setting a callback</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;user&quot;: {
                &quot;callback&quot;: &quot;pick_server&quot;
            }
        }
    }
}</pre>
</div>
         </div>

       </div>
      </p>
      <p class="para">
       The callback is supposed to return a host to run the query on.
       The host URI is to be taken from the master and slave connection lists
       passed to the callback function. If callback returns a value neither
       found in the master nor in the slave connection lists the plugin
       will emit an error of the type <i>E_RECOVERABLE_ERROR</i>
       The error may read like
       <i>  (mysqlnd_ms) User filter callback has returned an unknown server.
       The server &#039;server that is not in master or slave list&#039; can neither be found
       in the master list nor in the slave list</i>.
       If the application catches the error to ignore it, follow up errors
       may be set on the connection handle, for example,
       <i>(mysqlnd_ms) No connection selected by the last filter</i> with
       the error code <i>2000</i> and the sqlstate <i>HY000</i>.
       Furthermore a warning may be emitted.
      </p>
      <p class="para">
       Referencing a non-existing function as a callback will result
       in any error of the type <i>E_RECOVERABLE_ERROR</i> whenever
       the plugin tries to callback function. The error message may reads like:
       <i>(mysqlnd_ms) Specified callback (pick_server) is
       not a valid callback</i>. If the application catches the error to
       ignore it, follow up errors may be set on the connection handle, for example,
       <i>(mysqlnd_ms) Specified callback (pick_server) is
       not a valid callback</i> with the error code <i>2000</i>
       and the sqlstate <i>HY000</i>. Furthermore a warning
       may be emitted.
      </p>
      <p class="para">
       The following parameters are passed from the plugin to the callback.
      </p>
      <table class="doctable informaltable">
       
        <col align="left" width="1" />
        <col align="left" width="7" />
        <col align="left" width="2" />
        <thead valign="middle">
         <tr valign="middle">
          <th>Parameter</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody valign="middle" class="tbody">
         <tr valign="middle">
           <td align="left">
             <i>connected_host</i>
           </td>
           <td align="left">
            <p class="para">
             URI of the currently connected database server.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>query</i>
           </td>
           <td align="left">
            <p class="para">
             Query string of the statement for which a server needs
             to be picked.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>masters</i>
           </td>
           <td align="left">
            <p class="para">
             List of master servers to choose from. Note, that the list of master
             servers may not be identical to the list of configured master
             servers if the filter is not the first in the filter chain.
             Previously run filters may have reduced the master
             list already.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>slaves</i>
           </td>
           <td align="left">
            <p class="para">
             List of slave servers to choose from. Note, that the list of master
             servers may not be identical to the list of configured master
             servers if the filter is not the first in the filter chain.
             Previously run filters may have reduced the master
             list already.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>last_used_connection</i>
           </td>
           <td align="left">
            <p class="para">
              URI of the server of the connection used to execute the previous
              statement on.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>in_transaction</i>
           </td>
           <td align="left">
            <p class="para">
             Boolean flag indicating wheter the statement is
             part of an open transaction. If autocommit mode is turned
             off, this will be set to <b><tt>TRUE</tt></b>. Otherwise
             it is set to <b><tt>FALSE</tt></b>.
            </p>
            <p class="para">
             Transaction detection is based on monitoring the
             mysqlnd library call <i>set_autocommit</i>.
             Monitoring is not possible beofre PHP 5.4.0. Please, see
             <a href="mysqlnd-ms.pooling.html" class="link">connection pooling and switching</a>
             concepts discussion for further details.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

        </tbody>
       
      </table>

     <p class="para">
      <div class="example" id="example-1727">
        <p><b>Example #13 Using a callback</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;user&quot;: {
                &quot;callback&quot;: &quot;pick_server&quot;
            }
        }
    }
}</pre>
</div>
         </div>

         <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in_transaction</span><span style="color: #007700">)<br />{<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$slave_idx&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">;<br />&nbsp;static&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br />&nbsp;if&nbsp;(</span><span style="color: #0000BB">is_null</span><span style="color: #007700">(</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">))<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$num_slaves&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">count</span><span style="color: #007700">(</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #FF8000">/*&nbsp;default:&nbsp;fallback&nbsp;to&nbsp;the&nbsp;plugins&nbsp;build-in&nbsp;logic&nbsp;*/<br />&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">NULL</span><span style="color: #007700">;<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"User&nbsp;has&nbsp;connected&nbsp;to&nbsp;'%s'...\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$connected</span><span style="color: #007700">);<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;deciding&nbsp;where&nbsp;to&nbsp;run&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br /><br />&nbsp;</span><span style="color: #0000BB">$where&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqlnd_ms_query_is_select</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">);<br />&nbsp;switch&nbsp;(</span><span style="color: #0000BB">$where</span><span style="color: #007700">)<br />&nbsp;{<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_MASTER</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;using&nbsp;master\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_USE_SLAVE</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;SELECT&nbsp;or&nbsp;SQL&nbsp;hint&nbsp;for&nbsp;using&nbsp;slave&nbsp;*/<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">stristr</span><span style="color: #007700">(</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">))<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;a&nbsp;table&nbsp;which&nbsp;is&nbsp;only&nbsp;on&nbsp;the&nbsp;first&nbsp;configured&nbsp;slave&nbsp;&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;access&nbsp;to&nbsp;table&nbsp;available&nbsp;only&nbsp;on&nbsp;slave&nbsp;A&nbsp;detected\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;else<br />&nbsp;&nbsp;&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;round&nbsp;robin&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;some&nbsp;read-only&nbsp;query&nbsp;for&nbsp;a&nbsp;slave\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">[</span><span style="color: #0000BB">$slave_idx</span><span style="color: #007700">++&nbsp;%&nbsp;</span><span style="color: #0000BB">$num_slaves</span><span style="color: #007700">];<br />&nbsp;&nbsp;&nbsp;}<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;&nbsp;case&nbsp;</span><span style="color: #0000BB">MYSQLND_MS_QUERY_LAST_USED</span><span style="color: #007700">:<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;using&nbsp;last&nbsp;used&nbsp;server\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$ret&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;break;<br />&nbsp;}<br /><br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"...&nbsp;ret&nbsp;=&nbsp;'%s'\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">);<br />&nbsp;return&nbsp;</span><span style="color: #0000BB">$ret</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"myapp"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"root"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">""</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"test"</span><span style="color: #007700">);<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;1&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;2&nbsp;FROM&nbsp;DUAL"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /><br />if&nbsp;(!(</span><span style="color: #0000BB">$res&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">query</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;*&nbsp;FROM&nbsp;table_on_slave_a_only"</span><span style="color: #007700">)))<br />&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"[%d]&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">error</span><span style="color: #007700">);<br />else<br />&nbsp;</span><span style="color: #0000BB">$res</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /><br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

         <div class="example-contents"><p>The above example will output:</p></div>
         <div class="example-contents screen">
<div class="cdata"><pre>
User has connected to &#039;myapp&#039;...
... deciding where to run &#039;SELECT 1 FROM DUAL&#039;
... some read-only query for a slave
... ret = &#039;tcp://192.168.2.27:3306&#039;
User has connected to &#039;myapp&#039;...
... deciding where to run &#039;SELECT 2 FROM DUAL&#039;
... some read-only query for a slave
... ret = &#039;tcp://192.168.78.136:3306&#039;
User has connected to &#039;myapp&#039;...
... deciding where to run &#039;SELECT * FROM table_on_slave_a_only&#039;
... access to table available only on slave A detected
... ret = &#039;tcp://192.168.2.27:3306&#039;
</pre></div>
         </div>
       </div>
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-user-multi">
     <span class="term">
      Filter: <i><tt class="parameter">user_multi</tt></i>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </span>
     <dd>

      <p class="para">
       The <i>user_multi</i> differs from the <i>user</i>
       only in one aspect. Otherwise, their syntax is identical.
       The <i>user</i> filter must pick
       and return exactly one node for statement execution. A filter chain
       usually ends with a filter that emits only one node. The filter chain
       shall reduce the list of candidates for statement execution down to
       one. This, only one node left, is the case after the <i>user</i>
       filter has been run.
      </p>
      <p class="para">
       The <i>user_multi</i> filter is a multi filter. It returns a
       list of slave and a list of master servers. This list needs further filtering
       to identify exactly one node for statement execution. A multi filter is typically
       placed at the top of the filter chain. The <i>quality_of_service</i>
       filter is another example of a multi filter.
      </p>
      <p class="para">
       The return value of the callback set for <i>user_multi</i> must
       be an an array with two elements. The first element holds a list of selected master
       servers. The second element contains a list of selected slave servers. The
       lists shall contain the keys of the slave and master servers as found in
       the slave and master lists passed to the callback. The below example returns
       random master and slave lists extracted from the functions input.
      </p>
      <p class="para">
      <div class="example" id="example-1728">
        <p><b>Example #14 Returning random masters and slaves</b></p>
        <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">pick_server</span><span style="color: #007700">(</span><span style="color: #0000BB">$connected</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$query</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$slaves</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$last_used_connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in_transaction</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_masters&nbsp;</span><span style="color: #007700">=&nbsp;array()<br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$masters&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">mt_rand</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_masters</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_slaves&nbsp;</span><span style="color: #007700">=&nbsp;array()<br />&nbsp;&nbsp;foreach&nbsp;(</span><span style="color: #0000BB">$slaves&nbsp;</span><span style="color: #007700">as&nbsp;</span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">$value</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(</span><span style="color: #0000BB">mt_rand</span><span style="color: #007700">(</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">)&nbsp;&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$picked_slaves</span><span style="color: #007700">[]&nbsp;=&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">;<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;return&nbsp;array(</span><span style="color: #0000BB">$picked_masters</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$picked_slaves</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
         </div>

       </div>
      </p>
      <p class="para">
       The plugin will issue an
       error of type <i>E_RECOVERABLE</i> if the callback fails to return
       a server list. The error may read <i>(mysqlnd_ms) User multi
       filter callback has not returned a list of servers to use.
       The callback must return an array in %s on line %d</i>. In case the
       server list is not empty but has invalid servers key/ids in it, an error
       of type <i>E_RECOVERABLE</i> will the thrown with an
       error message like <i>(mysqlnd_ms) User multi filter callback
       has returned an invalid list of servers to use.
       Server id is negative in %s on line %d</i>, or similar.
      </p>
      <p class="para">
       Whether an error is emitted in case of an empty slave or master list
       depends on the configuration. If an empty master list is returned
       for a write operation, it is likely that the plugin will emit a
       warning that may read <i>(mysqlnd_ms) Couldn&#039;t find the appropriate
       master connection. 0 masters to choose from. Something is wrong in %s on line %d</i>.
       Typically a follow up error of type <i>E_ERROR</i> will happen.
       In case of a read operation and an empty slave list the behviour depends
       on the fail over configuration. If fail over to master is enabled, no
       error should appear. If fail over to master is deactivated the plugin will
       emit a warning that may read <i>(mysqlnd_ms) Couldn&#039;t find the appropriate
       slave connection. 0 slaves to choose from. Something is wrong in %s on line %d</i>.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.filter-qos">
     <span class="term">
      Filter: <i><tt class="parameter">quality_of_service</tt></i>
      <span class="type"><a href="language.types.object.html" class="type object">object</a></span>
     </span>
     <dd>

      <p class="para">
       The <i>quality_of_service</i> identifies cluster nodes
       capable of delivering a certain quality of service. It is a multi filter
       which returns zero, one or multiple of its input servers. Thus, it
       must be followed by other filters to reduce the number of candidates
       down to one for statement execution.
      </p>
      <p class="para">
       The <i>quality_of_service</i> filter has been introduced in 1.2.0-alpha.
       In the 1.2 series the filters focus is on the consistency aspect of
       service quality. Different types of clusters offer different
       default data consistencies. For example, an asynchronous MySQL
       replication slave offers eventual consistency. The slave may not
       be able to deliver requested data because it has not replicated the write,
       it may serve stale database because its lagging behind or it may serve
       current information. Often, this is acceptable. In some cases
       higher consistency levels are needed for the application to work correct.
       In those cases, the <i>quality_of_service</i> can filter out cluster nodes
       which cannot deliver the necessary quality of service.
      </p>
      <p class="para">
       The <i>quality_of_service</i> filter can be replaced or created
       at runtime. A successful call to
       <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>
       removes all existing <i>qos</i> filter entries from the
       filter list and installs a new one at the very beginning. All settings
       that can be made through
       <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span>
       can also be in the plugins configuration file. However, use of the function
       is by far the most common use case. Instead of setting session consistency and
       strong consistency service levels in the plugins configuration file it is
       recommended to define only masters and no slaves. Both service levels will
       force the use of masters only. Using an empty slave list shortens the
       configuration file, thus improving readability. The only service level for which
       there is a case of defining in the plugins configuration file is the combination
       of eventual consistency and maximum slave lag.
      </p>
      <table class="doctable informaltable">
       
        <col align="left" width="1" />
        <col align="left" width="7" />
        <col align="left" width="2" />
        <thead valign="middle">
         <tr valign="middle">
          <th>Keyword</th>
          <th>Description</th>
          <th>Version</th>
         </tr>

        </thead>

        <tbody valign="middle" class="tbody">
         <tr valign="middle">
           <td align="left">
             <i>eventual_consistency</i>
           </td>
           <td align="left">
            <p class="para">
             Request eventual consistency. Allows the use of all
             master and slave servers. Data returned may or may not be current.
            </p>
            <p class="para">
             Eventual consistency accepts an optional <i>age</i>
             parameter. If <i>age</i> is given the plugin considers
             only slaves for reading for which MySQL replication reports
             a slave lag less or equal to <i>age</i>.
             The repliation lag is measure using <i>SHOW SLAVE STATUS</i>.
             If the plugin fails to fetch the replication lag, the slave tested
             is skipped. Implementation details and tipps are given in the
             <a href="mysqlnd-ms.qos-consistency.html" class="link">quality of service concepts section</a>.
            </p>
            <p class="para">
              Please note, if a filter chain
              generates an empty slave list and the PHP configuration directive
              <i>mysqlnd_ms.multi_master=0</i> is used, the plugin may
              emit a warning.
            </p>
            <p class="para">
             <div class="example" id="example-1729">
               <p><b>Example #15 Global limit on slave lag</b></p>
                <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.2.27&quot;,
                &quot;port&quot;: &quot;3306&quot;
            },
            &quot;slave_1&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;filters&quot;: {
            &quot;quality_of_service&quot;: {
                &quot;eventual_consistency&quot;: {
                    &quot;age&quot;:123
                }
            }
        }
    }
}</pre>
</div>
              </div>

             </div>
            </p>
          </td>
          <td align="left">Since 1.2.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>session_consistency</i>
           </td>
           <td align="left">
            <p class="para">
              Request session consistency (read your writes). Allows use of all masters
              and all slaves which are in sync with the master.
              If no further parameters are given slaves are filtered out
              as there is no reliable way to test if a slave has caugth up
              to the master or is lagging behind. Please note, if a filter chain
              generates an empty slave list and the PHP configuration directive
              <i>mysqlnd_ms.multi_master=0</i> is used, the plugin may
              emit a warning.
            </p>
            <p class="para">
             Session consistency temporarily requested using
             <span class="function"><a href="function.mysqlnd-ms-set-qos.html" class="function">mysqlnd_ms_set_qos()</a></span> is a valuable alternative
             to using <i>master_on_write</i>.
             <i>master_on_write</i> is likely to send more statements
             to the master than needed. The application may be able to contiue
             operation at a lower consistency level after it has done
             some critial reads.
            </p>
          </td>
          <td align="left">Since 1.1.0.</td>
         </tr>

         <tr valign="middle">
           <td align="left">
             <i>strong_consistency</i>
           </td>
           <td align="left">
            <p class="para">
              Request strong consistency. Only masters will be used.
            </p>
          </td>
          <td align="left">Since 1.2.0.</td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.failover">
     <span class="term">
      <i><tt class="parameter">failover</tt></i>
      <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
     </span>
     <dd>

      <p class="para">
       Failover policy. Supported policies:
       <i>disabled</i> (default), <i>master</i>.
      </p>
      <p class="para">
       If no failover policy is set, the plugin will not do any
       automatic failover (<i>failover=disabled</i>). Whenever
       the plugin fails to connect a server it will emit a warning and
       set the connections error code and message. Thereafter it is up to
       the application to handle the error and, for example, resent the
       last statement to trigger the selection of another server.
      </p>
      <p class="para">
       If using <i>failover=master</i> the plugin will implicitly
       failover to a slave, if available. Please check the
       concepts documentation to learn about potential
       pitfalls and risks of using <i>failover=master</i>.
      </p>
      <p class="para">
       <div class="example" id="example-1730">
        <p><b>Example #16 Optional master failover when failing to connect to slave</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;failover&quot;: &quot;master&quot;
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       Setting <i>failover</i> to any other value but
       <i>disabled</i> or <i>master</i> will not
       emit any warning or error.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.lazy-connections">
     <span class="term">
      <i><tt class="parameter">lazy_connections</tt></i>
      <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
     </span>
     <dd>

      <p class="para">
       Controls the use of lazy connections. Lazy connections
       are connections which are not opened before the client sends the first
       connection. Lazy connections are a default.
      </p>
      <p class="para">
       It is strongly recommended to use lazy connections.
       Lazy connections help to keep the number of open connections low.
       If you disable lazy connections and, for example, configure one MySQL
       replication master server and two MySQL replication slaves, the
       plugin will open three connections upon the first call to a
       connect function although the application might use the master
       connection only.
      </p>
      <p class="para">
       Lazy connections bare a risk if you make heavy use of actions
       which change the state of a connection. The plugin does not dispatch
       all state changing actions to all connections from the connection pool.
       The few dispatched actions are applied to already opened connections
       only. Lazy connections opened in the future are not affected.
       Only some settings are &quot;remembered&quot; and applied when lazy
       connections are opened.
      </p>
      <p class="para">
       <div class="example" id="example-1731">
        <p><b>Example #17 Disabling lazy connection</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;lazy_connections&quot;: 0
    }
}</pre>
</div>
        </div>

       </div>
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.master-on-write">
     <span class="term">
      <i><tt class="parameter">master_on_write</tt></i>
      <span class="type"><a href="language.types.boolean.html" class="type bool">bool</a></span>
     </span>
     <dd>

      <p class="para">
       If set, the plugin will use the master server only after the
       first statement has been executed on the master. Applications
       can still send statements to the slaves using SQL hints to
       overrule the automatic decision.
      </p>
      <p class="para">
       The setting may help with replication lag. If an application runs
       an <i>INSERT</i> the plugin will, by default, use the
       master to execute all following statements, including
       <i>SELECT</i> statements. This helps to avoid problems
       with reads from slaves which have not replicated the
       <i>INSERT</i> yet.
      </p>
      <p class="para">
       <div class="example" id="example-1732">
        <p><b>Example #18 Master on write for consistent reads</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;master_on_write&quot;: 1
    }
}</pre>
</div>
        </div>

       </div>
      </p>
      <p class="para">
       Please, note the <i>quality_of_service</i> filter introduced
       in version 1.2.0-alpha. It gives finer control, for example, for achieving read-your-writes
       and, it offers additional functionality introducing
       <a href="mysqlnd-ms.qos-consistency.html" class="link">service levels</a>.
      </p>
     </dd>

    </dt>

    <dt id="ini.mysqlnd-ms-plugin-config-v2.trx-stickiness">
     <span class="term">
      <i><tt class="parameter">trx_stickiness</tt></i>
      <span class="type"><a href="language.types.string.html" class="type string">string</a></span>
     </span>
     <dd>

      <p class="para">
       Transaction stickiness policy. Supported policies:
       <i>disabled</i> (default), <i>master</i>.
      </p>
      <p class="para">
       The setting requires 5.4.0 or newer. If used with PHP older than 5.4.0,
       the plugin will emit a warning like
       <i>(mysqlnd_ms) trx_stickiness strategy is not supported before PHP 5.3.99</i>.
      </p>
      <p class="para">
       If no transaction stickiness policy is set or,
       if setting <i>trx_stickiness=disabled</i>,
       the plugin is not transaction aware. Thus, the plugin may load balance
       connections and switch connections in the middle of a transaction.
       The plugin is not transaction safe. SQL hints must be used
       avoid connection switches during a transaction.
      </p>
      <p class="para">
       As of PHP 5.4.0 the mysqlnd library allows the plugin to monitor
       the <i>autocommit</i> mode set by calls to the
       libraries <i>set_autocommit()</i> function.
       If setting <i>set_stickiness=master</i> and
       <i>autocommit</i> gets disabled by a PHP MySQL extension
       invoking the <i>mysqlnd</i> library internal
       function call <i>set_autocommit()</i>, the plugin is made
       aware of the begin of a transaction. Then, the plugin stops load balancing
       and directs all statements to the master server until
       <i>autocommit</i> is enabled. Thus, no SQL hints are required.
      </p>
      <p class="para">
       An example of a PHP MySQL API function calling the <i>mysqlnd</i>
       library internal function call <i>set_autocommit()</i> is
       <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span>.
      </p>
      <p class="para">
       Although setting <i>ser_stickiness=master</i>, the plugin
       cannot be made aware of <i>autocommit</i> mode changes caused
       by SQL statements such as <i>SET AUTOCOMMIT=0</i>.
      </p>
      <p class="para">
       <div class="example" id="example-1733">
        <p><b>Example #19 Using master to execute transactions</b></p>
        <div class="example-contents">
<div class="inicode"><pre class="inicode">{
    &quot;myapp&quot;: {
        &quot;master&quot;: {
            &quot;master_0&quot;: {
                &quot;host&quot;: &quot;localhost&quot;
            }
        },
        &quot;slave&quot;: {
            &quot;slave_0&quot;: {
                &quot;host&quot;: &quot;192.168.78.136&quot;,
                &quot;port&quot;: &quot;3306&quot;
            }
        },
        &quot;trx_stickiness&quot;: &quot;master&quot;
    }
}</pre>
</div>
        </div>

       </div>
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
 <div class="note">There are no user contributed notes for this page.</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqlnd-ms.configuration.html">Runtime Configuration</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqlnd-ms.plugin-ini-v1.html">Plugin configuration file (&lt;= 1.0.x)</a></div>
 <div class="up"><a href="mysqlnd-ms.setup.html">Installing/Configuring</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
