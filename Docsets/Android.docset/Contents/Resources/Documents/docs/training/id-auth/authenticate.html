<!DOCTYPE html>

































































<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico" />
<title>Authenticating to OAuth2 Services | Android Developers</title>
<link href="../../assets/android-developer-docs-devguide.css" rel="stylesheet" type="text/css" />







</head>
<body class="gc-documentation">

  <div id="header">
      <div id="headerLeft">
          <a href="../../index.html" tabindex="-1"><img
              src="../../assets/images/bg_logo.png" alt="Android Developers" /></a>
          <ul id="header-tabs" class="resources">
    
	<li id="home-link"><a href="../../offline.html">
	
		<span class="en">Home</span>
		<span style="display:none" class="de">Startseite</span>
		<span style="display:none" class="es"></span>
		<span style="display:none" class="fr"></span>
		<span style="display:none" class="it"></span>
		<span style="display:none" class="ja">ホーム</span>
		<span style="display:none" class="zh-CN">主页</span>
		<span style="display:none" class="zh-TW">首頁</span>
	
	</a></li>
	<li id="sdk-link"><a href="../../sdk/index.html">
		<span class="en">SDK</span>
	</a></li>
	<li id="guide-link"><a href="../../guide/index.html" onClick="return loadLast('guide')">
	
		<span class="en">Dev Guide</span>
		<span style="display:none" class="de">Handbuch</span>
		<span style="display:none" class="es">Guía</span>
		<span style="display:none" class="fr">Guide</span>
		<span style="display:none" class="it">Guida</span>
		<span style="display:none" class="ja">開発ガイド</span>
		<span style="display:none" class="zh-CN">开发人员指南</span>
		<span style="display:none" class="zh-TW">開發指南</span>
	
	</a></li>
	<li id="reference-link"><a href="../../reference/packages.html" onClick="return loadLast('reference')">
	
		<span class="en">Reference</span>
		<span style="display:none" class="de">Referenz</span>
		<span style="display:none" class="es">Referencia</span>
		<span style="display:none" class="fr">Référence</span>
		<span style="display:none" class="it">Riferimento</span>
		<span style="display:none" class="ja">リファレンス</span>
		<span style="display:none" class="zh-CN">参考</span>
		<span style="display:none" class="zh-TW">參考資料</span>
	
	</a></li>
	<li id="resources-link"><a href="../../resources/index.html" onClick="return loadLast('resources')">
	
		<span class="en">Resources</span>
		<span style="display:none" class="de"></span>
		<span style="display:none" class="es"></span>
		<span style="display:none" class="fr"></span>
		<span style="display:none" class="it"></span>
    		<span style="display:none" class="ja"></span>
		<span style="display:none" class="zh-CN"></span>
		<span style="display:none" class="zh-TW"></span>
	
	</a></li>
	<li id="videos-link"><a href="../../videos/index.html" onClick="return loadLast('videos')">
	
		<span class="en">Videos</span>
		<span style="display:none" class="de"></span>
		<span style="display:none" class="es"></span>
		<span style="display:none" class="fr"></span>
		<span style="display:none" class="it"></span>
		<span style="display:none" class="ja">ビデオ</span>
		<span style="display:none" class="zh-CN"></span>
		<span style="display:none" class="zh-TW"></span>
	
	</a></li>
	<li><a href="http://android-developers.blogspot.com" onClick="return requestAppendHL(this.href)">
	
		<span class="en">Blog</span>
		<span style="display:none" class="de"></span>
		<span style="display:none" class="es"></span>
		<span style="display:none" class="fr"></span>
		<span style="display:none" class="it"></span>
		<span style="display:none" class="ja">ブログ</span>
		<span style="display:none" class="zh-CN">博客</span>
		<span style="display:none" class="zh-TW">網誌</span>
	
	</a></li>


     
</ul>
     
      </div>
      <div id="headerRight">
          <div id="headerLinks">
          
          <a href="http://www.android.com">Android.com</a>
          </div>
  <div id="search" >
      <div id="searchForm">
          <form accept-charset="utf-8" class="gsc-search-box" 
                onsubmit="return submit_search()">
            <table class="gsc-search-box" cellpadding="0" cellspacing="0"><tbody>
                <tr>
                  <td class="gsc-input">
                    <input id="search_autocomplete" class="gsc-input" type="text" size="33" autocomplete="off"
                      title="search developer docs" name="q"
                      value="search developer docs"
                      onFocus="search_focus_changed(this, true)"
                      onBlur="search_focus_changed(this, false)"
                      onkeydown="return search_changed(event, true, '../../')"
                      onkeyup="return search_changed(event, false, '../../')" />
                  <div id="search_filtered_div" class="no-display">
                      <table id="search_filtered" cellspacing=0>
                      </table>
                  </div>
                  </td>
                  <td class="gsc-search-button">
                    <input type="submit" value="Search" title="search" id="search-button" class="gsc-search-button" />
                  </td>
                  <td class="gsc-clear-button">
                    <div title="clear results" class="gsc-clear-button">&nbsp;</div>
                  </td>
                </tr></tbody>
              </table>
          </form>
      </div><!-- searchForm -->
  </div><!-- search -->
      </div><!-- headerRight -->
      
  </div><!-- header -->

  <div class="g-section g-tpl-200" id="body-content">
    <div class="g-unit g-first" id="side-nav">
      <div id="devdoc-nav"><ul>
  <li>
    <h2><span class="en">Technical Resources</span>
    </h2>
    <ul>
      <li class="toggle-list">
        <div><a href="../../resources/browser.html?tag=sample">
            <span class="en">Sample Code</span>
            <span class="de" style="display:none">Beispielcode</span>
            <span class="es" style="display:none">Código de ejemplo</span>
            <span class="fr" style="display:none">Exemple de code</span>
            <span class="it" style="display:none">Codice di esempio</span>
            <span class="ja" style="display:none">サンプル コード</span>
            <span class="zh-CN" style="display:none"></span>
            <span class="zh-TW" style="display:none"></span>
          </a></div>
        <ul id="devdoc-nav-sample-list">
          <li><a href="../../resources/samples/get.html">
                <span class="en">Getting the Samples</span>
              </a></li>
        </ul>
      </li>
      <li class="toggle-list">
        <div><a href="../../resources/browser.html?tag=article">
               <span class="en">Articles</span>
             </a></div>
        <ul id="devdoc-nav-article-list">
        </ul>
      </li>
      <li class="toggle-list">
        <div><a href="../../resources/browser.html?tag=tutorial">
               <span class="en">Tutorials</span>
               <span class="de" style="display:none">Lernprogramme</span>
               <span class="es" style="display:none">Tutoriales</span>
               <span class="fr" style="display:none">Didacticiels</span>
               <span class="it" style="display:none">Esercitazioni</span>
               <span class="ja" style="display:none">チュートリアル</span>
               <span class="zh-CN" style="display:none"></span>
               <span class="zh-TW" style="display:none"></span>
             </a></div>
        <ul id="devdoc-nav-tutorial-list">
        </ul>
      </li>
      <li class="toggle-list">
        <div><a href="../../resources/topics.html">
               <span class="en">Topics</span>
             </a></div>
        <ul id="devdoc-nav-topic-list">
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <h2><span class="en">Community</span>
               <span style="display:none" class="de"></span>
               <span style="display:none" class="es">Comunidad</span>
               <span style="display:none" class="fr">Communauté</span>
               <span style="display:none" class="it"></span>
               <span style="display:none" class="ja">コミュニティ</span>
               <span style="display:none" class="zh-CN">社区</span>
               <span style="display:none" class="zh-TW">社群</span>
    </h2>
    <ul>
      <li><a href="../../resources/community-groups.html">
            <span class="en">Developer Forums</span>
          </a></li>
      <li><a href="../../resources/community-more.html">
            <span class="en">IRC, Twitter</span>
          </a></li>
    </ul>
  </li>


  <li>
   <h2><span class="en">More</span></h2>
    <ul>
      <li><a href="../../resources/faq/commontasks.html">
            <span class="en">Common Tasks </span>
          </a></li>
      <li><a href="../../resources/faq/troubleshooting.html">
            <span class="en">Troubleshooting Tips</span>
          </a></li>
      <li class="toggle-list">
        <div><a href="../../resources/faq/index.html">
               <span class="en">FAQs</span>
             </a></div>
        <ul>
        <li><a href="../../resources/faq/framework.html">
                <span class="en">App Framework FAQ</span>
                </a></li>
        <li><a href="../../resources/faq/licensingandoss.html">
                <span class="en">Licensing FAQ</span>
                </a></li>
        <li><a href="../../resources/faq/security.html">
                <span class="en">Security FAQ</span>
                </a></li>
        </ul>
     </li>
    </ul>
  </li>
</ul>



      </div>
    </div> <!-- end side-nav -->
    




<div class="g-unit" id="doc-content"><a name="top"></a>

<div id="jd-header" class="guide-header">
  <span class="crumb">
    
      <a href="index.html">Identifying and Authenticating Users</a>:
    
  </span>
<h1>Authenticating to OAuth2 Services</h1>
</div>

  
  <div id="jd-content">
 
    
    <div class="training-nav-top">

      
        

        <div class="training-nav-button-next">
          <a href="custom_auth.html">
            Next lesson
            <span style="font-size:1.2em">&rsaquo;</span>
            <span class="training-nav-button-title">Creating a Custom Account Type</span>
          </a>
        </div>
        

      

      
      <div class="training-nav-button-previous">
        <a href="identify.html">
          <span style="font-size:1.2em">&lsaquo;</span>
          Previous lesson
          <span class="training-nav-button-title">Identifying Your User</span>
        </a>
      </div>

      

    </div><!-- end training-nav-top -->
    


    <div class="jd-descr">
    <!-- This is the training bar -->
<div id="tb-wrapper">
  <div id="tb">
<h2>This lesson teaches you to</h2>
<ol>
  <li><a href="#Gather">Gather Information</a></li>
  <li><a href="#RequestToken">Request an Auth Token</a></li>
  <li><a href="#RequestAgain">Request an Auth Token... Again</a></li>
  <li><a href="#ConnectToService">Connect to the Online Service</a></li>
</ol>
  </div>
</div>

<p>In order to securely access an online service, users need to authenticate to
the service&mdash;they need to provide proof of their identity. For an
application that accesses a third-party service, the security problem is even
more complicated. Not only does the user need to be authenticated to access the
service, but the application also needs to be authorized to act on the user's
behalf. </p>

<p>The industry standard way to deal with authentication to third-party services
is the OAuth2 protocol. OAuth2 provides a single value, called an <strong>auth
token</strong>, that represents both the user's identity and the application's
authorization to act on the user's behalf. This lesson demonstrates connecting
to a Google server that supports OAuth2. Although Google services are used as an
example, the techniques demonstrated will work on any service that correctly
supports the OAuth2 protocol.</p>

<p>Using OAuth2 is good for:</p>
<ul>
<li>Getting permission from the user to access an online service using his or
her account.</li>
<li>Authenticating to an online service on behalf of the user.</li>
<li>Handling authentication errors.</li>
</ul>


<h2 id="Gather">Gather Information</h2>

<p>To begin using OAuth2, you need to know a few things about the API you're trying
to access:</p>

<ul>
<li>The url of the service you want to access.</li>
<li>The <strong>auth scope</strong>, which is a string that defines the specific
type of access your app is asking for. For instance, the auth scope for
read-only access to Google Tasks is <code>View your tasks</code>, while the auth
scope for read-write access to Google Tasks is <code>Manage Your
Tasks</code>.</li>
<li>A <strong>client id</strong> and <strong>client secret</strong>, which are
strings that identify your app to the service. You need to obtain these strings
directly from the service owner. Google has a self-service system for obtaining
client ids and secrets. The article <a
href="http://code.google.com/apis/tasks/articles/oauth-and-tasks-on-android.
html">Getting Started with the Tasks API and OAuth 2.0 on Android</a> explains
how to use this system to obtain these values for use with the Google Tasks
API.</li>
</ul>


<h2 id="RequestToken">Request an Auth Token</h2>

<p>Now you're ready to request an auth token. Auth tokens usually expire after
some period of time, so you'll have to renew them.</p>

 <!-- TODO: I think a flowchart would be useful here, or perhaps a link to an as-yet-to-be-created
flowchart that lives in the docs. -->

<p>To get an auth token you first need to request the
<code><a href="../../reference/android/Manifest.permission.html#ACCOUNT_MANAGER">ACCOUNT_MANAGER</a></code>
to yourmanifest file. To actually do anything useful with the
token, you'll also need to add the <code><a href="../../reference/android/Manifest.permission.html#INTERNET">INTERNET</a></code>
permission.</p>

<code>
&lt;manifest ... >
    &lt;uses-permission android:name="android.permission.ACCOUNT_MANAGER" /&gt;
    &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
    ...
&lt;/manifest>
</code>


<p>Once your app has these permissions set, you can call <code><a href="../../reference/android/accounts/AccountManager.html#getAuthToken(android.accounts.Account, java.lang.String, android.os.Bundle, android.app.Activity, android.accounts.AccountManagerCallback<android.os.Bundle>, android.os.Handler)">AccountManager.getAuthToken()</a></code> to get the
token.</p>

<p>Watch out! Calling methods on <code><a href="../../reference/android/accounts/AccountManager.html">AccountManager</a></code> can be tricky! Since
account operations may involve network communication, most of the <code><a href="../../reference/android/accounts/AccountManager.html">AccountManager</a></code> methods are asynchronous. This means that instead of doing all of
your auth work in one function, you need to implement it as a series of callbacks. For example:</p>

<pre>
AccountManager am = AccountManager.get(this);
Bundle options = new Bundle();

am.getAuthToken(
    myAccount_,                     // Account retrieved using getAccountsByType()
    "Manage your tasks",            // Auth scope
    options,                        // Authenticator-specific options
    this,                           // Your activity
    new OnTokenAcquired(),          // Callback called when a token is successfully acquired
    new Handler(new OnError()));    // Callback called if an error occurs
</pre>

<p>In this example, <code>OnTokenAcquired</code> is a class that extends
<code><a href="../../reference/android/accounts/AccountManagerCallback.html">AccountManagerCallback</a></code>. <code><a href="../../reference/android/accounts/AccountManager.html">AccountManager</a></code> calls
<code><a href="../../reference/android/accounts/AccountManagerCallback.html#run(android.accounts.AccountManagerFuture<V>)">run()</a></code> on <code>OnTokenAcquired</code> with an
<code><a href="../../reference/android/accounts/AccountManagerFuture.html">AccountManagerFuture</a></code> that contains a <code><a href="../../reference/android/os/Bundle.html">Bundle</a></code>. If
the call succeeded, the token is inside
the <code><a href="../../reference/android/os/Bundle.html">Bundle</a></code>.</p>

<p>Here's how you can get the token from the <code><a href="../../reference/android/os/Bundle.html">Bundle</a></code>:</p>

<pre>
private class OnTokenAcquired implements AccountManagerCallback&lt;Bundle&gt; {
    &#64;Override
    public void run(AccountManagerFuture&lt;Bundle&gt; result) {
        // Get the result of the operation from the AccountManagerFuture.
        Bundle bundle = result.getResult();
    
        // The token is a named value in the bundle. The name of the value
        // is stored in the constant AccountManager.KEY_AUTHTOKEN.
        token = bundle.getString(AccountManager.KEY_AUTHTOKEN);
        ...
    }
}
</pre>

<p>If all goes well, the <code><a href="../../reference/android/os/Bundle.html">Bundle</a></code> contains a valid token in the <code><a href="../../reference/android/accounts/AccountManager.html#KEY_AUTHTOKEN">KEY_AUTHTOKEN</a></code> key and you're off to the races. Things don't
always go that smoothly, though...</p>


<h2 id="RequestAgain">Request an Auth Token... Again</h2>

<p>Your first request for an auth token might fail for several reasons:</p>

<ul>
<li>An error in the device or network caused <code><a href="../../reference/android/accounts/AccountManager.html">AccountManager</a></code> to fail.</li>
<li>The user decided not to grant your app access to the account.</li>
<li>The stored account credentials aren't sufficient to gain access to the account.</li>
<li>The cached auth token has expired.</li>
</ul>

<p>Applications can handle the first two cases trivially, usually by simply
showing an error message to the user. If the network is down or the user decided
not to grant access, there's not much that your application can do about it. The
last two cases are a little more complicated, because well-behaved applications
are expected to handle these failures automatically.</p>

<p>The third failure case, having insufficient credentials, is communicated via the <code><a href="../../reference/android/os/Bundle.html">Bundle</a></code> you receive in your <code><a href="../../reference/android/accounts/AccountManagerCallback.html">AccountManagerCallback</a></code>
(<code>OnTokenAcquired</code> from the previous example). If the <code><a href="../../reference/android/os/Bundle.html">Bundle</a></code> includes
an <code><a href="../../reference/android/content/Intent.html">Intent</a></code> in the <code><a href="../../reference/android/accounts/AccountManager.html#KEY_INTENT">KEY_INTENT</a></code> key,
then the authenticator is telling you that it needs to interact directly with the user before it can
give you a valid token.</p>

<p>There may be many reasons for the authenticator to return an <code><a href="../../reference/android/content/Intent.html">Intent</a></code>. It
may be the first time the user has logged in to this account. Perhaps the user's account has expired
and they need to log in again, or perhaps their stored credentials are incorrect. Maybe the account
requires two-factor authentication or it needs to activate the camera to do a retina scan. It
doesn't really matter what the reason is. If you want a valid token, you're going to have to fire
off the <code><a href="../../reference/android/content/Intent.html">Intent</a></code> to get it.</p>

<pre>
private class OnTokenAcquired implements AccountManagerCallback&lt;Bundle&gt; {
    &#64;Override
    public void run(AccountManagerFuture&lt;Bundle&gt; result) {
        ...
        Intent launch = (Intent) result.get(AccountManager.KEY_INTENT);
        if (launch != null) {
            startActivityForResult(launch, 0);
            return;
        }
    }
}
</pre>

<p>Note that the example uses <code><a href="../../reference/android/app/Activity.html#startActivityForResult(android.content.Intent, int)">startActivityForResult()</a></code>, so that you can capture
the result of the <code><a href="../../reference/android/content/Intent.html">Intent</a></code> by implementing <code><a href="../../reference/android/app/Activity.html#onActivityResult(int, int, android.content.Intent)">onActivityResult()</a></code> in
your own activity. This is important! If you don't capture the result from the
authenticator's response <code><a href="../../reference/android/content/Intent.html">Intent</a></code>,
it's impossible to tell whether the user has successfully authenticated or not.
If the result is <code><a href="../../reference/android/app/Activity.html#RESULT_OK">RESULT_OK</a></code>, then the
authenticator has updated the stored credentials so that they are sufficient for
the level of access you requested, and you should call <code><a href="../../reference/android/accounts/AccountManager.html#getAuthToken(android.accounts.Account, java.lang.String, android.os.Bundle, android.app.Activity, android.accounts.AccountManagerCallback<android.os.Bundle>, android.os.Handler)">AccountManager.getAuthToken()</a></code> again to request the new
auth token.</p>

<p>The last case, where the token has expired, it is not actually an <code><a href="../../reference/android/accounts/AccountManager.html">AccountManager</a></code> failure. The only way to discover whether a token is expired or not
is to contact the server, and it would be wasteful and expensive for <code><a href="../../reference/android/accounts/AccountManager.html">AccountManager</a></code> to continually go online to check the state of all of its tokens.
So this is a failure that can only be detected when an application like yours tries to use the auth
token to access an online service.</p>


<h2 id="ConnectToService">Connect to the Online Service</h2>

<p>The example below shows how to connect to a Google server. Since Google uses the
industry standard OAuth2 protocol to
authenticate requests, the techniques discussed here are broadly
applicable. Keep in mind, though, that every
server is different. You may find yourself needing to make minor adjustments to
these instructions to account for your specific
situation.</p>

<p>The Google APIs require you to supply four values with each request: the API
key, the client ID, the client secret,
and the auth key. The first three come from the Google API Console
website. The last is the string value you
obtained by calling <code><a href="../../reference/android/accounts/AccountManager.html#getAuthToken(android.accounts.Account, java.lang.String, android.os.Bundle, android.app.Activity, android.accounts.AccountManagerCallback<android.os.Bundle>, android.os.Handler)">AccountManager.getAuthToken()</a></code>. You pass these to the
Google Server as part of
an HTTP request.</p>

<pre>
URL url = new URL("https://www.googleapis.com/tasks/v1/users/&#64;me/lists?key=" + <em>your_api_key</em>);
URLConnection conn = (HttpURLConnection) url.openConnection();
conn.addRequestProperty("client_id", <em>your client id</em>);
conn.addRequestProperty("client_secret", <em>your client secret</em>);
conn.setRequestProperty("Authorization", "OAuth " + token);
</pre>

<p>If the request returns
an HTTP error code of 401, then your token has been denied. As mentioned in the
last section, the most common reason for
this is that the token has expired. The fix is
simple: call
<code><a href="../../reference/android/accounts/AccountManager.html#invalidateAuthToken(java.lang.String, java.lang.String)">AccountManager.invalidateAuthToken()</a></code> and
repeat the token acquisition dance one
more time.</p>

<p>Because expired tokens are such a common occurrence, and fixing them  is so easy, many
applications just assume the token has expired before even asking for it. If renewing a token is a
cheap operation for your server, you might prefer to call <code><a href="../../reference/android/accounts/AccountManager.html#invalidateAuthToken(java.lang.String, java.lang.String)">AccountManager.invalidateAuthToken()</a></code> before the
first call to <code><a href="../../reference/android/accounts/AccountManager.html#getAuthToken(android.accounts.Account, java.lang.String, android.os.Bundle, android.app.Activity, android.accounts.AccountManagerCallback<android.os.Bundle>, android.os.Handler)">AccountManager.getAuthToken()</a></code>,
and spare yourself the need to request an auth token twice.</p>

    </div>

    
    <div class="training-nav-bottom">
      
      <div class="training-nav-button-next">
        <a href="custom_auth.html">
          Next lesson
          <span style="font-size:1.2em">&rsaquo;</span>
          <br/><span class="training-nav-button-title">Creating a Custom Account Type</span>
        </a>
      </div>
      

      
      <div class="training-nav-button-previous">
        <a href="identify.html">
          <span style="font-size:1.2em">&lsaquo;</span>
          Previous lesson
          <br/><span class="training-nav-button-title">Identifying Your User</span>
        </a>
      </div>
      
    </div> <!-- end training-nav -->
    
    
    <a href="#top" style="float:right">&uarr; Go to top</a>
    
      <p><a href="index.html">&larr; Back to Identifying and Authenticating Users</a></p>
    

  </div> <!-- end jd-content -->

<div id="footer">


  <div id="copyright">
    
  Except as noted, this content is 
  licensed under <a href="http://creativecommons.org/licenses/by/2.5/">
  Creative Commons Attribution 2.5</a>. For details and 
  restrictions, see the <a href="../../license.html">Content 
  License</a>.
  </div>

  <div id="footerlinks">
    
  <p>
    <a href="http://www.android.com/terms.html">Site Terms of Service</a> -
    <a href="http://www.android.com/privacy.html">Privacy Policy</a> -
    <a href="http://www.android.com/branding.html">Brand Guidelines</a>
  </p>
  </div>

</div> <!-- end footer -->

</div><!-- end doc-content -->

</div> <!-- end body-content --> 




</body>
</html>



